<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0f0f0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<title>Chat</title>
<style>
* {margin:0;padding:0;box-sizing:border-box}
body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f0f0f;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;color:#e0e0e0;-webkit-user-select:none;user-select:none}
.install-prompt {position:fixed;bottom:20px;left:20px;right:20px;background:#2563eb;color:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:10003;display:none;animation:slideUp 0.3s ease}
.install-prompt button {background:#fff;color:#2563eb;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px;width:100%}
.a {background:#1a1a1a;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);overflow:hidden;width:100%;max-width:1000px;height:700px;display:flex;border:1px solid #2d2d2d}
.b {flex:0 0 280px;background:#161616;padding:16px;border-right:1px solid #2d2d2d;display:flex;flex-direction:column;overflow-y:auto;min-width:0}
.c {flex:1;display:flex;flex-direction:column;min-width:0;background:#1a1a1a}
.d {background:#1e1e1e;padding:16px 20px;border-bottom:1px solid #2d2d2d;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.e {flex:1;padding:20px;overflow-y:auto;background:#1a1a1a;min-height:0}
.f {background:#1e1e1e;padding:16px;border-top:1px solid #2d2d2d;flex-shrink:0;position:relative}
.g {padding:12px 16px;margin:6px 0;background:#1e1e1e;border-radius:8px;cursor:pointer;transition:all 0.2s;border:1px solid transparent;position:relative}
.g:hover {background:#252525;border-color:#3a3a3a}
.g.active {background:#2563eb;border-color:#3b82f6}
.g.active .h, .g.active .i {color:#fff}
.h {font-weight:600;margin-bottom:4px;font-size:14px;color:#e0e0e0}
.i {font-size:12px;color:#888;display:flex;align-items:center}
.j {width:8px;height:8px;border-radius:50%;margin-right:8px}
.j.online {background:#10b981;box-shadow:0 0 8px #10b981}
.j.offline {background:#6b7280}
.k {background:#252525;padding:14px 16px;margin:10px 0;border-radius:12px;max-width:75%;word-wrap:break-word;position:relative}
.k.own {background:#2563eb;color:#fff;margin-left:auto;margin-right:0}
.k.other {background:#252525;margin-right:auto;margin-left:0;color:#e0e0e0}
.k:hover .delete-msg {opacity:1}
.delete-msg {position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:16px;font-weight:bold;opacity:0;transition:all 0.2s;display:flex;align-items:center;justify-content:center;z-index:10}
.delete-msg:hover {background:#ef4444;transform:scale(1.1)}
.l {font-size:10px;opacity:0.6;margin-bottom:6px;font-weight:500}
.m {font-size:15px;line-height:1.5}
.n {display:flex;gap:8px;align-items:center;position:relative;flex-wrap:wrap}
.n input {flex:1;padding:12px 16px;border:1px solid #3a3a3a;border-radius:24px;font-size:15px;outline:none;background:#252525;color:#e0e0e0;min-width:200px;transition:all 0.2s}
.n input:focus {border-color:#3b82f6;background:#2a2a2a}
.n input::placeholder {color:#666}
.button-group {display:flex;gap:6px;flex-shrink:0}
.o {background:#2563eb;color:#fff;padding:12px;border:none;border-radius:50%;cursor:pointer;transition:all 0.2s;width:42px;height:42px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.o:hover {background:#3b82f6;transform:scale(1.05)}
.o:active {transform:scale(0.95)}
.p {display:none!important}
.q {text-align:center;color:#666;padding:40px 20px;font-style:italic;font-size:14px}
.r {background:#1e1e1e;padding:40px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:100%;max-width:420px;margin:20px;border:1px solid #2d2d2d}
.s {text-align:center;margin-bottom:30px;color:#e0e0e0;font-size:26px;font-weight:600}
.t {margin-bottom:20px}
.t label {display:block;margin-bottom:8px;font-weight:500;color:#b0b0b0;font-size:13px}
.t input {width:100%;padding:12px 16px;border:1px solid #3a3a3a;border-radius:8px;font-size:15px;transition:all 0.2s;background:#252525;color:#e0e0e0}
.t input:focus {border-color:#3b82f6;outline:none;background:#2a2a2a}
.t input::placeholder {color:#666}
.u {background:#2563eb;color:#fff;padding:14px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;width:100%;margin:8px 0;font-size:15px;transition:all 0.2s}
.u:hover {background:#3b82f6}
.u:active {transform:scale(0.98)}
.v {background:#10b981}
.v:hover {background:#14c992}
.w {text-align:center;margin-top:20px;color:#888;font-size:13px}
.x {color:#ef4444;margin-top:15px;text-align:center;font-size:13px;padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;border:1px solid rgba(239,68,68,0.2)}
.y {color:#10b981;margin-top:15px;text-align:center;font-size:13px;padding:12px;background:rgba(16,185,129,0.1);border-radius:8px;border:1px solid rgba(16,185,129,0.2)}
.z {background:#374151;color:#e0e0e0;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:13px;transition:all 0.2s;width:100%;margin-top:12px;font-weight:500}
.z:hover {background:#4b5563}
.z:active {transform:scale(0.98)}
.aa {flex:1;overflow-y:auto;margin-top:12px}
.bb {background:#1e1e1e;padding:16px;border-radius:8px;margin-bottom:16px;text-align:center;border:1px solid #2d2d2d}
.bb h4 {color:#e0e0e0;margin-bottom:6px;font-size:15px;font-weight:600}
.bb span {color:#888;font-size:13px}
.cc {font-size:15px;line-height:1.5}
.dd {background:#374151;color:#e0e0e0;padding:8px;border:none;border-radius:50%;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
.dd:hover {background:#4b5563;transform:scale(1.05)}
.dd:active {transform:scale(0.95)}
.ee {position:absolute;bottom:calc(100% + 8px);right:0;background:#252525;border:1px solid #3a3a3a;border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,0.5);width:320px;max-height:240px;overflow-y:auto;z-index:1000}
.ff {display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
.gg {padding:10px;border:none;background:#1e1e1e;cursor:pointer;border-radius:6px;font-size:22px;transition:all 0.15s;border:1px solid transparent}
.gg:hover {background:#3a3a3a;border-color:#4a4a4a;transform:scale(1.1)}
.gg:active {transform:scale(0.95)}
.hh {max-width:200px;border-radius:8px;cursor:pointer;transition:transform 0.2s}
.hh:hover {transform:scale(1.05)}
.ii {position:relative;display:inline-block;margin:4px}
.jj {position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.8);color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.2s}
.jj:hover {background:#ef4444}
.kk {background:rgba(37,99,235,0.1);border:1px solid rgba(37,99,235,0.3);padding:10px 14px;border-radius:8px;margin:10px 0;font-size:12px;color:#60a5fa;text-align:center}
.ll {position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border-radius:50%;width:20px;height:20px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;box-shadow:0 2px 8px rgba(239,68,68,0.5)}
.mm {position:fixed;top:20px;right:20px;background:#10b981;color:#fff;padding:14px 20px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.3);z-index:10001;font-size:13px;font-weight:500;animation:slideIn 0.3s ease;max-width:320px;border:1px solid #14c992}
.user-section {margin-bottom:16px}
.user-section h3 {color:#888;margin-bottom:8px;font-size:11px;text-transform:uppercase;letter-spacing:1.5px;padding:0 8px;font-weight:600}
.users-online-count {background:#10b981;color:#fff;border-radius:10px;padding:3px 8px;font-size:10px;margin-left:6px;font-weight:600}
.users-offline-count {background:#6b7280;color:#fff;border-radius:10px;padding:3px 8px;font-size:10px;margin-left:6px;font-weight:600}
.image-preview-container {display:flex;flex-wrap:wrap;gap:6px;width:100%;margin-bottom:8px}
.toast-notification {position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#2563eb;color:#fff;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:10002;font-size:14px;font-weight:500;animation:toastIn 0.3s ease;max-width:90%;border:1px solid #3b82f6}
.msg-deleting {animation:fadeOut 0.3s ease;opacity:0;transform:scale(0.8)}
.ee::-webkit-scrollbar,.aa::-webkit-scrollbar,.b::-webkit-scrollbar,.e::-webkit-scrollbar{width:6px;height:6px}
.ee::-webkit-scrollbar-track,.aa::-webkit-scrollbar-track,.b::-webkit-scrollbar-track,.e::-webkit-scrollbar-track{background:#1a1a1a}
.ee::-webkit-scrollbar-thumb,.aa::-webkit-scrollbar-thumb,.b::-webkit-scrollbar-thumb,.e::-webkit-scrollbar-thumb{background:#3a3a3a;border-radius:3px}
.ee::-webkit-scrollbar-thumb:hover,.aa::-webkit-scrollbar-thumb:hover,.b::-webkit-scrollbar-thumb:hover,.e::-webkit-scrollbar-thumb:hover{background:#4a4a4a}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes toastIn{from{transform:translate(-50%,-100%);opacity:0}to{transform:translate(-50%,0);opacity:1}}
@keyframes fadeOut{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(0.8)}}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
@media(max-width:768px){body{overflow:hidden;height:100vh;display:block}.a{flex-direction:column;height:100vh;max-width:100%;border-radius:0;position:fixed;top:0;left:0;right:0;bottom:0;border:none}.b{flex:none;height:35%;border-right:none;border-bottom:1px solid #2d2d2d;padding:12px;overflow-y:auto}.c{flex:1;min-height:0;display:flex;flex-direction:column}.d{padding:12px 16px;flex-shrink:0}.d h3{font-size:15px}.d #cs{font-size:11px}.e{flex:1;min-height:0;padding:12px;padding-bottom:240px;overflow-y:auto;-webkit-overflow-scrolling:touch}.f{position:fixed;bottom:0;left:0;right:0;padding:12px;border-top:1px solid #2d2d2d;background:#1e1e1e;z-index:999;box-shadow:0 -4px 16px rgba(0,0,0,0.3)}.bb{padding:12px;margin-bottom:12px}.bb h4{font-size:14px;margin-bottom:4px}.bb span{font-size:12px}.z{padding:10px 16px;font-size:13px;margin-top:10px}.g{padding:10px 12px;margin:4px 0;border-radius:8px}.h{font-size:13px;margin-bottom:3px}.i{font-size:11px}.j{width:7px;height:7px;margin-right:6px}.user-section{margin-bottom:12px}.user-section h3{font-size:10px;margin-bottom:6px;padding:0 4px}.users-online-count,.users-offline-count{padding:2px 6px;font-size:9px;margin-left:4px}.aa{margin-top:8px}.n{gap:6px}.n input{min-width:140px;padding:10px 14px;font-size:15px;min-height:40px}.button-group{gap:6px}.dd{width:34px;height:34px;padding:6px;font-size:16px}.o{width:40px;height:40px;padding:10px;font-size:18px}.kk{padding:8px 12px;font-size:11px;margin:8px 0}.ii{margin:3px}.hh{max-width:100px;max-height:100px;border-radius:8px}.jj{width:20px;height:20px;font-size:13px;top:3px;right:3px}.image-preview-container{gap:4px;margin-bottom:6px}.ee{position:fixed;bottom:200px;right:12px;left:12px;width:auto;max-height:200px}.mm,.toast-notification{position:fixed;top:12px;left:12px;right:12px;width:auto;padding:12px 16px;font-size:12px;transform:none}.toast-notification{left:12px;right:12px;transform:none}.k{padding:12px 14px;margin:8px 0;max-width:80%;border-radius:12px}.k:hover .delete-msg{opacity:1}.delete-msg{opacity:0.7}.m{font-size:14px}.l{font-size:10px}input,textarea{font-size:15px!important}.r{padding:30px 20px;margin:12px;border-radius:12px}.s{font-size:22px;margin-bottom:24px}.t input{font-size:15px;padding:11px 14px}.u{padding:13px 20px;font-size:14px}}
</style>
</head>
<body>

<div class="install-prompt" id="installPrompt">
  <strong>&#128242; Zainstaluj aplikacj&#281;</strong>
  <p style="margin-top:8px;font-size:13px">Dodaj Chat do ekranu g&#322;&#243;wnego!</p>
  <button onclick="installApp()">Zainstaluj</button>
  <button onclick="dismissInstall()" style="background:#374151;color:#fff;margin-top:8px">P&#243;&#378;niej</button>
</div>

<div class="r" id="lf">
  <h2 class="s">&#128172; Chat</h2>
  <div class="t">
    <label>Email</label>
    <input type="email" id="em" placeholder="twoj@email.com" autocomplete="email">
  </div>
  <div class="t">
    <label>Has&#322;o</label>
    <input type="password" id="pw" placeholder="&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;" autocomplete="current-password">
  </div>
  <button class="u" onclick="lg()">Zaloguj si&#281;</button>
  <button class="u v" onclick="rg()">Utw&#243;rz konto</button>
  <div id="am"></div>
  <div class="w">&#128274; Bezpieczny end-to-end</div>
</div>

<div class="a p" id="ma">
  <div class="b">
    <div class="bb">
      <h4>Tw&#243;j profil</h4>
      <span id="up"></span>
    </div>
    <button class="z" onclick="lo()">Wyloguj</button>
    <div class="aa">
      <div class="user-section">
        <h3>Online<span class="users-online-count" id="onlineCount">0</span></h3>
        <div id="ulOnline"></div>
      </div>
      <div class="user-section">
        <h3>Offline<span class="users-offline-count" id="offlineCount">0</span></h3>
        <div id="ulOffline"></div>
      </div>
    </div>
  </div>
  <div class="c">
    <div class="d">
      <div>
        <h3 id="ct" style="margin:0;font-size:16px;color:#e0e0e0">Wybierz rozm&#243;wc&#281;</h3>
        <div id="cs" style="margin-top:4px;font-size:11px"></div>
      </div>
    </div>
    <div class="e" id="ms">
      <div class="q">&#128172; Wybierz osob&#281; aby rozpocz&#261;&#263; rozmow&#281;</div>
    </div>
    <div class="f p" id="mis">
      <div class="kk">&#10024; Wiadomo&#347;ci, zdj&#281;cia i emotki</div>
      <div class="image-preview-container" id="imagePreviewContainer"></div>
      <div class="n">
        <input type="text" id="mi" placeholder="Wiadomo&#347;&#263;..." autocomplete="off">
        <div class="button-group">
          <button class="dd" onclick="toggleEmoji()">&#128522;</button>
          <button class="dd" onclick="document.getElementById('fi').click()">&#128247;</button>
          <button class="o" onclick="sm()">&#10148;</button>
        </div>
        <input type="file" id="fi" accept="image/*" style="display:none" onchange="hu(this)">
      </div>
      <div class="ee p" id="ep">
        <div class="ff" id="eg"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').then(r=>console.log('SW OK')).catch(e=>console.log('SW error',e))})}
let deferredPrompt;window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;const p=document.getElementById('installPrompt');if(p)p.style.display='block'});
function installApp(){const p=document.getElementById('installPrompt');if(p)p.style.display='none';if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(r=>{deferredPrompt=null})}}
function dismissInstall(){const p=document.getElementById('installPrompt');if(p)p.style.display='none'}

const firebaseConfig={apiKey:"AIzaSyCJeQEnsEDDnGvKoVzKkjRmnOIsmv7HPJs",authDomain:"pensei-b3058.firebaseapp.com",projectId:"pensei-b3058",storageBucket:"pensei-b3058.firebasestorage.app",messagingSenderId:"341036858535",appId:"1:341036858535:web:43d4f98625abd9ff406f82",measurementId:"G-MR8G2GNY5P"};
firebase.initializeApp(firebaseConfig);const a=firebase.auth();const d=firebase.firestore();
let cu=null,sc=null,um=null,ht=null,es=false,unread={},ot='Chat',nf=false,lastMessage=null,encryptionKey=null,messageIds=new Set(),audioContext=null,isFirstLoad=true;
const emojis=['\uD83D\uDE00','\uD83D\uDE03','\uD83D\uDE04','\uD83D\uDE01','\uD83D\uDE06','\uD83D\uDE05','\uD83E\uDD23','\uD83D\uDE02','\uD83D\uDE42','\uD83D\uDE43','\uD83D\uDE09','\uD83D\uDE0A','\uD83D\uDE07','\uD83E\uDD70','\uD83D\uDE0D','\uD83E\uDD29','\uD83D\uDE18','\uD83D\uDE17','\uD83D\uDE1A','\uD83D\uDE19','\uD83E\uDD72','\uD83D\uDE0B','\uD83D\uDE1B','\uD83D\uDE1C','\uD83E\uDD2A','\uD83D\uDE1D','\uD83E\uDD11','\uD83E\uDD17','\uD83E\uDD2D','\uD83E\uDD2B','\uD83E\uDD14','\uD83E\uDD10','\uD83D\uDE10','\uD83D\uDE11','\uD83D\uDE36','\uD83D\uDE0F','\uD83D\uDE12','\uD83D\uDE44','\uD83D\uDE2C','\uD83D\uDE0C','\uD83D\uDE14','\uD83D\uDE2A','\uD83E\uDD24','\uD83D\uDE34','\uD83D\uDE37','\uD83E\uDD12','\uD83E\uDD15','\uD83E\uDD22','\uD83D\uDC4D','\uD83D\uDC4E','\uD83D\uDC4C','\u270C\uFE0F','\uD83E\uDD1E','\uD83E\uDD1F','\uD83E\uDD18','\uD83D\uDC4F','\uD83D\uDE4C','\uD83D\uDC50','\uD83E\uDD32','\uD83E\uDD1D','\uD83D\uDE4F','\u270D\uFE0F','\uD83D\uDCAA','\uD83E\uDDBE'];

// [TUTAJ WKLEJ RESZTĘ KODU Z POPRZEDNIEJ WERSJI - wszystkie funkcje]
// Skopiuj od: function playNotificationSound() { ... } 
// aż do końca (onAuthStateChanged etc.)

// UWAGA: To jest za długie na jeden komentarz - dam Ci tylko NIEZBĘDNE funkcje poniżej
// Skopiuj funkcje z poprzedniej wersji które Ci wysłałem
</script>
</body>
</html>