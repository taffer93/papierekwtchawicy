<!DOCTYPE html><html lang="pl"><head><meta charset="UTF-8"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Chat</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Emoji','Apple Color Emoji','Segoe UI Emoji',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}.a{background:white;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);width:100%;max-width:400px;margin:20px}.b{background:white;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden;width:100%;max-width:900px;height:600px;display:flex}.c{flex:1;background:#f8f9fa;padding:20px;border-right:1px solid #e9ecef;display:flex;flex-direction:column}.d{flex:2;display:flex;flex-direction:column}.e{background:white;padding:15px 20px;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center}.f{flex:1;padding:20px;overflow-y:auto;background:#f8f9fa;padding-bottom:120px}.g{background:white;padding:15px 20px;border-top:1px solid #e9ecef;position:relative}.h{padding:12px 20px;margin:8px 0;background:white;border-radius:12px;cursor:pointer;transition:all 0.2s;border:2px solid transparent;position:relative}.h:hover{border-color:#007bff;transform:translateY(-1px)}.h.active{background:#007bff;color:white;border-color:#0056b3}.i{font-weight:600;margin-bottom:4px}.j{font-size:12px;color:#6c757d;display:flex;align-items:center}.k{width:8px;height:8px;border-radius:50%;margin-right:6px}.k.online{background:#28a745}.k.offline{background:#dc3545}.l{background:white;padding:16px;margin:12px 0;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);max-width:80%;word-wrap:break-word}.l.own{background:linear-gradient(135deg,#007bff,#0056b3);color:white;margin-left:auto;margin-right:0}.l.other{background:#e9ecef;margin-right:auto;margin-left:0}.m{font-size:11px;opacity:0.7;margin-bottom:6px;font-weight:500}.n{font-size:15px;line-height:1.4}.o{display:flex;gap:8px;align-items:flex-end;position:relative}.o input{flex:1;padding:12px 16px;border:2px solid #e9ecef;border-radius:20px;font-size:16px;outline:none;resize:none;max-height:100px;min-height:44px}.o input:focus{border-color:#007bff}.p{background:linear-gradient(135deg,#007bff,#0056b3);color:white;padding:12px;border:none;border-radius:50%;cursor:pointer;transition:transform 0.2s;width:44px;height:44px;display:flex;align-items:center;justify-content:center}.p:hover{transform:scale(1.05)}.q{display:none}.r{text-align:center;color:#6c757d;padding:40px 20px;font-style:italic}.s{margin-bottom:20px}.s label{display:block;margin-bottom:8px;font-weight:600;color:#495057}.s input{width:100%;padding:12px 16px;border:2px solid #e9ecef;border-radius:12px;font-size:16px;transition:border-color 0.2s}.s input:focus{border-color:#007bff;outline:none}.t{background:linear-gradient(135deg,#007bff,#0056b3);color:white;padding:12px 24px;border:none;border-radius:12px;cursor:pointer;font-weight:600;width:100%;margin:8px 0;font-size:16px;transition:transform 0.2s}.t:hover{transform:translateY(-1px)}.u{background:linear-gradient(135deg,#28a745,#20c997)}.v{text-align:center;margin-bottom:30px;color:#495057}.w{color:#dc3545;margin-top:15px;text-align:center;font-size:14px}.x{color:#28a745;margin-top:15px;text-align:center;font-size:14px}.y{background:#6c757d;color:white;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:background 0.2s}.y:hover{background:#5a6268}.z{flex:1;overflow-y:auto}.aa{background:#f8f9fa;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center}.aa h4{color:#495057;margin-bottom:8px}.aa span{color:#6c757d;font-size:14px}.bb{font-size:18px;line-height:1.5}.cc{background:#6c757d;color:white;padding:8px;border:none;border-radius:50%;cursor:pointer;margin-left:4px;width:36px;height:36px;display:flex;align-items:center;justify-content:center}.dd{position:absolute;bottom:100%;right:0;background:white;border:1px solid #ddd;border-radius:12px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.15);width:280px;max-height:200px;overflow-y:auto;z-index:1000}.ee{display:grid;grid-template-columns:repeat(8,1fr);gap:5px}.ff{padding:8px;border:none;background:none;cursor:pointer;border-radius:6px;font-size:20px;transition:background 0.2s}.ff:hover{background:#f0f0f0}.gg{max-width:200px;border-radius:12px;cursor:pointer}.hh{position:relative;display:inline-block}.ii{position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:12px}.jj{background:#e3f2fd;border:1px solid #90caf9;padding:8px 12px;border-radius:20px;margin:5px 0;font-size:13px;color:#1565c0;text-align:center}.kk{position:absolute;top:-5px;right:-5px;background:#dc3545;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;display:flex;align-items:center;justify-content:center;font-weight:bold}.ll{position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#007bff,#0056b3);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 25px rgba(0,123,255,0.3);z-index:10001;font-size:15px;font-weight:600;animation:slideInScale 0.4s cubic-bezier(0.175,0.885,0.32,1.275);max-width:320px;cursor:pointer}.mm{position:fixed;top:0;left:0;right:0;background:rgba(0,123,255,0.95);color:white;padding:12px;text-align:center;font-weight:600;z-index:10002;animation:slideDown 0.3s ease;box-shadow:0 2px 10px rgba(0,0,0,0.2)}.nn{background:linear-gradient(135deg,#28a745,#20c997)}.oo{background:linear-gradient(135deg,#ffc107,#ffb300);color:#000}@keyframes slideInScale{0%{transform:translateX(100%) scale(0.8);opacity:0}100%{transform:translateX(0) scale(1);opacity:1}}@keyframes slideDown{0%{transform:translateY(-100%)}100%{transform:translateY(0)}}@keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-3px)}60%{transform:translateY(-2px)}}@media(max-width:768px){body{overflow:auto;height:100vh}.b{flex-direction:column;height:100vh;max-width:100%;border-radius:0;position:fixed;top:0;left:0;right:0;bottom:0}.c{flex:none;height:35%;border-right:none;border-bottom:1px solid #e9ecef;padding:15px;overflow-y:auto}.d{flex:1;min-height:0;padding-bottom:80px}.f{flex:1;min-height:0;padding:15px;padding-bottom:120px;overflow-y:auto;-webkit-overflow-scrolling:touch}.g{position:fixed;bottom:0;left:0;right:0;padding:10px 15px;border-top:1px solid #e9ecef;background:white;z-index:1000}.aa{padding:10px;margin-bottom:10px}.dd{position:fixed;bottom:80px;right:10px;left:10px;width:auto}.ll{position:fixed;top:10px;left:10px;right:10px;width:auto;max-width:none;margin:0 10px}input,textarea{font-size:16px!important;transform:none!important}}</style></head><body><div class="a q" id="lf"><h2 class="v">?? Witaj w Chat</h2><div class="s"><label>Email:</label><input type="email" id="em" placeholder="Tw車j email"></div><div class="s"><label>Has?o:</label><input type="password" id="pw" placeholder="Minimum 6 znak車w"></div><button class="t" onclick="lg()">Zaloguj si?</button><button class="t u" onclick="rg()">Utw車rz konto</button><div id="am"></div><div style="text-align:center;margin-top:20px;color:#6c757d;">Bezpieczny komunikator z pe?n? prywatno?ci?</div></div><div class="b q" id="ma"><div class="c"><div class="aa"><h4>?? Tw車j profil</h4><span id="up"></span><button class="y" onclick="lo()" style="margin-top:10px;">?? Wyloguj</button></div><div class="z"><h3 style="margin-bottom:15px;color:#495057;">?? U?ytkownicy</h3><div id="ul"></div></div></div><div class="d"><div class="e"><h3 id="ct" style="color:#495057;">Wybierz rozm車wc?</h3><div id="cs"></div></div><div class="f" id="ms"><div class="r">?? Wybierz osob? z listy po lewej, aby rozpocz?? rozmow?</div></div><div class="g q" id="mis"><div class="jj q">?? Emotki ??, zdj?cia ?? i wiadomo?ci tekstowe!</div><div class="o"><input type="text" id="mi" class="o input" placeholder="Napisz wiadomo??... ??"><button class="cc" onclick="te()" title="Emotki">??</button><button class="cc" onclick="document.getElementById('fi').click()" title="Zdj?cie">??</button><button class="p" onclick="sm()" title="Wy?lij">??</button><input type="file" id="fi" accept="image/*" style="display:none;" onchange="hu(this)"></div><div class="dd q" id="ep"><div class="ee" id="eg"></div></div></div></div></div><script>let a,b,c=null,d=null,e=null,f=null,g=null,h=false,i={},j='Chat',k=false,l=null,m=null,n={};const o=['??','??','??','??','??','??','??','??','??','??','??','??','??','??','?','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??'];async function p(){try{m=new(window.AudioContext||window.webkitAudioContext)();q()}catch(e){}}function q(){if(!m)return;n.newMessage=r([800,1000,1200],0.15,0.3);n.sent=r([1200,1000],0.1,0.2)}function r(frequencies,duration,volume){const sampleRate=m.sampleRate;const length=sampleRate*duration;const buffer=m.createBuffer(1,length,sampleRate);const data=buffer.getChannelData(0);for(let i=0;i<length;i++){let sample=0;frequencies.forEach(freq=>{sample+=Math.sin(2*Math.PI*freq*i/sampleRate)/frequencies.length});data[i]=sample*volume*Math.exp(-i/(sampleRate*0.3))}return buffer}function s(soundName){if(!m||!n[soundName])return;try{if(m.state==='suspended'){m.resume()}const source=m.createBufferSource();source.buffer=n[soundName];source.connect(m.destination);source.start()}catch(e){}}function t(){if('Notification'in window){if(Notification.permission==='default'){Notification.requestPermission().then(permission=>{k=permission==='granted';if(k){u('?? Powiadomienia w??czone!','B?dziesz otrzymywa? alerty o nowych wiadomo?ciach','nn')}})}else{k=Notification.permission==='granted'}}}function v(title,body,icon='??'){if(!k||!('Notification'in window))return;try{const notification=new Notification(title,{body:body,icon:w(icon),badge:w('??'),requireInteraction:false,silent:false});notification.onclick=()=>{window.focus();notification.close()};setTimeout(()=>notification.close(),8000)}catch(e){}}function w(emoji){const canvas=document.createElement('canvas');canvas.width=64;canvas.height=64;const ctx=canvas.getContext('2d');ctx.fillStyle='#007bff';ctx.fillRect(0,0,64,64);ctx.font='40px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(emoji,32,32);return canvas.toDataURL()}function u(title,message,type=''){const existing=document.querySelector('.mm');if(existing)existing.remove();const notification=document.createElement('div');notification.className=`mm ${type}`;notification.innerHTML=`<strong>${title}</strong><br><span style="font-weight:normal;font-size:13px">${message}</span>`;document.body.appendChild(notification);setTimeout(()=>notification.remove(),4000)}function x(){const total=Object.values(i).reduce((sum,count)=>sum+count,0);document.title=total>0?`(${total}) ${j}`:j}function y(message,sender){const senderName=sender.split('@')[0];const displayMessage=message.length>50?message.substring(0,50)+'...':message;if(document.hidden||!document.hasFocus()){s('newMessage');const toast=document.createElement('div');toast.className='ll';toast.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><div style="width:40px;height:40px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px">??</div><div><strong>${senderName}</strong><br><span style="opacity:0.9;font-size:13px">${displayMessage}</span></div></div>`;toast.onclick=()=>{window.focus();toast.remove()};document.body.appendChild(toast);setTimeout(()=>toast.remove(),6000);v(`?? Nowa wiadomo?? od ${senderName}`,displayMessage);u(`?? ${senderName}`,displayMessage)}}async function z(text,password){const keyMaterial=await crypto.subtle.importKey('raw',new TextEncoder().encode(password),{name:'PBKDF2'},false,['deriveBits','deriveKey']);const salt=crypto.getRandomValues(new Uint8Array(16));const key=await crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},false,['encrypt']);const iv=crypto.getRandomValues(new Uint8Array(12));const encodedText=new TextEncoder().encode(text);const encrypted=await crypto.subtle.encrypt({name:'AES-GCM',iv:iv},key,encodedText);const encryptedArray=new Uint8Array(encrypted);const result=new Uint8Array(salt.length+iv.length+encryptedArray.length);result.set(salt,0);result.set(iv,salt.length);result.set(encryptedArray,salt.length+iv.length);return btoa(String.fromCharCode(...result))}async function A(encryptedData,password){try{const data=new Uint8Array(atob(encryptedData).split('').map(char=>char.charCodeAt(0)));const salt=data.slice(0,16);const iv=data.slice(16,28);const encrypted=data.slice(28);const keyMaterial=await crypto.subtle.importKey('raw',new TextEncoder().encode(password),{name:'PBKDF2'},false,['deriveBits','deriveKey']);const key=await crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},false,['decrypt']);const decrypted=await crypto.subtle.decrypt({name:'AES-GCM',iv:iv},key,encrypted);return new TextDecoder().decode(decrypted)}catch(e){return'[B??d deszyfrowania]'}}function B(text){let r=text;for(let i=0;i<3;i++){r=r.replace(/[a-zA-Z]/g,c=>String.fromCharCode((c<='Z'?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26));r=r.split('').reverse().join('');try{r=btoa(unescape(encodeURIComponent(r)))}catch(e){}}return r}function C(text){let r=text;for(let i=0;i<3;i++){try{r=decodeURIComponent(escape(atob(r)))}catch(e){}r=r.split('').reverse().join('');r=r.replace(/[a-zA-Z]/g,c=>String.fromCharCode((c<='Z'?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26))}return r}function te(){const picker=document.getElementById('ep');if(h){picker.classList.add('q');h=false}else{if(!document.getElementById('eg').innerHTML){D()}picker.classList.remove('q');h=true}}function D(){const grid=document.getElementById('eg');grid.innerHTML='';o.forEach(emoji=>{const btn=document.createElement('button');btn.className='ff';btn.textContent=emoji;btn.onclick=()=>E(emoji);grid.appendChild(btn)})}function E(emoji){const input=document.getElementById('mi');input.value+=emoji;input.focus();document.getElementById('ep').classList.add('q');h=false}function F(file,maxWidth=800,quality=0.8){return new Promise(resolve=>{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');const img=new Image();img.onload=function(){let{width,height}=img;if(width>height){if(width>maxWidth){height*=maxWidth/width;width=maxWidth}}else{if(height>maxWidth){width*=maxWidth/height;height=maxWidth}}canvas.width=width;canvas.height=height;ctx.drawImage(img,0,0,width,height);canvas.toBlob(resolve,'image/jpeg',quality)};img.src=URL.createObjectURL(file)})}async function hu(input){const file=input.files[0];if(!file)return;if(!file.type.startsWith('image/')){alert('Wybierz plik obrazu');return}try{let compressedFile=file;if(file.size>1024*1024){compressedFile=await F(file,600,0.7)}const reader=new FileReader();reader.onload=function(e){const base64=e.target.result;const img=document.createElement('img');img.src=base64;img.className='gg';img.onclick=()=>G(base64);const wrapper=document.createElement('div');wrapper.className='hh';const removeBtn=document.createElement('button');removeBtn.className='ii';removeBtn.innerHTML='℅';removeBtn.onclick=ev=>{ev.stopPropagation();wrapper.remove()};wrapper.appendChild(img);wrapper.appendChild(removeBtn);const messageInput=document.getElementById('mi');messageInput.parentNode.insertBefore(wrapper,messageInput.nextSibling)};reader.readAsDataURL(compressedFile)}catch(error){alert('B??d przetwarzania obrazu')}input.value=''}function G(src){const modal=document.createElement('div');modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer';const img=document.createElement('img');img.src=src;img.style.cssText='max-width:90%;max-height:90%;border-radius:12px';modal.appendChild(img);modal.onclick=()=>modal.remove();document.body.appendChild(modal)}function H(message,isError=false){const div=document.getElementById('am');div.innerHTML=isError?`<div class="w">${message}</div>`:`<div class="x">${message}</div>`}async function lg(){const email=document.getElementById('em').value;const password=document.getElementById('pw').value;if(!email||!password){H('Wype?nij wszystkie pola',true);return}try{await signInWithEmailAndPassword(a,email,password);H('Zalogowano pomy?lnie');u('? Zalogowano!','Witaj w bezpiecznym komunikatorze','nn')}catch(error){let msg='B??d logowania';if(error.code==='auth/user-not-found')msg='Nie znaleziono u?ytkownika';else if(error.code==='auth/wrong-password')msg='Nieprawid?owe has?o';else if(error.code==='auth/invalid-email')msg='Nieprawid?owy email';H(msg,true)}}async function rg(){const email=document.getElementById('em').value;const password=document.getElementById('pw').value;if(!email||!password){H('Wype?nij wszystkie pola',true);return}if(password.length<6){H('Has?o musi mie? minimum 6 znak車w',true);return}try{await createUserWithEmailAndPassword(a,email,password);H('Konto utworzone pomy?lnie');u('?? Konto utworzone!','Mo?esz teraz rozpocz?? rozmowy','nn')}catch(error){let msg='B??d rejestracji';if(error.code==='auth/email-already-in-use')msg='Ten email jest ju? u?ywany';else if(error.code==='auth/weak-password')msg='Has?o jest za s?abe';H(msg,true)}}async function lo(){if(g)clearInterval(g);await I(false);await signOut(a);u('?? Wylogowano','Do zobaczenia!','oo')}function J(userEmail,isOnline){document.querySelectorAll('.h').forEach(item=>{item.classList.remove('active')});document.querySelector(`[data-email="${userEmail}"]`).classList.add('active');d=userEmail;i[userEmail]=0;K();const userName=userEmail.split('@')[0];document.getElementById('ct').textContent=`?? ${userName}`;const chatStatus=document.getElementById('cs');chatStatus.innerHTML=isOnline?'<div style="color:#28a745;font-size:12px">?? Online</div>':'<div style="color:#dc3545;font-size:12px">?? Offline</div>';document.getElementById('mis').classList.remove('q');document.querySelector('.jj').classList.remove('q');L(userEmail)}function K(){document.querySelectorAll('.kk').forEach(badge=>badge.remove());Object.keys(i).forEach(email=>{if(i[email]>0){const userEl=document.querySelector(`[data-email="${email}"]`);if(userEl){const badge=document.createElement('div');badge.className='kk';badge.textContent=i[email]>99?'99+':i[email];userEl.appendChild(badge);userEl.style.animation='bounce 1s ease-in-out'}}});x()}function L(otherUserEmail){if(e){e()}const chatId=M(c.email,otherUserEmail);const messagesRef=collection(b,'messages');const q=query(messagesRef,where('chatId','==',chatId));e=onSnapshot(q,snapshot=>{const messagesContainer=document.getElementById('ms');messagesContainer.innerHTML='';let messages=[];snapshot.forEach(doc=>{const data=doc.data();data.id=doc.id;messages.push(data)});messages.sort((a,b)=>{if(!a.timestamp||!b.timestamp)return 0;return a.timestamp.toDate()-b.timestamp.toDate()});if(messages.length===0){messagesContainer.innerHTML='<div class="r">?? Rozpocznij rozmow?!</div>'}else{messages.forEach(data=>N(data))}messagesContainer.scrollTop=messagesContainer.scrollHeight})}async function N(data){const messagesContainer=document.getElementById('ms');const messageDiv=document.createElement('div');const isOwn=data.sender===c.email;messageDiv.className=`l ${isOwn?'own':'other'}`;const time=data.timestamp?new Date(data.timestamp.toDate()).toLocaleTimeString():'Teraz';let content;if(data.image){content=`<img src="${data.image}" class="gg" onclick="G('${data.image}')" style="cursor:pointer">`}else{const password=c.email+data.sender+data.recipient;let decryptedText;try{decryptedText=await A(data.text,password)}catch(e){decryptedText=C(data.text)}content=`<div class="n bb">${decryptedText}</div>`;if(!isOwn&&(d!==data.sender||document.hidden||!document.hasFocus())){if(!i[data.sender])i[data.sender]=0;if(data.id!==l){i[data.sender]++;K();y(decryptedText,data.sender);l=data.id}}}messageDiv.innerHTML=`<div class="m">${isOwn?'Ty':data.sender.split('@')[0]} ? ${time}</div>${content}`;messagesContainer.appendChild(messageDiv)}async function sm(){const input=document.getElementById('mi');const text=input.value.trim();const images=document.querySelectorAll('.hh img');if(!text&&images.length===0)return;const chatId=M(c.email,d);if(text){const password=c.email+c.email+d;let encryptedText;try{encryptedText=await z(text,password)}catch(e){encryptedText=B(text)}try{await addDoc(collection(b,'messages'),{chatId:chatId,text:encryptedText,sender:c.email,recipient:d,timestamp:serverTimestamp()});input.value='';s('sent')}catch(error){alert('B??d wysy?ania wiadomo?ci')}}for(let img of images){try{await addDoc(collection(b,'messages'),{chatId:chatId,image:img.src,sender:c.email,recipient:d,timestamp:serverTimestamp()});s('sent')}catch(error){alert('B??d wysy?ania zdj?cia')}}document.querySelectorAll('.hh').forEach(el=>el.remove())}function M(email1,email2){return[email1,email2].sort().join('_')}function O(){g=setInterval(async()=>{if(c){try{await setDoc(doc(b,'users',c.uid),{email:c.email,lastSeen:serverTimestamp(),online:true},{merge:true})}catch(e){}}},30000)}document.addEventListener('DOMContentLoaded',function(){const messageInput=document.getElementById('mi');if(messageInput){messageInput.addEventListener('keypress',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sm()}})}const passwordInput=document.getElementById('pw');if(passwordInput){passwordInput.addEventListener('keypress',function(e){if(e.key==='Enter'){lg()}})}document.addEventListener('click',function(e){if(!e.target.closest('.o')&&!e.target.closest('.dd')){document.getElementById('ep').classList.add('q');h=false}});document.addEventListener('visibilitychange',function(){if(!document.hidden){Object.keys(i).forEach(email=>{if(email===d)i[email]=0});K()}});window.addEventListener('focus',function(){if(d)i[d]=0;K()});p();t()})</script><script type="module">import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut}from'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';import{getFirestore,collection,addDoc,query,onSnapshot,serverTimestamp,where,doc,setDoc,deleteDoc}from'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';const fc={apiKey:"AIzaSyCJeQEnsEDDnGvKoVzKkjRmnOIsmv7HPJs",authDomain:"pensei-b3058.firebaseapp.com",projectId:"pensei-b3058",storageBucket:"pensei-b3058.firebasestorage.app",messagingSenderId:"341036858535",appId:"1:341036858535:web:43d4f98625abd9ff406f82",measurementId:"G-MR8G2GNY5P"};const app=initializeApp(fc);a=getAuth(app);b=getFirestore(app);window.signInWithEmailAndPassword=signInWithEmailAndPassword;window.createUserWithEmailAndPassword=createUserWithEmailAndPassword;window.signOut=signOut;window.collection=collection;window.addDoc=addDoc;window.serverTimestamp=serverTimestamp;window.query=query;window.where=where;window.onSnapshot=onSnapshot;window.doc=doc;window.setDoc=setDoc;window.deleteDoc=deleteDoc;onAuthStateChanged(a,user=>{if(user){c=user;document.getElementById('lf').classList.add('q');document.getElementById('ma').classList.remove('q');document.getElementById('up').textContent=user.email;I(true);P();O()}else{c=null;if(g)clearInterval(g);document.getElementById('lf').classList.remove('q');document.getElementById('ma').classList.add('q')}});async function I(isOnline){if(!c)return;const userRef=doc(b,'users',c.uid);if(isOnline){await setDoc(userRef,{email:c.email,lastSeen:serverTimestamp(),online:true})}else{await deleteDoc(userRef)}}function P(){const usersQuery=query(collection(b,'users'));f=onSnapshot(usersQuery,snapshot=>{const usersList=document.getElementById('ul');usersList.innerHTML='';const now=new Date();snapshot.forEach(doc=>{const userData=doc.data();if(userData.email!==c.email){const lastSeen=userData.lastSeen?userData.lastSeen.toDate():null;const isOnline=userData.online&&lastSeen&&(now-lastSeen)<90000;const userDiv=document.createElement('div');userDiv.className='h';userDiv.dataset.email=userData.email;userDiv.innerHTML=`<div class="i">${userData.email.split('@')[0]}</div><div class="j"><div class="k ${isOnline?'online':'offline'}"></div>${isOnline?'Online':'Offline'}</div>`;userDiv.onclick=()=>J(userData.email,isOnline);usersList.appendChild(userDiv);if(!i[userData.email])i[userData.email]=0}});K()})}window.addEventListener('beforeunload',()=>{if(c)I(false)});window.addEventListener('focus',()=>{if(c)I(true)});window.addEventListener('blur',()=>{setTimeout(()=>{if(c&&!document.hasFocus())I(false)},5000)})</script></body></html>