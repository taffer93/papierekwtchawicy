<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f0f0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.png">
<title>Kalkulator</title>
<style>
/* Bazowe */
* {margin:0;padding:0;box-sizing:border-box}
body {
  font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:#0f0f0f;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  color:#e0e0e0;
}

/* Retro terminal palette */
:root{
  --term-bg:#000000;
  --term-fg:#00ff66;
  --term-fg-dim:#00cc52;
  --term-border:#00aa55;
  --term-muted:#00773d;
  --term-danger:#ff4545;
  --term-warning:#ffbf00;
  --term-success:#00ff99;
  --term-white:#e0e0e0;
  --my-chat-color:#00ff66; /* kolor moich wiadomości i promptu */
}

/* PWA prompt */
.install-prompt {
  position:fixed;bottom:20px;left:20px;right:20px;
  background:var(--term-bg);
  color:var(--term-fg);
  padding:14px 16px;border-radius:0;
  border:1px dashed var(--term-border);
  box-shadow:none;z-index:10003;display:none;
  font-family: Consolas, "Courier New", monospace;
}
.install-prompt button {
  background:transparent;color:var(--term-fg);
  border:1px dashed var(--term-border);
  padding:8px 12px;font-weight:700;cursor:pointer;margin-top:10px;width:100%;
  font-family: Consolas, "Courier New", monospace;
}
.install-prompt button:hover {background:#001b11}

/* KALKULATOR – bez zmian */
.calc-screen {background:#1e1e1e;padding:40px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:100%;max-width:320px;margin:20px;border:1px solid #2d2d2d}
.calc-display {background:#252525;padding:20px;border-radius:8px;font-size:32px;text-align:right;margin-bottom:20px;min-height:80px;color:#e0e0e0;font-family:monospace;border:1px solid #3a3a3a;overflow:hidden;word-wrap:break-word}
.calc-buttons {display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.calc-btn {background:#374151;color:#e0e0e0;border:none;padding:20px;border-radius:8px;font-size:20px;cursor:pointer;transition:all 0.2s;font-weight:600;border:1px solid #4b5563}
.calc-btn:hover {background:#4b5563;transform:scale(1.05)}
.calc-btn:active {transform:scale(0.95)}
.calc-btn.operator {background:#2563eb;color:#fff}
.calc-btn.operator:hover {background:#3b82f6}
.calc-btn.equals {background:#10b981;color:#fff}
.calc-btn.equals:hover {background:#14c992}
.calc-btn.clear {background:#ef4444;color:#fff}
.calc-btn.clear:hover {background:#f87171}
.calc-message {background:rgba(16,185,129,0.1);border:1px solid #10b981;padding:12px;border-radius:8px;margin-top:15px;text-align:center;font-size:14px;color:#10b981;animation:fadeIn 0.5s ease}

/* Aplikacja (retro) */
.a {background:var(--term-bg);border-radius:0;box-shadow:none;overflow:hidden;width:100%;max-width:1000px;height:700px;display:flex;border:1px dashed var(--term-border)}
.b {flex:0 0 280px;background:#000;padding:12px;border-right:1px dashed var(--term-border);display:flex;flex-direction:column;overflow-y:auto;min-width:0;font-family:Consolas,"Courier New",monospace;color:var(--term-fg)}
.c {flex:1;display:flex;flex-direction:column;min-width:0;background:#000;color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.d {background:#000;padding:10px 12px;border-bottom:1px dashed var(--term-border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;color:var(--term-fg);font-weight:700}
.d h3 {font-family:Consolas,"Courier New",monospace}
.d .bar-left {display:flex;flex-direction:column}
.top-controls {display:flex;gap:6px;align-items:center;margin-left:12px}
.dd {
  background:#000;color:var(--term-fg);padding:8px 10px;border:1px dashed var(--term-border);
  border-radius:0;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center
}
.dd:hover {background:#001b11}
.e {flex:1;padding:12px;overflow-y:auto;background:#000;min-height:0;position:relative}

/* Lista użytkowników (lewa kolumna) */
.bb {background:#000;padding:12px;border-radius:0;margin-bottom:12px;text-align:left;border:1px dashed var(--term-border);color:var(--term-fg)}
.bb h4 {color:var(--term-fg);margin-bottom:6px;font-size:14px;font-weight:700}
.bb span {color:var(--term-fg);font-size:13px}
.term-setting {margin-top:10px}
.term-setting label {display:block;margin-bottom:6px;color:var(--term-fg-dim);font-size:12px}
.term-setting select {
  width:100%;background:#000;color:var(--term-fg);
  border:1px dashed var(--term-border);padding:6px;border-radius:0;
  font-family:Consolas,"Courier New",monospace
}
.z {background:#000;color:var(--term-fg);padding:8px 12px;border:1px dashed var(--term-border);border-radius:0;cursor:pointer;font-size:13px;width:100%;margin-top:10px;font-weight:700}
.z:hover {background:#001b11}

.user-section {margin-bottom:12px}
.user-section h3 {color:var(--term-fg-dim);margin-bottom:6px;font-size:11px;text-transform:uppercase;letter-spacing:1.5px;padding:6px;font-weight:700;cursor:pointer;background:#000;border:1px dashed var(--term-border);display:flex;align-items:center;justify-content:space-between}
.user-section h3:hover {background:#001b11}
.user-list {max-height:500px;overflow:hidden;transition:max-height 0.3s ease}
.user-list.collapsed {max-height:0}
.g {padding:8px 10px;margin:6px 0;background:#000;border-radius:0;cursor:pointer;transition:all 0.2s;border:1px dashed var(--term-border);position:relative;color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.g:hover {background:#001b11}
.g.active {outline:2px solid var(--term-fg)}
.h {font-weight:700;margin-bottom:4px;font-size:13px;color:var(--term-fg);display:flex;align-items:center;justify-content:space-between}
.i {font-size:12px;color:var(--term-fg-dim);display:flex;align-items:center}
.user-unread-badge {background:#000;color:var(--term-warning);border:1px dashed var(--term-warning);border-radius:2px;padding:0 6px;height:18px;line-height:18px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;margin-left:6px}

/* Chat: tabela 3-kolumnowa */
.chat-table { border:1px dashed var(--term-border); }
.chat-header, .chat-row {
  display:grid; grid-template-columns: 140px 140px 1fr;
  border-bottom:1px dashed var(--term-border);
}
.chat-header { background:#000; position:sticky; top:0; z-index:1 }
.chat-header .cell { font-weight:700; color:var(--term-fg) }
.chat-row .cell { color:var(--term-fg) }
.cell { padding:8px 10px; white-space:pre-line }
.cell:not(:last-child) { border-right:1px dashed var(--term-border) }
.cell.msg b { color:var(--my-chat-color) } /* nazwa + prompt */
.time { color:var(--term-fg-dim); font-size:12px; line-height:1.2 }
.msg-text { font-size:15px; line-height:1.5 }
.img-in-msg { max-width:200px; border:1px dashed var(--term-border); cursor:pointer }
.read-receipt-inline { color:var(--term-success); font-size:10px; margin-left:6px }

/* Prompt wewnątrz tabeli */
.prompt-line { display:inline-flex; align-items:baseline; gap:6px }
.prompt-input {
  min-width:10px; outline:none; border:none; background:transparent;
  color:var(--my-chat-color); caret-color:transparent; /* ukryj natywny caret */
  white-space:pre-wrap; word-break:break-word;
}
.prompt-caret {
  display:inline-block; width:8px; height:1.2em; background:var(--my-chat-color);
  vertical-align:text-bottom; animation:blockBlink 1s steps(1) infinite
}
@keyframes blockBlink { 0%,50% {opacity:1} 50.1%,100% {opacity:0} }

/* Emotki panel (ASCII) */
.ee {position:absolute;top:calc(100% + 8px);right:12px;background:#000;border:1px dashed var(--term-border);border-radius:0;padding:10px;box-shadow:none;width:320px;max-height:240px;overflow-y:auto;z-index:1000}
.ff {display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.gg {padding:6px;border:1px dashed var(--term-border);background:#000;cursor:pointer;border-radius:0;font-size:14px;color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.gg:hover {background:#001b11}

/* Podgląd obrazów w wierszu nad promptem */
.image-preview-container {display:flex;flex-wrap:wrap;gap:6px;width:100%}
.hh {max-width:200px;border:1px dashed var(--term-border);border-radius:0;cursor:pointer}
.ii {position:relative;display:inline-block}
.jj {position:absolute;top:4px;right:4px;background:#000;color:var(--term-danger);border:1px dashed var(--term-danger);border-radius:0;width:22px;height:22px;cursor:pointer;font-size:12px;font-weight:700}
.jj:hover {background:#1a0000}

/* Toast */
.toast-notification {
  position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:#000;color:var(--term-fg);padding:12px 14px;border-radius:0;border:1px dashed var(--term-border);
  box-shadow:none;z-index:10002;font-size:13px;font-weight:700;max-width:90%;
  font-family:Consolas,"Courier New",monospace
}

/* Login (retro) */
.r {background:#000;padding:30px;border-radius:0;box-shadow:none;width:100%;max-width:420px;margin:20px;border:1px dashed var(--term-border);color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.s {text-align:center;margin-bottom:20px;color:var(--term-fg);font-size:20px;font-weight:700}
.t {margin-bottom:16px}
.t label {display:block;margin-bottom:6px;font-weight:700;color:var(--term-fg-dim);font-size:12px}
.t input {width:100%;padding:10px 12px;border:1px dashed var(--term-border);border-radius:0;font-size:15px;background:#000;color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.t input::placeholder {color:var(--term-fg-dim)}
.u {background:#000;color:var(--term-fg);padding:12px;border:1px dashed var(--term-border);border-radius:0;cursor:pointer;font-weight:700;width:100%;margin:8px 0;font-size:14px}
.u:hover {background:#001b11}
.u:disabled {opacity:0.6;cursor:not-allowed}
.v {border-color:var(--term-success);color:var(--term-success)}
.w {text-align:center;margin-top:12px;color:var(--term-fg-dim);font-size:12px}
.x {color:var(--term-danger);margin-top:12px;text-align:center;font-size:13px;padding:10px;background:#1a0000;border:1px dashed var(--term-danger)}
.y {color:var(--term-success);margin-top:12px;text-align:center;font-size:13px;padding:10px;background:#001b11;border:1px dashed var(--term-success)}

.p {display:none!important}

/* Scrollbary */
.ee::-webkit-scrollbar,.aa::-webkit-scrollbar,.b::-webkit-scrollbar,.e::-webkit-scrollbar{width:6px;height:6px}
.ee::-webkit-scrollbar-track,.aa::-webkit-scrollbar-track,.b::-webkit-scrollbar-track,.e::-webkit-scrollbar-track{background:#000}
.ee::-webkit-scrollbar-thumb,.aa::-webkit-scrollbar-thumb,.b::-webkit-scrollbar-thumb,.e::-webkit-scrollbar-thumb{background:#00331a}
.ee::-webkit-scrollbar-thumb:hover,.aa::-webkit-scrollbar-thumb:hover,.b::-webkit-scrollbar-thumb:hover,.e::-webkit-scrollbar-thumb:hover{background:#004d26}

/* Mobile */
@media(max-width:768px){
  body{overflow:hidden;height:100vh;display:block}
  .a{flex-direction:column;height:100vh;max-width:100%;border-radius:0;position:fixed;top:0;left:0;right:0;bottom:0}
  .b{flex:none;height:35%;border-right:none;border-bottom:1px dashed var(--term-border);padding:10px;overflow-y:auto}
  .c{flex:1;min-height:0;display:flex;flex-direction:column}
  .d{padding:10px 12px}
  .e{flex:1;min-height:0;padding:10px;overflow-y:auto;-webkit-overflow-scrolling:touch; padding-bottom:160px} /* miejsce na prompt */
  .ee{position:fixed;top:64px;right:12px;left:12px;width:auto;max-height:200px}
  .toast-notification{left:12px;right:12px;transform:none}
}
</style>
</head>
<body>

<!-- PWA install prompt -->
<div class="install-prompt" id="installPrompt">
  <strong>[ PWA ] Zainstaluj aplikacje</strong>
  <p style="margin-top:6px;font-size:12px">Dodaj Kalkulator do ekranu glownego.</p>
  <button onclick="installApp()">Zainstaluj</button>
  <button onclick="dismissInstall()" style="margin-top:8px">Pozniej</button>
</div>

<!-- Kalkulator (bez zmian) -->
<div class="calc-screen" id="calcScreen">
  <h2 class="s" style="text-align:center;margin-bottom:20px">&#128200; Kalkulator</h2>
  <div class="calc-display" id="calcDisplay">0</div>
  <div class="calc-buttons">
    <button class="calc-btn" onclick="appendCalc('7')">7</button>
    <button class="calc-btn" onclick="appendCalc('8')">8</button>
    <button class="calc-btn" onclick="appendCalc('9')">9</button>
    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
    <button class="calc-btn" onclick="appendCalc('4')">4</button>
    <button class="calc-btn" onclick="appendCalc('5')">5</button>
    <button class="calc-btn" onclick="appendCalc('6')">6</button>
    <button class="calc-btn operator" onclick="appendCalc('-')">-</button>
    <button class="calc-btn" onclick="appendCalc('1')">1</button>
    <button class="calc-btn" onclick="appendCalc('2')">2</button>
    <button class="calc-btn" onclick="appendCalc('3')">3</button>
    <button class="calc-btn operator" onclick="appendCalc('*')">×</button>
    <button class="calc-btn clear" onclick="clearCalc()">C</button>
    <button class="calc-btn" onclick="appendCalc('0')">0</button>
    <button class="calc-btn equals" onclick="calculateCalc()">=</button>
    <button class="calc-btn operator" onclick="appendCalc('/')">÷</button>
  </div>
  <div id="calcMessage"></div>
</div>

<!-- Logowanie -->
<div class="r p" id="lf">
  <h2 class="s">== Logowanie ==</h2>
  <div class="t">
    <label>Email</label>
    <input type="email" id="em" placeholder="twoj@email.com" autocomplete="email">
  </div>
  <div class="t">
    <label>Haslo</label>
    <input type="password" id="pw" placeholder="........" autocomplete="current-password">
  </div>
  <button class="u" id="loginBtn" onclick="lg()">[ Zaloguj ]</button>
  <button class="u v" id="registerBtn" onclick="rg()">[ Utworz konto ]</button>
  <div id="am"></div>
  <div class="w">[ Bezpieczne polaczenie ]</div>
  <div style="margin-top:15px;text-align:center">
    <small style="color:#666;font-size:11px">
      Status: <span id="firebaseStatus" style="color:#ef4444">X Ladowanie...</span>
    </small>
  </div>
</div>

<!-- Aplikacja -->
<div class="a p" id="ma">
  <div class="b">
    <div class="bb">
      <h4>Twoj profil</h4>
      <span id="up"></span>
      <div class="term-setting">
        <label for="textColorSelect">Kolor czcionki (Twoje wiadomosci)</label>
        <select id="textColorSelect" onchange="updateTextColor(this.value)">
          <option value="#00ff66">Green</option>
          <option value="#ffbf00">Amber</option>
          <option value="#00ffff">Cyan</option>
          <option value="#ff00ff">Magenta</option>
          <option value="#e0e0e0">White</option>
        </select>
      </div>
    </div>
    <button class="z" onclick="lo()">[ Wyloguj ]</button>
    <div class="aa">
      <div class="user-section">
        <h3 onclick="toggleUserSection('online')">
          <span>Online<span class="users-online-count" id="onlineCount" style="margin-left:6px;border:1px dashed var(--term-border);padding:2px 6px;color:var(--term-fg)"></span></span>
          <span class="toggle-icon">v</span>
        </h3>
        <div class="user-list" id="ulOnline"></div>
      </div>
      <div class="user-section">
        <h3 onclick="toggleUserSection('offline')">
          <span>Offline<span class="users-offline-count" id="offlineCount" style="margin-left:6px;border:1px dashed var(--term-border);padding:2px 6px;color:var(--term-fg)"></span></span>
          <span class="toggle-icon">v</span>
        </h3>
        <div class="user-list" id="ulOffline"></div>
      </div>
    </div>
  </div>
  <div class="c">
    <div class="d">
      <div class="bar-left">
        <h3 id="ct" style="margin:0;font-size:16px">== Wybierz rozmowce ==</h3>
        <div id="cs" style="margin-top:4px;font-size:11px;color:var(--term-fg-dim)"></div>
      </div>
      <div class="top-controls">
        <button class="dd" id="emojiBtn" onclick="toggleEmoji()">:)</button>
        <button class="dd" onclick="document.getElementById('fi').click()">[IMG]</button>
        <input type="file" id="fi" accept="image/*" style="display:none" onchange="hu(this)">
        <div class="ee p" id="ep"><div class="ff" id="eg"></div></div>
      </div>
    </div>
    <div class="e" id="ms">
      <!-- Struktura tabeli będzie wstawiana dynamicznie -->
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
/* Firebase config (jak u Ciebie) */
const firebaseConfig={
  apiKey:"AIzaSyCJeQEnsEDDnGvKoVzKkjRmnOIsmv7HPJs",
  authDomain:"pensei-b3058.firebaseapp.com",
  projectId:"pensei-b3058",
  storageBucket:"pensei-b3058.firebasestorage.app",
  messagingSenderId:"341036858535",
  appId:"1:341036858535:web:43d4f98625abd9ff406f82",
  measurementId:"G-MR8G2GNY5P"
};

/* SW */
if('serviceWorker'in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{})
  })
}

/* PWA prompt */
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  const p=document.getElementById('installPrompt');
  if(p)p.style.display='block'
});
window.installApp = function(){
  const p=document.getElementById('installPrompt');
  if(p)p.style.display='none';
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(()=>{deferredPrompt=null})
  }
};
window.dismissInstall = function(){
  const p=document.getElementById('installPrompt');
  if(p)p.style.display='none'
};

/* Kalkulator (bez zmian) */
let calcExpression='';
let calcDisplay=null;
window.appendCalc = function(value){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  if(calcExpression==='0'||calcExpression==='')calcExpression='';
  calcExpression+=value;
  calcDisplay.textContent=calcExpression;
};
window.clearCalc = function(){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  calcExpression='';
  calcDisplay.textContent='0';
  const msg=document.getElementById('calcMessage');
  if(msg)msg.innerHTML='';
};
window.calculateCalc = function(){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  try{
    const result=eval(calcExpression);
    calcDisplay.textContent=result;
    if(calcExpression==='1488+2137'||calcExpression==='2137+1488'){
      const msg=document.getElementById('calcMessage');
      msg.innerHTML='<div class="calc-message">🎉 Brawo! Znalazłeś sekretny kod! 🎉<br>Za chwilę przejdziesz do logowania... 🔐</div>';
      setTimeout(function(){
        document.getElementById('calcScreen').classList.add('p');
        document.getElementById('lf').classList.remove('p');
      },3000);
    }
    calcExpression=result.toString();
  }catch(e){
    calcDisplay.textContent='Błąd';
    calcExpression='';
  }
};

/* Toggle list online/offline */
window.toggleUserSection = function(section){
  const list=document.getElementById(section==='online'?'ulOnline':'ulOffline');
  const header=list.previousElementSibling;
  if(list.classList.contains('collapsed')){
    list.classList.remove('collapsed');
    header.classList.remove('collapsed');
  }else{
    list.classList.add('collapsed');
    header.classList.add('collapsed');
  }
};

/* Firebase init */
let a, d;
try {
  firebase.initializeApp(firebaseConfig);
  a = firebase.auth();
  d = firebase.firestore();
  a.setPersistence(firebase.auth.Auth.Persistence.NONE);
  if(a.currentUser){ a.signOut(); }
  const statusEl = document.getElementById('firebaseStatus');
  if(statusEl){ statusEl.innerHTML = '&#10003; Polaczono'; statusEl.style.color = '#00ff66'; }
} catch(err) {
  const statusEl = document.getElementById('firebaseStatus');
  if(statusEl){ statusEl.innerHTML = 'X Blad'; statusEl.style.color = '#ff4545'; }
}

/* --------- CZAT --------- */
let cu=null,sc=null,um=null,ht=null,es=false,unread={},ot='Kalkulator',nf=false,lastMessage=null,encryptionKey=null,messageIds=new Set(),audioContext=null,scrollTimeout=null,shouldAutoScroll=true,renderQueue=[],isRendering=false,isFirstSnapshot=true,allUsersListener=null,unreadMessageIds=new Set();
let typedBuffer=''; /* tekst promptu */

const userColors = {}; // email -> color
const DEFAULT_USER_COLOR = '#00ff66';
const COLOR_OPTIONS = ['#00ff66','#ffbf00','#00ffff','#ff00ff','#e0e0e0'];

const emoticons = [
  ':)', ':-)', ':D', ':-D', ';)', ';-)', ':P', ':-P', 'XD', 'xD',
  ':(', ':-(', ":'(", ':O', ':-O', ':/', ':-/', ':|', ':-|', ':]',
  ':[', ':3', '^^', '^-^', '^_^', '-_-', 'T_T', '>.<', '>:)', '>:(',
  '8)', 'B)', '8-)', 'B-)', ':@', ':-@', 'o_O', 'O_o', ':^)', ':-\\',
  '=_=', 'o.O', 'O.o', ':>', '<3', '</3', ':]', '[:', ':*', ':^)'
];

/* Dźwięk i toasty */
function playNotificationSound(){
  try{
    if(!audioContext)audioContext=new(window.AudioContext||window.webkitAudioContext)();
    const now=audioContext.currentTime;
    const o=audioContext.createOscillator();
    const g=audioContext.createGain();
    o.connect(g); g.connect(audioContext.destination);
    o.frequency.setValueAtTime(900,now);
    o.frequency.exponentialRampToValueAtTime(600,now+0.12);
    g.gain.setValueAtTime(0.25,now);
    g.gain.exponentialRampToValueAtTime(0.01,now+0.35);
    o.start(now); o.stop(now+0.35);
  }catch(e){}
}
function showToast(title,message,type){
  type=type||'info';
  const toast=document.createElement('div');
  toast.className='toast-notification';
  if(type==='success'){ toast.style.borderColor= 'var(--term-success)'; toast.style.color='var(--term-success)'; }
  else if(type==='error'){ toast.style.borderColor='var(--term-danger)'; toast.style.color='var(--term-danger)'; }
  else if(type==='message'){ toast.style.borderColor='var(--term-border)'; toast.style.color='var(--term-fg)'; }
  toast.innerHTML='[ '+escapeHtml(title)+' ]<br>'+escapeHtml(message);
  document.body.appendChild(toast);
  playNotificationSound();
  if(navigator.vibrate)navigator.vibrate([80,40,80]);
  setTimeout(function(){ toast.style.opacity='0'; setTimeout(function(){toast.remove()},300); },3500);
}
function rn(){
  if('Notification'in window&&Notification.permission==='default'){
    Notification.requestPermission().then(function(permission){
      nf=permission==='granted';
      if(nf)showToast('Powiadomienia','Wlaczone','success');
    })
  }
}
function sn(title,body){
  if(nf&&'Notification'in window&&Notification.permission==='granted'){
    try{
      const n=new Notification(title,{body:body,icon:'icon.png',tag:'msg',requireInteraction:false});
      n.onclick=function(){window.focus();n.close()}
    }catch(e){}
  }
}
function ut(){
  const total=Object.values(unread).reduce((s,c)=>s+c,0);
  document.title=total>0?'('+total+') '+ot:ot
}
function snt(message,sender){
  const senderName=sender.split('@')[0];
  const shortMsg=message.length>50?message.substring(0,50)+'...':message;
  showToast('MSG '+senderName,shortMsg,'message');
  sn('MSG '+senderName,message);
  if(lastMessage!==message){playNotificationSound();lastMessage=message}
}

/* Crypto (jak było) */
async function generateKey(password){
  const encoder=new TextEncoder();
  const keyMaterial=await crypto.subtle.importKey('raw',encoder.encode(password),'PBKDF2',false,['deriveBits','deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt:encoder.encode('salt-2024'),iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},true,['encrypt','decrypt'])
}
async function ec(text){
  try{
    if(!encryptionKey)encryptionKey=await generateKey('key-2024');
    const encoder=new TextEncoder();const data=encoder.encode(text);
    const iv=crypto.getRandomValues(new Uint8Array(12));
    const encrypted=await crypto.subtle.encrypt({name:'AES-GCM',iv:iv},encryptionKey,data);
    const encryptedArray=new Uint8Array(encrypted);
    const combined=new Uint8Array(iv.length+encryptedArray.length);
    combined.set(iv);combined.set(encryptedArray,iv.length);
    return btoa(String.fromCharCode.apply(null,combined))
  }catch(e){return text}
}
async function dc(encryptedText){
  try{
    if(!encryptionKey)encryptionKey=await generateKey('key-2024');
    const combined=Uint8Array.from(atob(encryptedText),c=>c.charCodeAt(0));
    const iv=combined.slice(0,12);const data=combined.slice(12);
    const decrypted=await crypto.subtle.decrypt({name:'AES-GCM',iv:iv},encryptionKey,data);
    const decoder=new TextDecoder();return decoder.decode(decrypted)
  }catch(e){return encryptedText}
}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}

/* Scroll helpers */
function isUserAtBottom(){
  const md=document.getElementById('ms');
  if(!md)return true;
  return md.scrollHeight - md.scrollTop - md.clientHeight < 100;
}
function scrollToBottom(force){
  if(scrollTimeout)clearTimeout(scrollTimeout);
  scrollTimeout=setTimeout(function(){
    const md=document.getElementById('ms');
    if(!md)return;
    if(force || shouldAutoScroll || isUserAtBottom()){
      md.scrollTop=md.scrollHeight;
    }
  },50);
}

/* Emotki (ASCII) panel */
let es=false;
window.toggleEmoji = function(){
  const ep=document.getElementById('ep');
  if(!ep)return;
  if(es){ep.classList.add('p');es=false}
  else{
    const eg=document.getElementById('eg');
    if(!eg.innerHTML){ eg.innerHTML=''; emoticons.forEach(function(e){ const b=document.createElement('button'); b.className='gg'; b.textContent=e; b.onclick=function(ev){ev.stopPropagation();ae(e)}; eg.appendChild(b) }); }
    ep.classList.remove('p');es=true
  }
};
function ae(emoji){
  const pi=document.getElementById('promptInput');
  if(!pi)return;
  if(pi.textContent && !/\s$/.test(pi.textContent)) pi.textContent+=' ';
  pi.textContent+=emoji+' ';
  typedBuffer=pi.textContent;
  pi.focus();
  const ep=document.getElementById('ep');if(ep){ep.classList.add('p');es=false}
}

/* READ/UNREAD */
async function markAllAsRead(){
  if(!cu||!sc)return;
  try{
    const ci=cci(cu.email,sc);
    const q=await d.collection('messages').where('chatId','==',ci).where('sender','==',sc).where('readBy','==',null).get();
    const batch=d.batch();
    q.forEach(function(doc){
      batch.update(doc.ref,{readAt:firebase.firestore.FieldValue.serverTimestamp(),readBy:cu.email});
      unreadMessageIds.delete(doc.id);
      const row=document.querySelector('.chat-row[data-msg-id="'+doc.id+'"] .cell.read');
      if(row) row.innerHTML=formatTime(new Date());
    });
    if(!q.empty){ await batch.commit(); }
  }catch(e){}
}

/* Usuwanie */
window.deleteMessage = async function(messageId){
  if(!messageId)return;
  if(!confirm('Usunac te wiadomosc?'))return;
  try{
    const row=document.querySelector('.chat-row[data-msg-id="'+messageId+'"]');
    if(row)row.style.opacity='0.5';
    await d.collection('messages').doc(messageId).delete();
    setTimeout(function(){if(row&&row.parentNode)row.remove();messageIds.delete(messageId)},200);
    showToast('OK','Wiadomosc usunieta','success')
  }catch(error){
    showToast('Blad','Nie udalo sie usunac','error')
  }
};

/* Kompresja obrazka → podgląd */
function ci(file,maxWidth,quality){
  maxWidth=maxWidth||800;quality=quality||0.8;
  return new Promise(function(resolve){
    const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');const img=new Image();
    img.onload=function(){
      let width=img.width;let height=img.height;
      if(width>height){if(width>maxWidth){height*=maxWidth/width;width=maxWidth}}
      else{if(height>maxWidth){width*=maxWidth/height;height=maxWidth}}
      canvas.width=width;canvas.height=height;ctx.drawImage(img,0,0,width,height);
      canvas.toBlob(resolve,'image/jpeg',quality)
    };
    img.src=URL.createObjectURL(file)
  })
}
window.hu = async function(input){
  const file=input.files[0];
  if(!file)return;
  if(!file.type.startsWith('image/')){showToast('Blad','Wybierz plik obrazu','error');return}
  try{
    let compressedFile=file;
    if(file.size>1024*1024)compressedFile=await ci(file,600,0.7);
    const reader=new FileReader();
    reader.onload=function(e){
      ensureChatScaffold();
      const base64=e.target.result;
      const img=document.createElement('img');
      img.src=base64; img.className='hh img-in-msg'; img.onclick=function(){oi(base64)};
      const wrapper=document.createElement('div'); wrapper.className='ii';
      const removeBtn=document.createElement('button'); removeBtn.className='jj'; removeBtn.textContent='X';
      removeBtn.onclick=function(ev){ev.stopPropagation();wrapper.remove()};
      wrapper.appendChild(img); wrapper.appendChild(removeBtn);
      const container=document.getElementById('imagePreviewContainer');
      container.appendChild(wrapper);
      scrollToBottom(true);
    };
    reader.readAsDataURL(compressedFile)
  }catch(error){ showToast('Blad','Blad przetwarzania','error') }
  input.value=''
};
window.oi = function(src){
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer';
  const img=document.createElement('img'); img.src=src; img.style.cssText='max-width:90%;max-height:90%;border:1px dashed var(--term-border)';
  modal.appendChild(img);
  modal.onclick=function(){modal.remove()};
  document.body.appendChild(modal)
};

/* Login */
function sam(m,ie){const dv=document.getElementById('am');dv.innerHTML=ie?'<div class="x">'+escapeHtml(m)+'</div>':'<div class="y">'+escapeHtml(m)+'</div>';setTimeout(function(){dv.innerHTML=''},5000)}
window.lg = async function(){
  const e=document.getElementById('em').value.trim();
  const p=document.getElementById('pw').value;
  const loginBtn=document.getElementById('loginBtn');
  if(!e||!p){ sam('Wypelnij wszystkie pola',true); return }
  if(!a){ alert('Blad polaczenia. Odswiez strone.'); return }
  loginBtn.disabled=true; loginBtn.textContent='Logowanie...';
  try{
    await a.signInWithEmailAndPassword(e,p);
    sam('Zalogowano'); showToast('OK','Zalogowano','success')
  }catch(er){
    let msg='Blad logowania';
    if(er.code==='auth/user-not-found')msg='Nie znaleziono uzytkownika';
    else if(er.code==='auth/wrong-password')msg='Nieprawidlowe haslo';
    else if(er.code==='auth/invalid-email')msg='Nieprawidlowy email';
    else if(er.code==='auth/invalid-credential')msg='Nieprawidlowe dane logowania';
    else if(er.code==='auth/too-many-requests')msg='Zbyt wiele prob. Sprobuj pozniej';
    else if(er.code==='auth/network-request-failed')msg='Brak polaczenia z internetem';
    sam(msg,true); showToast('Blad',msg,'error')
  }finally{
    loginBtn.disabled=false; loginBtn.textContent='[ Zaloguj ]'
  }
};
window.rg = async function(){
  const e=document.getElementById('em').value.trim();
  const p=document.getElementById('pw').value;
  const regBtn=document.getElementById('registerBtn');
  if(!e||!p){ sam('Wypelnij wszystkie pola',true); return }
  if(p.length<6){ sam('Haslo min. 6 znakow',true); return }
  if(!a){ alert('Blad polaczenia. Odswiez strone.'); return }
  regBtn.disabled=true; regBtn.textContent='Tworzenie...';
  try{
    await a.createUserWithEmailAndPassword(e,p);
    sam('Konto utworzone'); showToast('OK','Konto utworzone','success')
  }catch(er){
    let msg='Blad rejestracji';
    if(er.code==='auth/email-already-in-use')msg='Email juz uzywany';
    else if(er.code==='auth/weak-password')msg='Haslo za slabe';
    else if(er.code==='auth/invalid-email')msg='Nieprawidlowy email';
    sam(msg,true); showToast('Blad',msg,'error')
  }finally{
    regBtn.disabled=false; regBtn.textContent='[ Utworz konto ]'
  }
};
window.lo = async function(){
  try{
    if(ht)clearInterval(ht);
    if(um)um();
    if(allUsersListener)allUsersListener();
    await suo(false);
    await a.signOut();
    cu=null; sc=null; unread={}; encryptionKey=null;
    messageIds.clear(); unreadMessageIds.clear(); renderQueue=[]; isRendering=false; isFirstSnapshot=true;
    typedBuffer='';
    const md=document.getElementById('ms'); if(md) md.innerHTML='';
    document.getElementById('ma').classList.add('p');
    document.getElementById('lf').classList.add('p');
    document.getElementById('calcScreen').classList.remove('p');
    document.getElementById('em').value=''; document.getElementById('pw').value='';
    showToast('Wylogowano','Do zobaczenia','success')
  }catch(error){ showToast('Blad','Blad wylogowania','error') }
};

/* Użytkownik → wybór rozmówcy */
function su(ue,io){
  document.querySelectorAll('.g').forEach(function(i){i.classList.remove('active')});
  const userEl=document.querySelector('[data-email="'+ue+'"]');
  if(userEl)userEl.classList.add('active');
  sc=ue; unread[ue]=0; uur();
  const un=ue.split('@')[0];
  document.getElementById('ct').textContent='== '+un+' ==';
  const cs=document.getElementById('cs');
  cs.textContent=io?'[ ONLINE ]':'[ OFFLINE ]';
  cs.style.color = io ? 'var(--term-success)' : 'var(--term-fg-dim)';
  lm(ue);
  markAllAsRead();
}

/* Badge nieprzeczytanych */
function uur(){
  Object.keys(unread).forEach(function(email){
    const userEl=document.querySelector('[data-email="'+email+'"]');
    if(userEl){
      const existingBadge=userEl.querySelector('.user-unread-badge');
      if(existingBadge)existingBadge.remove();
      if(unread[email]>0){
        const nameEl=userEl.querySelector('.h');
        if(nameEl){
          const badge=document.createElement('span');
          badge.className='user-unread-badge';
          badge.textContent=unread[email]>9?'9+':unread[email];
          nameEl.appendChild(badge);
        }
      }
    }
  });
  ut();
}

/* Zliczanie nieprzeczytanych (prosty wariant) */
async function countUnreadMessages(){
  if(!cu)return;
  try{
    const ur=d.collection('users');
    ur.onSnapshot(async function(sn){
      for(const doc of sn.docs){
        const userData=doc.data();
        if(userData.email!==cu.email){
          const ci=cci(cu.email,userData.email);
          const q=await d.collection('messages').where('chatId','==',ci).where('sender','==',userData.email).where('readBy','==',null).get();
          unread[userData.email]=q.size;
        }
      }
      uur();
    });
  }catch(e){}
}

/* Chat tabela — scaffold zawsze utrzymany (nie wraca do starych "bubbles") */
function ensureChatScaffold(reset){
  const ms=document.getElementById('ms');
  let grid=document.getElementById('chatGrid');
  const uname=sc ? sc.split('@')[0] : 'nazwa uzytkownika';
  if(!grid){
    const wrap=document.createElement('div');
    wrap.className='chat-table';
    wrap.id='chatGrid';
    wrap.innerHTML = ''
      + '<div class="chat-header">'
      + '  <div class="cell">READ</div>'
      + '  <div class="cell">SENT</div>'
      + '  <div class="cell"><span id="chatHeaderUser">'+escapeHtml(uname)+'</span></div>'
      + '</div>'
      + '<div class="chat-body" id="chatBody"></div>'
      + '<div class="chat-row" id="previewRow">'
      + '  <div class="cell read"></div>'
      + '  <div class="cell sent"></div>'
      + '  <div class="cell msg"><div id="imagePreviewContainer" class="image-preview-container"></div></div>'
      + '</div>'
      + '<div class="chat-row" id="promptRow">'
      + '  <div class="cell read"></div>'
      + '  <div class="cell sent"></div>'
      + '  <div class="cell msg">'
      + '    <span class="prompt-line"><b id="promptUserLabel">'+escapeHtml((cu?cu.email.split("@")[0]:"me"))+':</b> <span id="promptInput" class="prompt-input" contenteditable="true" spellcheck="false"></span><span class="prompt-caret"></span></span>'
      + '  </div>'
      + '</div>';
    ms.innerHTML='';
    ms.appendChild(wrap);

    const pi=document.getElementById('promptInput');
    pi.addEventListener('keydown', function(e){
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault(); sm();
      }
    });
    pi.addEventListener('input', function(){ typedBuffer=this.textContent; });

    // focus do prompt po kliknięciu okna czatu
    ms.addEventListener('click', function(ev){
      if(!ev.target.closest('#promptInput') && !ev.target.closest('.dd') && !ev.target.closest('#ep')){
        const el=document.getElementById('promptInput'); if(el) el.focus();
      }
    });
  }else{
    // aktualizacja nagłówków i czyszczenie
    const hdr=document.getElementById('chatHeaderUser');
    if(hdr) hdr.textContent = uname;
    const pl=document.getElementById('promptUserLabel');
    if(pl && cu) pl.textContent = cu.email.split('@')[0]+':';
    if(reset){
      const body=document.getElementById('chatBody'); if(body) body.innerHTML='';
      const prev=document.getElementById('imagePreviewContainer'); if(prev) prev.innerHTML='';
      const pi=document.getElementById('promptInput'); if(pi) pi.textContent='';
      typedBuffer='';
    }
  }
  scrollToBottom(true);
}

function formatTime(date){
  if(!date) return '—';
  const d=new Date(date);
  const dateStr=d.toLocaleDateString('pl-PL');
  const timeStr=d.toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'});
  return dateStr+'\n'+timeStr;
}

/* Kolejka renderu */
async function processRenderQueue(){
  if(isRendering||renderQueue.length===0)return;
  isRendering=true;
  while(renderQueue.length>0){
    const msg=renderQueue.shift();
    await ddm(msg);
  }
  isRendering=false;
  scrollToBottom(true);
}

/* ChatId */
function cci(e1,e2){
  return [String(e1).toLowerCase().trim(), String(e2).toLowerCase().trim()].sort().join('_')
}

/* Wyślij (z promptu) */
window.sm = async function(){
  ensureChatScaffold();
  const pi=document.getElementById('promptInput');
  const msg=(typedBuffer||'').trim();
  const imgs=document.querySelectorAll('#imagePreviewContainer .ii img');
  if(!msg && imgs.length===0) return;
  if(!sc){showToast('Blad','Wybierz rozmowce','error');return}
  shouldAutoScroll=true;
  try{
    const ci=cci(cu.email,sc);
    if(msg){
      const encryptedMsg=await ec(msg);
      await d.collection('messages').add({
        chatId:ci, sender:cu.email, text:encryptedMsg,
        timestamp:firebase.firestore.FieldValue.serverTimestamp(),
        readAt:null, readBy:null
      })
    }
    for(let i=0;i<imgs.length;i++){
      await d.collection('messages').add({
        chatId:ci, sender:cu.email, image:imgs[i].src,
        timestamp:firebase.firestore.FieldValue.serverTimestamp(),
        readAt:null, readBy:null
      })
    }
    typedBuffer=''; if(pi) pi.textContent='';
    const container=document.getElementById('imagePreviewContainer'); if(container) container.innerHTML='';
    scrollToBottom(true);
  }catch(error){ showToast('Blad','Blad wysylania','error') }
};

/* Presence i lista użytkowników */
async function suo(io){ if(!cu)return; try{const ur=d.collection('users').doc(cu.uid);await ur.set({email:cu.email,isOnline:io,lastSeen:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})}catch(e){} }
function lu(){
  const ur=d.collection('users');
  allUsersListener=ur.onSnapshot(function(sn){
    const onlineUsers=[]; const offlineUsers=[];
    sn.forEach(function(dc){
      const dt=dc.data();
      if(dt.email!==cu.email){
        const item={email:dt.email,isOnline:dt.isOnline||false,lastSeen:dt.lastSeen,textColor:dt.textColor||DEFAULT_USER_COLOR};
        userColors[item.email]=item.textColor;
        if(item.isOnline)onlineUsers.push(item); else offlineUsers.push(item)
      }else{
        if(dt.textColor){ document.documentElement.style.setProperty('--my-chat-color', dt.textColor); const sel=document.getElementById('textColorSelect'); if(sel) sel.value=dt.textColor; }
      }
    });
    document.getElementById('onlineCount').textContent=onlineUsers.length;
    document.getElementById('offlineCount').textContent=offlineUsers.length;

    const ulOnline=document.getElementById('ulOnline'); ulOnline.innerHTML='';
    if(onlineUsers.length===0){ ulOnline.innerHTML='<div style="text-align:center;color:var(--term-fg-dim);font-size:12px;padding:10px">Brak uzytkownikow online</div>' }
    else{
      onlineUsers.forEach(function(user){
        const dv=document.createElement('div'); dv.className='g'; dv.setAttribute('data-email',user.email);
        dv.onclick=function(){su(user.email,user.isOnline)};
        const badgeHtml=unread[user.email]>0?'<span class="user-unread-badge">'+(unread[user.email]>9?'9+':unread[user.email])+'</span>':'';
        dv.innerHTML='<div class="h" style="color:'+user.textColor+'">&gt;&gt; '+escapeHtml(user.email.split('@')[0])+badgeHtml+'</div><div class="i">[ ONLINE ]</div>';
        ulOnline.appendChild(dv)
      })
    }
    const ulOffline=document.getElementById('ulOffline'); ulOffline.innerHTML='';
    if(offlineUsers.length===0){ ulOffline.innerHTML='<div style="text-align:center;color:var(--term-fg-dim);font-size:12px;padding:10px">Wszyscy online!</div>' }
    else{
      offlineUsers.forEach(function(user){
        const dv=document.createElement('div'); dv.className='g'; dv.setAttribute('data-email',user.email);
        dv.onclick=function(){su(user.email,user.isOnline)};
        let lastSeenText='Dawno temu';
        if(user.lastSeen){
          const dts=user.lastSeen.toDate(); const now=new Date();
          const diffMs=now-dts; const diffMins=Math.floor(diffMs/60000);
          if(diffMins<1)lastSeenText='Przed chwila';
          else if(diffMins<60)lastSeenText=diffMins+' min temu';
          else if(diffMins<1440)lastSeenText=Math.floor(diffMins/60)+' godz. temu';
          else lastSeenText=Math.floor(diffMins/1440)+' dni temu'
        }
        const badgeHtml=unread[user.email]>0?'<span class="user-unread-badge">'+(unread[user.email]>9?'9+':unread[user.email])+'</span>':'';
        dv.innerHTML='<div class="h" style="color:'+user.textColor+'">&gt;&gt; '+escapeHtml(user.email.split('@')[0])+badgeHtml+'</div><div class="i">[ '+escapeHtml(lastSeenText)+' ]</div>';
        ulOffline.appendChild(dv)
      })
    }
    uur()
  });
  countUnreadMessages();
}

/* Auth state */
if (a && typeof a.onAuthStateChanged === 'function') {
a.onAuthStateChanged(async function(u){
  if(u){
    cu=u;
    document.getElementById('calcScreen').classList.add('p');
    document.getElementById('lf').classList.add('p');
    document.getElementById('ma').classList.remove('p');

    document.getElementById('up').textContent=u.email;
    await suo(true);
    // kolor użytkownika
    try{
      const me=await d.collection('users').doc(u.uid).get();
      let color=DEFAULT_USER_COLOR;
      if(me.exists && me.data().textColor){ color=me.data().textColor; }
      else { await d.collection('users').doc(u.uid).set({ textColor: color }, { merge:true }); }
      document.documentElement.style.setProperty('--my-chat-color', color);
      const sel=document.getElementById('textColorSelect'); if(sel) sel.value=color;
    }catch(e){}

    ensureChatScaffold(true);
    lu();
    rn();
    ht=setInterval(function(){suo(true)},30000);
    window.addEventListener('beforeunload',function(){suo(false)})
  }else{
    cu=null;
    document.getElementById('ma').classList.add('p');
    document.getElementById('lf').classList.add('p');
    document.getElementById('calcScreen').classList.remove('p');
    if(ht){clearInterval(ht);ht=null}
    if(um){um();um=null}
    if(allUsersListener){allUsersListener();allUsersListener=null}
  }
});
}

/* Zmiana widoczności */
document.addEventListener('click',function(e){
  if(!e.target.closest('.dd')&&!e.target.closest('.ee')){
    const ep=document.getElementById('ep');if(ep&&es){ep.classList.add('p');es=false}
  }
});
document.addEventListener('visibilitychange',function(){
  if(cu){
    if(document.hidden){ suo(false) }
    else { suo(true); if(sc){ markAllAsRead() } }
  }
});

/* Ładowanie wiadomości (zachowuje tabelę – nie usuwa scaffoldu) */
async function lm(oue){
  if(um)um();
  messageIds.clear(); unreadMessageIds.clear(); renderQueue=[]; isRendering=false; shouldAutoScroll=true; isFirstSnapshot=true;
  ensureChatScaffold(true);
  const ci=cci(cu.email,oue);
  const mr=d.collection('messages'); const q=mr.where('chatId','==',ci);
  um=q.onSnapshot(function(sn){
    const changes=sn.docChanges();
    if(isFirstSnapshot){
      const arr=[];
      changes.forEach(function(change){
        if(change.type==='added'){
          const dt=change.doc.data(); dt.id=change.doc.id; messageIds.add(dt.id);
          if(dt.sender===oue && !dt.readBy){ unreadMessageIds.add(dt.id); }
          arr.push(dt);
        }
      });
      if(arr.length>0){
        arr.sort(function(a,b){
          if(!a.timestamp||!b.timestamp)return 0;
          return a.timestamp.toDate()-b.timestamp.toDate()
        });
        renderQueue=arr;
        processRenderQueue();
        setTimeout(markAllAsRead,500);
      }
      isFirstSnapshot=false;
      scrollToBottom(true);
    }else{
      changes.forEach(function(change){
        if(change.type==='added'){
          const dt=change.doc.data(); dt.id=change.doc.id;
          if(!messageIds.has(dt.id)){
            messageIds.add(dt.id);
            renderQueue.push(dt);
            processRenderQueue();
            if(dt.sender===sc){ setTimeout(markAllAsRead,300); }
          }
        }else if(change.type==='modified'){
          const dt=change.doc.data(); dt.id=change.doc.id;
          updateMessageReadStatus(dt.id,dt);
        }else if(change.type==='removed'){
          const row=document.querySelector('.chat-row[data-msg-id="'+change.doc.id+'"]');
          if(row)row.remove();
          messageIds.delete(change.doc.id); unreadMessageIds.delete(change.doc.id);
        }
      });
    }
  });
}

function updateMessageReadStatus(messageId,data){
  const row=document.querySelector('.chat-row[data-msg-id="'+messageId+'"]');
  if(!row)return;
  if(data.sender!==cu.email)return; // tylko dla moich wiadomości pokazuj READ
  const readCell=row.querySelector('.cell.read');
  if(!readCell)return;
  if(data.readAt&&data.readBy){
    readCell.innerHTML=formatTime(data.readAt.toDate())+'';
  }else{
    readCell.textContent='—';
  }
}

/* Rysuj wiersz wiadomości w tabeli */
async function ddm(dt){
  ensureChatScaffold();
  const body=document.getElementById('chatBody');
  if(!body) return;
  if(document.querySelector('.chat-row[data-msg-id="'+dt.id+'"]')) return;

  const row=document.createElement('div');
  row.className='chat-row';
  row.setAttribute('data-msg-id',dt.id);

  // READ (tylko dla moich wiadomości sensownie pokazuje datę)
  const readCell=document.createElement('div');
  readCell.className='cell read';
  if(dt.sender=== (cu?cu.email:'' ) && dt.readAt){
    readCell.textContent=formatTime(dt.readAt.toDate());
  }else{
    readCell.textContent='—';
  }

  // SENT
  const sentCell=document.createElement('div');
  sentCell.className='cell sent';
  sentCell.textContent=dt.timestamp?formatTime(dt.timestamp.toDate()):'Teraz';

  // MSG
  const msgCell=document.createElement('div');
  msgCell.className='cell msg';

  const isOwn = dt.sender === (cu?cu.email:'');
  const senderColor = isOwn ? getMyColor() : (userColors[dt.sender] || DEFAULT_USER_COLOR);
  const senderName = isOwn ? (cu?cu.email.split('@')[0]:'ja') : dt.sender.split('@')[0];

  let inner = '<div class="msg-line"><b style="color:'+senderColor+'">'+escapeHtml(senderName)+':</b> ';
  if(dt.image){
    inner += '<br><img src="'+dt.image+'" class="img-in-msg" onclick="oi(\''+dt.image+'\')">';
  }else{
    const dct=await dc(dt.text||'');
    inner += '<span class="msg-text">'+escapeHtml(dct)+'</span>';
  }
  inner += '</div>';

  msgCell.innerHTML = inner;

  // Wstaw do BODY (przed wierszem preview/prompt)
  body.appendChild(row);
  row.appendChild(readCell);
  row.appendChild(sentCell);
  row.appendChild(msgCell);

  scrollToBottom(true);
}

/* Kolor czcionki użytkownika */
function getMyColor(){
  const val=getComputedStyle(document.documentElement).getPropertyValue('--my-chat-color').trim();
  return val || DEFAULT_USER_COLOR;
}
window.updateTextColor = async function(colorCode){
  try{
    if(!cu)return;
    if(!COLOR_OPTIONS.includes(colorCode)) colorCode = DEFAULT_USER_COLOR;
    document.documentElement.style.setProperty('--my-chat-color', colorCode);
    await d.collection('users').doc(cu.uid).set({ textColor: colorCode }, { merge:true });
    showToast('OK','Kolor zaktualizowany','success');
    // prompt na żywo
    const pi=document.getElementById('promptInput'); if(pi){ pi.style.color=colorCode; }
  }catch(e){
    showToast('Blad','Nie udalo sie zapisac koloru','error');
  }
};

/* Auth resume audio po 1-szym kliknięciu */
document.addEventListener('click', () => {
  if (audioContext && audioContext.state === 'suspended') audioContext.resume();
}, { once: true });
</script>
</body>
</html>