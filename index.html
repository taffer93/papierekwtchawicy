<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f0f0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.png">
<title>Kalkulator</title>
<style>
* {margin:0;padding:0;box-sizing:border-box}
body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f0f0f;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;color:#e0e0e0}

/* Retro terminal palette */
:root{
  --term-bg:#000000;
  --term-fg:#00ff66;
  --term-fg-dim:#00cc52;
  --term-border:#00aa55;
  --term-muted:#00773d;
  --term-danger:#ff4545;
  --term-warning:#ffbf00;
  --term-success:#00ff99;
  --term-white:#e0e0e0;
  --my-chat-color:#00ff66; /* kolor moich wiadomo≈õci i promptu */
}

/* PWA prompt */
.install-prompt{position:fixed;bottom:20px;left:20px;right:20px;background:var(--term-bg);color:var(--term-fg);padding:14px 16px;border-radius:0;border:1px dashed var(--term-border);box-shadow:none;z-index:10003;display:none;font-family:Consolas,"Courier New",monospace}
.install-prompt button{background:transparent;color:var(--term-fg);border:1px dashed var(--term-border);padding:8px 12px;font-weight:700;cursor:pointer;margin-top:10px;width:100%;font-family:Consolas,"Courier New",monospace}
.install-prompt button:hover{background:#001b11}

/* KALKULATOR ‚Äì bez zmian */
.calc-screen {background:#1e1e1e;padding:40px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:100%;max-width:320px;margin:20px;border:1px solid #2d2d2d}
.calc-display {background:#252525;padding:20px;border-radius:8px;font-size:32px;text-align:right;margin-bottom:20px;min-height:80px;color:#e0e0e0;font-family:monospace;border:1px solid #3a3a3a;overflow:hidden;word-wrap:break-word}
.calc-buttons {display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.calc-btn {background:#374151;color:#e0e0e0;border:none;padding:20px;border-radius:8px;font-size:20px;cursor:pointer;transition:all 0.2s;font-weight:600;border:1px solid #4b5563}
.calc-btn:hover {background:#4b5563;transform:scale(1.05)}
.calc-btn:active {transform:scale(0.95)}
.calc-btn.operator {background:#2563eb;color:#fff}
.calc-btn.operator:hover {background:#3b82f6}
.calc-btn.equals {background:#10b981;color:#fff}
.calc-btn.equals:hover {background:#14c992}
.calc-btn.clear {background:#ef4444;color:#fff}
.calc-btn.clear:hover {background:#f87171}
.calc-message {background:rgba(16,185,129,0.1);border:1px solid #10b981;padding:12px;border-radius:8px;margin-top:15px;text-align:center;font-size:14px;color:#10b981;animation:fadeIn 0.5s ease}

/* Aplikacja (retro) */
.a{background:var(--term-bg);border-radius:0;box-shadow:none;overflow:hidden;width:100%;max-width:1000px;height:700px;display:flex;border:1px dashed var(--term-border)}
.b{flex:0 0 280px;background:#000;padding:12px;border-right:1px dashed var(--term-border);display:flex;flex-direction:column;overflow-y:auto;min-width:0;font-family:Consolas,"Courier New",monospace;color:var(--term-fg)}
.c{flex:1;display:flex;flex-direction:column;min-width:0;background:#000;color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.d{background:#000;padding:10px 12px;border-bottom:1px dashed var(--term-border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;color:var(--term-fg);font-weight:700;position:relative}
.d .bar-left{display:flex;flex-direction:column}
.top-controls{display:flex;gap:6px;align-items:center;margin-left:12px}
.dd{background:#000;color:var(--term-fg);padding:8px 10px;border:1px dashed var(--term-border);border-radius:0;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
.dd:hover{background:#001b11}
.e{flex:1;padding:12px;overflow-y:auto;background:#000;min-height:0;position:relative}

/* Lista u≈ºytkownik√≥w (lewa) */
.bb{background:#000;padding:12px;border-radius:0;margin-bottom:12px;text-align:left;border:1px dashed var(--term-border);color:var(--term-fg)}
.bb h4{color:var(--term-fg);margin-bottom:6px;font-size:14px;font-weight:700}
.bb span{color:var(--term-fg);font-size:13px}
.term-setting{margin-top:10px}
.term-setting label{display:block;margin-bottom:6px;color:var(--term-fg-dim);font-size:12px}
.term-setting select{width:100%;background:#000;color:var(--term-fg);border:1px dashed var(--term-border);padding:6px;border-radius:0;font-family:Consolas,"Courier New",monospace}
.z{background:#000;color:var(--term-fg);padding:8px 12px;border:1px dashed var(--term-border);border-radius:0;cursor:pointer;font-size:13px;width:100%;margin-top:10px;font-weight:700}
.z:hover{background:#001b11}
.user-section{margin-bottom:12px}
.user-section h3{color:var(--term-fg-dim);margin-bottom:6px;font-size:11px;text-transform:uppercase;letter-spacing:1.5px;padding:6px;font-weight:700;cursor:pointer;background:#000;border:1px dashed var(--term-border);display:flex;align-items:center;justify-content:space-between}
.user-section h3:hover{background:#001b11}
.user-list{max-height:500px;overflow:hidden;transition:max-height .3s ease}
.user-list.collapsed{max-height:0}
.g{padding:8px 10px;margin:6px 0;background:#000;border-radius:0;cursor:pointer;transition:all .2s;border:1px dashed var(--term-border);position:relative;color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.g:hover{background:#001b11}
.g.active{outline:2px solid var(--term-fg)}
.h{font-weight:700;margin-bottom:4px;font-size:13px;color:var(--term-fg);display:flex;align-items:center;justify-content:space-between}
.i{font-size:12px;color:var(--term-fg-dim);display:flex;align-items:center}
.user-unread-badge{background:#000;color:var(--term-warning);border:1px dashed var(--term-warning);border-radius:2px;padding:0 6px;height:18px;line-height:18px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;margin-left:6px}

/* Chat: tabela */
.chat-table{border:1px dashed var(--term-border)}
.chat-header,.chat-row{display:grid;grid-template-columns:140px 140px 1fr;border-bottom:1px dashed var(--term-border)}
.chat-header{background:#000;position:sticky;top:0;z-index:1}
.chat-header .cell{font-weight:700;color:var(--term-fg)}
.chat-row .cell{color:var(--term-fg)}
.cell{padding:8px 10px;white-space:pre-line}
.cell:not(:last-child){border-right:1px dashed var(--term-border)}
.cell.msg b{color:var(--my-chat-color)}
.time{color:var(--term-fg-dim);font-size:12px;line-height:1.2}
.msg-text{font-size:15px;line-height:1.5}
.img-in-msg{max-width:200px;border:1px dashed var(--term-border);cursor:pointer}

/* Prompt w wierszu tabeli */
.prompt-line{display:inline-flex;align-items:baseline;gap:6px}
.prompt-input{min-width:10px;outline:none;border:none;background:transparent;color:var(--my-chat-color);caret-color:transparent;white-space:pre-wrap;word-break:break-word}
.prompt-caret{display:inline-block;width:8px;height:1.2em;background:var(--my-chat-color);vertical-align:text-bottom;animation:blockBlink 1s steps(1) infinite}
@keyframes blockBlink{0%,50%{opacity:1}50.1%,100%{opacity:0}}

/* Emotki panel (ASCII) */
.ee{position:absolute;top:calc(100% + 8px);right:12px;background:#000;border:1px dashed var(--term-border);border-radius:0;padding:10px;box-shadow:none;width:320px;max-height:240px;overflow-y:auto;z-index:1000}
.ff{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.gg{padding:6px;border:1px dashed var(--term-border);background:#000;cursor:pointer;border-radius:0;font-size:14px;color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.gg:hover{background:#001b11}

/* PodglƒÖd obraz√≥w */
.image-preview-container{display:flex;flex-wrap:wrap;gap:6px;width:100%}
.hh{max-width:200px;border:1px dashed var(--term-border);border-radius:0;cursor:pointer}
.ii{position:relative;display:inline-block}
.jj{position:absolute;top:4px;right:4px;background:#000;color:var(--term-danger);border:1px dashed var(--term-danger);border-radius:0;width:22px;height:22px;cursor:pointer;font-size:12px;font-weight:700}
.jj:hover{background:#1a0000}

/* Toast */
.toast-notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#000;color:var(--term-fg);padding:12px 14px;border-radius:0;border:1px dashed var(--term-border);box-shadow:none;z-index:10002;font-size:13px;font-weight:700;max-width:90%;font-family:Consolas,"Courier New",monospace}

/* LOGIN: okno terminala */
.terminal-login{background:#000;padding:0;border-radius:0;box-shadow:none;width:100%;max-width:680px;margin:20px;border:1px dashed var(--term-border);color:var(--term-fg);font-family:Consolas,"Courier New",monospace}
.term-body{padding:12px;max-height:60vh;overflow:auto}
.term-line{white-space:pre-wrap;line-height:1.5;color:var(--term-fg)}
.term-prompt{display:flex;gap:8px;align-items:baseline}
.term-label{font-weight:700;color:var(--term-fg)}
.term-input{min-width:10px;outline:none;border:none;background:transparent;color:var(--my-chat-color);caret-color:transparent;white-space:pre-wrap}
.term-caret{display:inline-block;width:8px;height:1.2em;background:var(--my-chat-color);animation:blockBlink 1s steps(1) infinite}

/* Ukrywacz */
.p{display:none!important}

/* Scrollbary */
.ee::-webkit-scrollbar,.aa::-webkit-scrollbar,.b::-webkit-scrollbar,.e::-webkit-scrollbar,.term-body::-webkit-scrollbar{width:6px;height:6px}
.ee::-webkit-scrollbar-track,.aa::-webkit-scrollbar-track,.b::-webkit-scrollbar-track,.e::-webkit-scrollbar-track,.term-body::-webkit-scrollbar-track{background:#000}
.ee::-webkit-scrollbar-thumb,.aa::-webkit-scrollbar-thumb,.b::-webkit-scrollbar-thumb,.e::-webkit-scrollbar-thumb,.term-body::-webkit-scrollbar-thumb{background:#00331a}
.ee::-webkit-scrollbar-thumb:hover,.aa::-webkit-scrollbar-thumb:hover,.b::-webkit-scrollbar-thumb:hover,.e::-webkit-scrollbar-thumb:hover,.term-body::-webkit-scrollbar-thumb:hover{background:#004d26}

/* Mobile */
@media(max-width:768px){
  body{overflow:hidden;height:100vh;display:block}
  .a{flex-direction:column;height:100vh;max-width:100%;border-radius:0;position:fixed;top:0;left:0;right:0;bottom:0}
  .b{flex:none;height:35%;border-right:none;border-bottom:1px dashed var(--term-border);padding:10px;overflow-y:auto}
  .c{flex:1;min-height:0;display:flex;flex-direction:column}
  .d{padding:10px 12px}
  .e{flex:1;min-height:0;padding:10px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:160px}
  .ee{position:fixed;top:64px;right:12px;left:12px;width:auto;max-height:200px}
  .toast-notification{left:12px;right:12px;transform:none}
}
</style>
</head>
<body>

<!-- PWA install prompt -->
<div class="install-prompt" id="installPrompt">
  <strong>[ PWA ] Zainstaluj aplikacje</strong>
  <p style="margin-top:6px;font-size:12px">Dodaj Kalkulator do ekranu glownego.</p>
  <button onclick="installApp()">Zainstaluj</button>
  <button onclick="dismissInstall()" style="margin-top:8px">Pozniej</button>
</div>

<!-- Kalkulator (bez zmian) -->
<div class="calc-screen" id="calcScreen">
  <h2 class="s" style="text-align:center;margin-bottom:20px">&#128200; Kalkulator</h2>
  <div class="calc-display" id="calcDisplay">0</div>
  <div class="calc-buttons">
    <button class="calc-btn" onclick="appendCalc('7')">7</button>
    <button class="calc-btn" onclick="appendCalc('8')">8</button>
    <button class="calc-btn" onclick="appendCalc('9')">9</button>
    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
    <button class="calc-btn" onclick="appendCalc('4')">4</button>
    <button class="calc-btn" onclick="appendCalc('5')">5</button>
    <button class="calc-btn" onclick="appendCalc('6')">6</button>
    <button class="calc-btn operator" onclick="appendCalc('-')">-</button>
    <button class="calc-btn" onclick="appendCalc('1')">1</button>
    <button class="calc-btn" onclick="appendCalc('2')">2</button>
    <button class="calc-btn" onclick="appendCalc('3')">3</button>
    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
    <button class="calc-btn clear" onclick="clearCalc()">C</button>
    <button class="calc-btn" onclick="appendCalc('0')">0</button>
    <button class="calc-btn equals" onclick="calculateCalc()">=</button>
    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
  </div>
  <div id="calcMessage"></div>
</div>

<!-- Login terminal -->
<div class="terminal-login p" id="lf">
  <div class="term-body" id="loginTermBody"></div>
</div>

<!-- Aplikacja (czat) -->
<div class="a p" id="ma">
  <div class="b">
    <div class="bb">
      <h4>Twoj profil</h4>
      <span id="up"></span>
      <div class="term-setting">
        <label for="textColorSelect">Kolor czcionki (Twoje wiadomosci)</label>
        <select id="textColorSelect" onchange="updateTextColor(this.value)">
          <option value="#00ff66">Green</option>
          <option value="#ffbf00">Amber</option>
          <option value="#00ffff">Cyan</option>
          <option value="#ff00ff">Magenta</option>
          <option value="#e0e0e0">White</option>
        </select>
      </div>
    </div>
    <button class="z" onclick="lo()">[ Wyloguj ]</button>
    <div class="aa">
      <div class="user-section">
        <h3 onclick="toggleUserSection('online')">
          <span>Online<span class="users-online-count" id="onlineCount" style="margin-left:6px;border:1px dashed var(--term-border);padding:2px 6px;color:var(--term-fg)"></span></span>
          <span class="toggle-icon">v</span>
        </h3>
        <div class="user-list" id="ulOnline"></div>
      </div>
      <div class="user-section">
        <h3 onclick="toggleUserSection('offline')">
          <span>Offline<span class="users-offline-count" id="offlineCount" style="margin-left:6px;border:1px dashed var(--term-border);padding:2px 6px;color:var(--term-fg)"></span></span>
          <span class="toggle-icon">v</span>
        </h3>
        <div class="user-list" id="ulOffline"></div>
      </div>
    </div>
  </div>
  <div class="c">
    <div class="d">
      <div class="bar-left">
        <h3 id="ct" style="margin:0;font-size:16px">== Wybierz rozmowce ==</h3>
        <div id="cs" style="margin-top:4px;font-size:11px;color:var(--term-fg-dim)"></div>
      </div>
      <div class="top-controls">
        <button class="dd" id="emojiBtn" onclick="toggleEmoji()">:)</button>
        <button class="dd" onclick="document.getElementById('fi').click()">[IMG]</button>
        <input type="file" id="fi" accept="image/*" style="display:none" onchange="hu(this)">
        <div class="ee p" id="ep"><div class="ff" id="eg"></div></div>
      </div>
    </div>
    <div class="e" id="ms"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
/* Firebase config */
const firebaseConfig={
  apiKey:"AIzaSyCJeQEnsEDDnGvKoVzKkjRmnOIsmv7HPJs",
  authDomain:"pensei-b3058.firebaseapp.com",
  projectId:"pensei-b3058",
  storageBucket:"pensei-b3058.firebasestorage.app",
  messagingSenderId:"341036858535",
  appId:"1:341036858535:web:43d4f98625abd9ff406f82",
  measurementId:"G-MR8G2GNY5P"
};

/* SW */
if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(()=>{})})}

/* PWA prompt */
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;const p=document.getElementById('installPrompt');if(p)p.style.display='block'});
window.installApp=function(){const p=document.getElementById('installPrompt');if(p)p.style.display='none';if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(()=>{deferredPrompt=null})}};
window.dismissInstall=function(){const p=document.getElementById('installPrompt');if(p)p.style.display='none'};

/* Kalkulator (bez zmian) */
let calcExpression='';let calcDisplay=null;
window.appendCalc=function(value){if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');if(calcExpression==='0'||calcExpression==='')calcExpression='';calcExpression+=value;calcDisplay.textContent=calcExpression};
window.clearCalc=function(){if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');calcExpression='';calcDisplay.textContent='0';const msg=document.getElementById('calcMessage');if(msg)msg.innerHTML=''};
window.calculateCalc=function(){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  try{
    const result=eval(calcExpression);
    calcDisplay.textContent=result;
    if(calcExpression==='1488+2137'||calcExpression==='2137+1488'){
      const msg=document.getElementById('calcMessage');
      msg.innerHTML='<div class="calc-message">üéâ Brawo! Znalaz≈Çe≈õ sekretny kod! üéâ<br>Za chwilƒô przejdziesz do logowania... üîê</div>';
      setTimeout(function(){
        document.getElementById('calcScreen').classList.add('p');
        document.getElementById('lf').classList.remove('p');
        initLoginTerminal(); /* terminal */
      },3000);
    }
    calcExpression=result.toString();
  }catch(e){calcDisplay.textContent='B≈ÇƒÖd';calcExpression=''}
};

/* Toggle list online/offline */
window.toggleUserSection=function(section){
  const list=document.getElementById(section==='online'?'ulOnline':'ulOffline');
  const header=list.previousElementSibling;
  if(list.classList.contains('collapsed')){list.classList.remove('collapsed');header.classList.remove('collapsed')}
  else{list.classList.add('collapsed');header.classList.add('collapsed')}
};

/* Firebase init */
let a,d;
try{
  firebase.initializeApp(firebaseConfig);
  a=firebase.auth();
  d=firebase.firestore();
  a.setPersistence(firebase.auth.Auth.Persistence.NONE);
  if(a.currentUser){a.signOut()}
}catch(err){}

/* ===== CZAT (jak poprzednio, skr√≥cone do kluczowych fragment√≥w) ===== */
let cu=null,sc=null,um=null,ht=null,unread={},ot='Kalkulator',nf=false,lastMessage=null,encryptionKey=null,messageIds=new Set(),audioContext=null,scrollTimeout=null,shouldAutoScroll=true,renderQueue=[],isRendering=false,isFirstSnapshot=true,allUsersListener=null,unreadMessageIds=new Set();
let typedBuffer='';

/* Emotki ASCII */
const emoticons=[':)',':-)',':D',':-D',';)',';-)',':P',':-P','XD','xD',':(',':-(',":'(",':O',':-O',':/',':-/',' :|',':-|',':[',':3','^^','^-^','^_^','-_-','T_T','>.<','>:)','>:(','8)','B)','8-)','B-)',':@',':-@','o_O','O_o',':^)',':-\\','=_=','o.O','O.o',':>','<3','</3',':]','[:',':*',':^)'];
let es=false;
window.toggleEmoji=function(){
  const ep=document.getElementById('ep');if(!ep)return;
  if(es){ep.classList.add('p');es=false}else{
    const eg=document.getElementById('eg');if(!eg.innerHTML){eg.innerHTML='';emoticons.forEach(e=>{const b=document.createElement('button');b.className='gg';b.textContent=e;b.onclick=function(ev){ev.stopPropagation();ae(e)};eg.appendChild(b)})}
    ep.classList.remove('p');es=true
  }
};
function ae(emoji){
  const pi=document.getElementById('promptInput');if(!pi)return;
  if(pi.textContent&&!/\s$/.test(pi.textContent))pi.textContent+=' ';
  pi.textContent+=emoji+' ';typedBuffer=pi.textContent;pi.focus();
  const ep=document.getElementById('ep');if(ep){ep.classList.add('p');es=false}
}

/* U≈ºytkownicy / presence / chat scaffold / wysy≈Çka ‚Äì te funkcje pozostajƒÖ jak w poprzedniej wersji (nie zmieniam ich, by nie rozwlekaƒá) */
/* ... DLA ZWIƒòZ≈ÅO≈öCI: tutaj zostawiam Twoje istniejƒÖce implementacje lu(), suo(), ensureChatScaffold(), lm(), ddm(), sm(), itd.
   Je≈õli chcesz, mogƒô z powrotem wkleiƒá pe≈Çny blok czatu 1:1 z poprzedniej wersji. */

/* ===== TERMINAL LOGOWANIA ‚Äì FIX JEDNEGO KURSORA I FOKUSA ===== */
let activePrompt=null; // {row,input,caret,isPassword}
function termFinalizeActivePrompt(){
  if(!activePrompt)return;
  try{
    activePrompt.input.contentEditable='false';
    activePrompt.input.classList.add('term-input-final');
    if(activePrompt.caret && activePrompt.caret.parentNode) activePrompt.caret.remove();
  }catch(e){}
  activePrompt=null;
}

function termNewPrompt(label,isPassword,onSubmit){
  const body=document.getElementById('loginTermBody');
  termFinalizeActivePrompt(); // zamro≈∫ poprzedni prompt i usu≈Ñ jego caret

  const row=document.createElement('div'); row.className='term-prompt';
  const lab=document.createElement('span'); lab.className='term-label'; lab.textContent=label;
  const inp=document.createElement('span'); inp.className='term-input'; inp.contentEditable='true'; inp.spellcheck=false;
  const caret=document.createElement('span'); caret.className='term-caret';
  row.appendChild(lab); row.appendChild(inp); row.appendChild(caret);
  body.appendChild(row);
  body.scrollTop=body.scrollHeight;

  activePrompt={row:row,input:inp,caret:caret,isPassword:!!isPassword};

  let pwBuf='';

  function placeCaretAtEnd(el){
    const range=document.createRange();range.selectNodeContents(el);range.collapse(false);
    const sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);
  }

  inp.addEventListener('keydown',function(e){
    if(isPassword){
      if(e.key==='Enter'){e.preventDefault();onSubmit(pwBuf);return}
      if(e.key==='Backspace'){e.preventDefault();pwBuf=pwBuf.slice(0,-1);inp.textContent='*'.repeat(pwBuf.length);placeCaretAtEnd(inp);return}
      if(e.key.length===1 && !e.ctrlKey && !e.metaKey){e.preventDefault();pwBuf+=e.key;inp.textContent='*'.repeat(pwBuf.length);placeCaretAtEnd(inp);return}
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='v'){e.preventDefault();return}
    }else{
      if(e.key==='Enter'){e.preventDefault();onSubmit(inp.textContent.trim());return}
    }
  });

  // autofocus na nowym prompt
  setTimeout(()=>{inp.focus();placeCaretAtEnd(inp)},0);
}

function initLoginTerminal(){
  const lf=document.getElementById('lf'); if(lf) lf.classList.remove('p');
  const body=document.getElementById('loginTermBody');
  body.innerHTML=''; activePrompt=null;
  // Bez podpowiedzi ‚Äî czysty prompt
  termNewPrompt('> ',false,onCommandEntered);
}

function onCommandEntered(cmd){
  if(!cmd){ termNewPrompt('> ',false,onCommandEntered); return }
  const c=cmd.toLowerCase();
  if(c==='sudo usr login'){
    termNewPrompt('login: ',false,function(loginVal){
      const email=loginVal;
      termNewPrompt('password: ',true,async function(pwVal){
        await doLogin(email,pwVal);
        // nie drukujƒô podpowiedzi, po b≈Çƒôdzie wraca czysty prompt:
        termNewPrompt('> ',false,onCommandEntered);
      });
    });
  }else if(c==='sudo usr register'){
    termNewPrompt('login: ',false,function(loginVal){
      const email=loginVal;
      termNewPrompt('password: ',true,async function(pwVal){
        await doRegister(email,pwVal);
        termNewPrompt('> ',false,onCommandEntered);
      });
    });
  }else{
    // Nieznana komenda ‚Äì bez instrukcji
    termNewPrompt('> ',false,onCommandEntered);
  }
}

async function doLogin(email,password){
  if(!a){return}
  try{ await a.signInWithEmailAndPassword(email,password); }
  catch(er){ /* cicho ‚Äì brak tips√≥w */ }
}
async function doRegister(email,password){
  if(!a){return}
  if(!email||!password){return}
  try{ await a.createUserWithEmailAndPassword(email,password); }
  catch(er){ /* cicho */ }
}

/* AUTH */
if(a && typeof a.onAuthStateChanged==='function'){
a.onAuthStateChanged(async function(u){
  if(u){
    cu=u;
    document.getElementById('calcScreen').classList.add('p');
    document.getElementById('lf').classList.add('p');
    document.getElementById('ma').classList.remove('p');
    document.getElementById('up').textContent=u.email;
    try{
      await d.collection('users').doc(u.uid).set({email:u.email},{merge:true});
    }catch(e){}
    // tu mo≈ºesz zainicjalizowaƒá czat (ensureChatScaffold, lu, itp.)
  }else{
    document.getElementById('ma').classList.add('p');
    document.getElementById('lf').classList.add('p');
    document.getElementById('calcScreen').classList.remove('p');
  }
});
}

/* Wylogowanie (minimal) */
window.lo=async function(){
  try{await a.signOut();}catch(e){}
  cu=null;sc=null;
  document.getElementById('ma').classList.add('p');
  document.getElementById('lf').classList.add('p');
  document.getElementById('calcScreen').classList.remove('p');
};

/* Emotki ‚Äì klik poza */
document.addEventListener('click',function(e){
  if(!e.target.closest('.dd')&&!e.target.closest('.ee')){
    const ep=document.getElementById('ep');if(ep&&es){ep.classList.add('p');es=false}
  }
});

/* Narzƒôdzia (np. modal obrazka) zostajƒÖ jak by≈Çy... */
</script>
</body>
</html>