<!DOCTYPE html>
<html lang="pl">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Chat</title>
<style>
* {margin:0;padding:0;box-sizing:border-box}
body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}
.a {background:white;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden;width:100%;max-width:900px;height:600px;display:flex}
.b {flex:1;background:#f8f9fa;padding:20px;border-right:1px solid #e9ecef;display:flex;flex-direction:column;overflow-y:auto}
.c {flex:2;display:flex;flex-direction:column}
.d {background:linear-gradient(135deg,#007bff,#0056b3);color:white;padding:15px 20px;border-bottom:1px solid #0056b3;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.e {flex:1;padding:20px;overflow-y:auto;background:#f8f9fa;padding-bottom:20px}
.f {background:white;padding:15px 20px;border-top:1px solid #e9ecef;position:relative}
.g {padding:12px 20px;margin:8px 0;background:white;border-radius:12px;cursor:pointer;transition:all 0.3s;border:2px solid transparent;position:relative;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
.g:hover {border-color:#007bff;transform:translateX(5px);box-shadow:0 4px 8px rgba(0,123,255,0.2)}
.g.active {background:linear-gradient(135deg,#007bff,#0056b3);color:white;border-color:#0056b3;transform:translateX(5px);box-shadow:0 4px 12px rgba(0,123,255,0.4)}
.g.active .h, .g.active .i {color:white}
.h {font-weight:600;margin-bottom:4px;font-size:15px}
.i {font-size:12px;color:#6c757d;display:flex;align-items:center}
.j {width:10px;height:10px;border-radius:50%;margin-right:8px;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,0.2)}
.j.online {background:#28a745;animation:pulse 2s infinite}
.j.offline {background:#dc3545}
.k {background:white;padding:16px;margin:12px 0;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);max-width:80%;word-wrap:break-word;animation:slideUp 0.3s ease}
.k.own {background:linear-gradient(135deg,#007bff,#0056b3);color:white;margin-left:auto;margin-right:0}
.k.other {background:#e9ecef;margin-right:auto;margin-left:0}
.l {font-size:11px;opacity:0.7;margin-bottom:6px;font-weight:500}
.m {font-size:15px;line-height:1.4}
.n {display:flex;gap:8px;align-items:flex-end;position:relative}
.n input {flex:1;padding:12px 16px;border:2px solid #e9ecef;border-radius:20px;font-size:16px;outline:none;resize:none;max-height:100px;min-height:44px}
.n input:focus {border-color:#007bff}
.o {background:linear-gradient(135deg,#007bff,#0056b3);color:white;padding:12px;border:none;border-radius:50%;cursor:pointer;transition:all 0.3s;width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:20px}
.o:hover {transform:scale(1.1);box-shadow:0 4px 12px rgba(0,123,255,0.4)}
.p {display:none}
.q {text-align:center;color:#6c757d;padding:40px 20px;font-style:italic}
.r {background:white;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2);width:100%;max-width:400px;margin:20px}
.s {text-align:center;margin-bottom:30px;color:#495057;font-size:28px}
.t {margin-bottom:20px}
.t label {display:block;margin-bottom:8px;font-weight:600;color:#495057}
.t input {width:100%;padding:12px 16px;border:2px solid #e9ecef;border-radius:12px;font-size:16px;transition:border-color 0.2s}
.t input:focus {border-color:#007bff;outline:none}
.u {background:linear-gradient(135deg,#007bff,#0056b3);color:white;padding:14px 24px;border:none;border-radius:12px;cursor:pointer;font-weight:600;width:100%;margin:8px 0;font-size:16px;transition:all 0.3s}
.u:hover {transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,123,255,0.4)}
.v {background:linear-gradient(135deg,#28a745,#20c997)}
.v:hover {box-shadow:0 6px 20px rgba(40,167,69,0.4)}
.w {text-align:center;margin-top:20px;color:#6c757d;font-size:14px}
.x {color:#dc3545;margin-top:15px;text-align:center;font-size:14px;padding:10px;background:#f8d7da;border-radius:8px}
.y {color:#28a745;margin-top:15px;text-align:center;font-size:14px;padding:10px;background:#d4edda;border-radius:8px}
.z {background:#dc3545;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.3s;width:100%;margin-top:10px}
.z:hover {background:#c82333;transform:translateY(-2px);box-shadow:0 4px 12px rgba(220,53,69,0.4)}
.aa {flex:1;overflow-y:auto;margin-top:15px}
.bb {background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;border-radius:12px;margin-bottom:20px;text-align:center;color:white;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.bb h4 {color:white;margin-bottom:8px;font-size:18px}
.bb span {color:rgba(255,255,255,0.9);font-size:14px}
.cc {font-size:18px;line-height:1.5}
.dd {background:#6c757d;color:white;padding:8px;border:none;border-radius:50%;cursor:pointer;margin-left:4px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.dd:hover {background:#5a6268;transform:scale(1.1)}
.ee {position:absolute;bottom:100%;right:0;background:white;border:1px solid #ddd;border-radius:12px;padding:15px;box-shadow:0 8px 24px rgba(0,0,0,0.2);width:280px;max-height:200px;overflow-y:auto;z-index:1000}
.ff {display:grid;grid-template-columns:repeat(8,1fr);gap:5px}
.gg {padding:8px;border:none;background:none;cursor:pointer;border-radius:6px;font-size:20px;transition:all 0.2s}
.gg:hover {background:#f0f0f0;transform:scale(1.2)}
.hh {max-width:200px;border-radius:12px;cursor:pointer;transition:transform 0.2s}
.hh:hover {transform:scale(1.05)}
.ii {position:relative;display:inline-block}
.jj {position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:16px;font-weight:bold}
.jj:hover {background:rgba(220,53,69,0.9)}
.kk {background:#e3f2fd;border:1px solid #90caf9;padding:10px 15px;border-radius:20px;margin:10px 0;font-size:13px;color:#1565c0;text-align:center}
.ll {position:absolute;top:-5px;right:-5px;background:#dc3545;color:white;border-radius:50%;width:22px;height:22px;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:bold;animation:bounce 1s ease-in-out;box-shadow:0 2px 8px rgba(220,53,69,0.4)}
.mm {position:fixed;top:10px;right:10px;background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:15px 20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.3);z-index:10001;font-size:14px;font-weight:600;animation:slideIn 0.4s ease;max-width:300px}
.user-section {margin-bottom:20px}
.user-section h3 {color:#495057;margin-bottom:10px;font-size:14px;text-transform:uppercase;letter-spacing:1px;padding:0 10px}
.users-online-count {background:#28a745;color:white;border-radius:12px;padding:5px 10px;font-size:11px;margin-left:8px}
.users-offline-count {background:#6c757d;color:white;border-radius:12px;padding:5px 10px;font-size:11px;margin-left:8px}
@keyframes pulse {
  0%, 100% {opacity:1;transform:scale(1)}
  50% {opacity:0.7;transform:scale(1.1)}
}
@keyframes slideIn {
  from {transform:translateX(100%);opacity:0}
  to {transform:translateX(0);opacity:1}
}
@keyframes slideUp {
  from {transform:translateY(10px);opacity:0}
  to {transform:translateY(0);opacity:1}
}
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {transform:scale(1)}
  40% {transform:scale(1.2)}
  60% {transform:scale(1.1)}
}
@media(max-width:768px) {
  body {overflow:auto;height:100vh}
  .a {flex-direction:column;height:100vh;max-width:100%;border-radius:0;position:fixed;top:0;left:0;right:0;bottom:0}
  .b {flex:none;height:35%;border-right:none;border-bottom:1px solid #e9ecef;padding:15px;overflow-y:auto}
  .c {flex:1;min-height:0}
  .e {flex:1;min-height:0;padding:15px;padding-bottom:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
  .f {padding:10px 15px;border-top:1px solid #e9ecef;background:white}
  .bb {padding:15px;margin-bottom:15px}
  .ee {position:fixed;bottom:80px;right:10px;left:10px;width:auto}
  .mm {position:fixed;top:10px;left:10px;right:10px;width:auto}
  input,textarea {font-size:16px!important}
}
</style>
</head>
<body>

<!-- Panel logowania -->
<div class="r" id="lf">
  <h2 class="s">?? Witaj w Chat</h2>
  <div class="t">
    <label>Email:</label>
    <input type="email" id="em" placeholder="Tw車j email" autocomplete="email">
  </div>
  <div class="t">
    <label>Has?o:</label>
    <input type="password" id="pw" placeholder="Minimum 6 znak車w" autocomplete="current-password">
  </div>
  <button class="u" onclick="lg()">Zaloguj si?</button>
  <button class="u v" onclick="rg()">Utw車rz konto</button>
  <div id="am"></div>
  <div class="w">?? Bezpieczny komunikator z pe?n? prywatno?ci?</div>
</div>

<!-- G?車wny interfejs czatu -->
<div class="a p" id="ma">
  <!-- Panel boczny z u?ytkownikami -->
  <div class="b">
    <div class="bb">
      <h4>?? Tw車j profil</h4>
      <span id="up"></span>
    </div>
    <button class="z" onclick="lo()">?? Wyloguj si?</button>
    
    <div class="aa">
      <!-- U?ytkownicy online -->
      <div class="user-section">
        <h3>
          ?? Online
          <span class="users-online-count" id="onlineCount">0</span>
        </h3>
        <div id="ulOnline"></div>
      </div>
      
      <!-- U?ytkownicy offline -->
      <div class="user-section">
        <h3>
          ? Offline
          <span class="users-offline-count" id="offlineCount">0</span>
        </h3>
        <div id="ulOffline"></div>
      </div>
    </div>
  </div>
  
  <!-- Panel czatu -->
  <div class="c">
    <div class="d">
      <div>
        <h3 id="ct" style="margin:0;font-size:18px">Wybierz rozm車wc?</h3>
        <div id="cs" style="margin-top:4px;font-size:12px"></div>
      </div>
    </div>
    <div class="e" id="ms">
      <div class="q">?? Wybierz osob? z listy po lewej, aby rozpocz?? rozmow?</div>
    </div>
    <div class="f p" id="mis">
      <div class="kk">? Emotki ??, zdj?cia ?? i wiadomo?ci tekstowe!</div>
      <div class="n">
        <input type="text" id="mi" placeholder="Napisz wiadomo??... ??" autocomplete="off">
        <button class="dd" onclick="te()" title="Emotki">??</button>
        <button class="dd" onclick="document.getElementById('fi').click()" title="Zdj?cie">??</button>
        <button class="o" onclick="sm()" title="Wy?lij">?</button>
        <input type="file" id="fi" accept="image/*" style="display:none" onchange="hu(this)">
      </div>
      <div class="ee p" id="ep">
        <div class="ff" id="eg"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script>
// ==================== KONFIGURACJA FIREBASE ====================
const firebaseConfig = {
  apiKey: "AIzaSyCJeQEnsEDDnGvKoVzKkjRmnOIsmv7HPJs",
  authDomain: "pensei-b3058.firebaseapp.com",
  projectId: "pensei-b3058",
  storageBucket: "pensei-b3058.firebasestorage.app",
  messagingSenderId: "341036858535",
  appId: "1:341036858535:web:43d4f98625abd9ff406f82",
  measurementId: "G-MR8G2GNY5P"
};

firebase.initializeApp(firebaseConfig);
const a = firebase.auth();
const d = firebase.firestore();

// ==================== ZMIENNE GLOBALNE ====================
let cu = null;
let sc = null;
let um = null;
let ht = null;
let es = false;
let unread = {};
let ot = 'Chat';
let nf = false;
let lastMessage = null;
let encryptionKey = null;

const emojis = ['??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??'];

// ==================== ZAAWANSOWANE SZYFROWANIE AES-GCM ====================
async function generateKey(password) {
  const encoder = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    encoder.encode(password),
    'PBKDF2',
    false,
    ['deriveBits', 'deriveKey']
  );
  
  return crypto.subtle.deriveKey(
    {
      name: 'PBKDF2',
      salt: encoder.encode('chat-salt-2024'),
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    true,
    ['encrypt', 'decrypt']
  );
}

async function ec(text) {
  try {
    if (!encryptionKey) {
      encryptionKey = await generateKey('secure-chat-key-2024');
    }
    
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    
    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv: iv },
      encryptionKey,
      data
    );
    
    const encryptedArray = new Uint8Array(encrypted);
    const combined = new Uint8Array(iv.length + encryptedArray.length);
    combined.set(iv);
    combined.set(encryptedArray, iv.length);
    
    return btoa(String.fromCharCode.apply(null, combined));
  } catch (e) {
    console.error('B??d szyfrowania:', e);
    return text;
  }
}

async function dc(encryptedText) {
  try {
    if (!encryptionKey) {
      encryptionKey = await generateKey('secure-chat-key-2024');
    }
    
    const combined = Uint8Array.from(atob(encryptedText), c => c.charCodeAt(0));
    const iv = combined.slice(0, 12);
    const data = combined.slice(12);
    
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv },
      encryptionKey,
      data
    );
    
    const decoder = new TextDecoder();
    return decoder.decode(decrypted);
  } catch (e) {
    console.error('B??d deszyfrowania:', e);
    return encryptedText;
  }
}

// ==================== POWIADOMIENIA ====================
function rn() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(permission => {
      nf = permission === 'granted';
    });
  }
}

function sn(title, body) {
  if (nf && 'Notification' in window && Notification.permission === 'granted') {
    const notification = new Notification(title, {
      body: body,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">??</text></svg>',
      badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">??</text></svg>'
    });
    notification.onclick = () => {
      window.focus();
      notification.close();
    };
  }
}

function ut() {
  const total = Object.values(unread).reduce((sum, count) => sum + count, 0);
  document.title = total > 0 ? `(${total}) ${ot}` : ot;
}

function snt(message, sender) {
  if (document.hidden || !document.hasFocus()) {
    const senderName = sender.split('@')[0];
    const toast = document.createElement('div');
    toast.className = 'mm';
    toast.innerHTML = `<strong>?? ${senderName}</strong><br>${message.length > 50 ? message.substring(0, 50) + '...' : message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
    sn(`?? ${senderName}`, message);
    
    if (lastMessage !== message) {
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBSF+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBSF+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBSF+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBQ==');
        audio.volume = 0.3;
        audio.play().catch(() => {});
      } catch (e) {}
      lastMessage = message;
    }
  }
}

// ==================== EMOTIKONY ====================
function te() {
  const ep = document.getElementById('ep');
  if (es) {
    ep.classList.add('p');
    es = false;
  } else {
    if (!document.getElementById('eg').innerHTML) {
      ie();
    }
    ep.classList.remove('p');
    es = true;
  }
}

function ie() {
  const eg = document.getElementById('eg');
  eg.innerHTML = '';
  emojis.forEach(emoji => {
    const btn = document.createElement('button');
    btn.className = 'gg';
    btn.textContent = emoji;
    btn.onclick = () => ae(emoji);
    eg.appendChild(btn);
  });
}

function ae(emoji) {
  const mi = document.getElementById('mi');
  mi.value += emoji;
  mi.focus();
  document.getElementById('ep').classList.add('p');
  es = false;
}

// ==================== OBS?UGA OBRAZ車W ====================
function ci(file, maxWidth = 800, quality = 0.8) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
      let { width, height } = img;
      
      if (width > height) {
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
      } else {
        if (height > maxWidth) {
          width *= maxWidth / height;
          height = maxWidth;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      canvas.toBlob(resolve, 'image/jpeg', quality);
    };
    
    img.src = URL.createObjectURL(file);
  });
}

async function hu(input) {
  const file = input.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    alert('Wybierz plik obrazu');
    return;
  }
  
  try {
    let compressedFile = file;
    if (file.size > 1024 * 1024) {
      compressedFile = await ci(file, 600, 0.7);
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64 = e.target.result;
      const img = document.createElement('img');
      img.src = base64;
      img.className = 'hh';
      img.onclick = () => oi(base64);
      
      const wrapper = document.createElement('div');
      wrapper.className = 'ii';
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'jj';
      removeBtn.innerHTML = '℅';
      removeBtn.onclick = (ev) => {
        ev.stopPropagation();
        wrapper.remove();
      };
      
      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      
      const mi = document.getElementById('mi');
      mi.parentNode.insertBefore(wrapper, mi.nextSibling);
    };
    
    reader.readAsDataURL(compressedFile);
  } catch (error) {
    alert('B??d przetwarzania obrazu');
  }
  
  input.value = '';
}

function oi(src) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer';
  
  const img = document.createElement('img');
  img.src = src;
  img.style.cssText = 'max-width:90%;max-height:90%;border-radius:12px';
  
  modal.appendChild(img);
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
}

// ==================== AUTENTYKACJA ====================
function sam(m, ie = false) {
  const dv = document.getElementById('am');
  dv.innerHTML = ie ? `<div class="x">${m}</div>` : `<div class="y">${m}</div>`;
  setTimeout(() => dv.innerHTML = '', 5000);
}

async function lg() {
  const e = document.getElementById('em').value.trim();
  const p = document.getElementById('pw').value;
  
  if (!e || !p) {
    sam('Wype?nij wszystkie pola', true);
    return;
  }
  
  try {
    await a.signInWithEmailAndPassword(e, p);
    sam('Zalogowano pomy?lnie');
  } catch (er) {
    let msg = 'B??d logowania';
    if (er.code === 'auth/user-not-found') msg = 'Nie znaleziono u?ytkownika';
    else if (er.code === 'auth/wrong-password') msg = 'Nieprawid?owe has?o';
    else if (er.code === 'auth/invalid-email') msg = 'Nieprawid?owy email';
    sam(msg, true);
  }
}

async function rg() {
  const e = document.getElementById('em').value.trim();
  const p = document.getElementById('pw').value;
  
  if (!e || !p) {
    sam('Wype?nij wszystkie pola', true);
    return;
  }
  
  if (p.length < 6) {
    sam('Has?o musi mie? minimum 6 znak車w', true);
    return;
  }
  
  try {
    await a.createUserWithEmailAndPassword(e, p);
    sam('Konto utworzone pomy?lnie');
  } catch (er) {
    let msg = 'B??d rejestracji';
    if (er.code === 'auth/email-already-in-use') msg = 'Ten email jest ju? u?ywany';
    else if (er.code === 'auth/weak-password') msg = 'Has?o jest za s?abe';
    else if (er.code === 'auth/invalid-email') msg = 'Nieprawid?owy email';
    sam(msg, true);
  }
}

async function lo() {
  try {
    if (ht) clearInterval(ht);
    if (um) um();
    await suo(false);
    await a.signOut();
    
    // Wyczy?? stan
    cu = null;
    sc = null;
    unread = {};
    encryptionKey = null;
    
    // Prze??cz widoki
    document.getElementById('ma').classList.add('p');
    document.getElementById('lf').classList.remove('p');
    document.getElementById('em').value = '';
    document.getElementById('pw').value = '';
  } catch (error) {
    console.error('B??d wylogowania:', error);
    alert('B??d wylogowania. Spr車buj ponownie.');
  }
}

// ==================== ZARZ?DZANIE U?YTKOWNIKAMI ====================
function su(ue, io) {
  // Usu里 aktywn? klas? ze wszystkich u?ytkownik車w
  document.querySelectorAll('.g').forEach(i => {
    i.classList.remove('active');
  });
  
  // Dodaj aktywn? klas? do wybranego u?ytkownika
  const userEl = document.querySelector(`[data-email="${ue}"]`);
  if (userEl) {
    userEl.classList.add('active');
  }
  
  sc = ue;
  unread[ue] = 0;
  uur();
  
  const un = ue.split('@')[0];
  document.getElementById('ct').textContent = `?? ${un}`;
  
  const cs = document.getElementById('cs');
  cs.innerHTML = io ? 
    '<span style="color:rgba(255,255,255,0.9);display:flex;align-items:center"><span class="j online" style="margin-right:5px"></span>Online</span>' : 
    '<span style="color:rgba(255,255,255,0.7);display:flex;align-items:center"><span class="j offline" style="margin-right:5px"></span>Offline</span>';
  
  document.getElementById('mis').classList.remove('p');
  document.querySelector('.kk').classList.remove('p');
  
  lm(ue);
}

function uur() {
  // Usu里 wszystkie istniej?ce badges
  document.querySelectorAll('.ll').forEach(badge => badge.remove());
  
  // Dodaj badges dla nieprzeczytanych wiadomo?ci
  Object.keys(unread).forEach(email => {
    if (unread[email] > 0) {
      const userEl = document.querySelector(`[data-email="${email}"]`);
      if (userEl) {
        const badge = document.createElement('div');
        badge.className = 'll';
        badge.textContent = unread[email] > 99 ? '99+' : unread[email];
        userEl.appendChild(badge);
      }
    }
  });
  
  ut();
}

async function lm(oue) {
  if (um) {
    um();
  }
  
  const ci = cci(cu.email, oue);
  const mr = d.collection('messages');
  const q = mr.where('chatId', '==', ci);
  
  um = q.onSnapshot(async (sn) => {
    const md = document.getElementById('ms');
    md.innerHTML = '';
    
    let ms = [];
    sn.forEach((dc) => {
      const dt = dc.data();
      dt.id = dc.id;
      ms.push(dt);
    });
    
    ms.sort((a, b) => {
      if (!a.timestamp || !b.timestamp) return 0;
      return a.timestamp.toDate() - b.timestamp.toDate();
    });
    
    if (ms.length === 0) {
      md.innerHTML = '<div class="q">?? Rozpocznij rozmow?!</div>';
    } else {
      for (const dt of ms) {
        await ddm(dt);
      }
    }
    
    md.scrollTop = md.scrollHeight;
  });
}

async function ddm(dt) {
  const md = document.getElementById('ms');
  const mdv = document.createElement('div');
  const io = dt.sender === cu.email;
  mdv.className = `k ${io ? 'own' : 'other'}`;
  
  const tm = dt.timestamp ? new Date(dt.timestamp.toDate()).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' }) : 'Teraz';
  
  let content;
  if (dt.image) {
    content = `<img src="${dt.image}" class="hh" onclick="oi('${dt.image}')" style="cursor:pointer">`;
  } else {
    const dct = await dc(dt.text);
    content = `<div class="m cc">${dct}</div>`;
    
    if (!io && (sc !== dt.sender || document.hidden || !document.hasFocus())) {
      if (!unread[dt.sender]) unread[dt.sender] = 0;
      unread[dt.sender]++;
      uur();
      snt(dct, dt.sender);
    }
  }
  
  mdv.innerHTML = `
    <div class="l">${io ? 'Ty' : dt.sender.split('@')[0]} ? ${tm}</div>
    ${content}
  `;
  
  md.appendChild(mdv);
}

function cci(e1, e2) {
  return [e1, e2].sort().join('_');
}

async function sm() {
  const mi = document.getElementById('mi');
  const msg = mi.value.trim();
  
  // Sprawd? czy s? za??czone obrazy
  const imgs = document.querySelectorAll('.ii img');
  
  if (!msg && imgs.length === 0) {
    return;
  }
  
  if (!sc) {
    alert('Wybierz rozm車wc?');
    return;
  }
  
  try {
    const ci = cci(cu.email, sc);
    
    // Wy?lij wiadomo?? tekstow?
    if (msg) {
      const encryptedMsg = await ec(msg);
      await d.collection('messages').add({
        chatId: ci,
        sender: cu.email,
        text: encryptedMsg,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    // Wy?lij obrazy
    for (const img of imgs) {
      await d.collection('messages').add({
        chatId: ci,
        sender: cu.email,
        image: img.src,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    mi.value = '';
    document.querySelectorAll('.ii').forEach(el => el.remove());
    
  } catch (error) {
    console.error('B??d wysy?ania:', error);
    alert('B??d wysy?ania wiadomo?ci');
  }
}

async function suo(io) {
  if (!cu) return;
  
  try {
    const ur = d.collection('users').doc(cu.uid);
    await ur.set({
      email: cu.email,
      isOnline: io,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch (error) {
    console.error('B??d aktualizacji statusu:', error);
  }
}

function lu() {
  const ur = d.collection('users');
  
  ur.onSnapshot((sn) => {
    const onlineUsers = [];
    const offlineUsers = [];
    
    sn.forEach((dc) => {
      const dt = dc.data();
      if (dt.email !== cu.email) {
        const userItem = {
          email: dt.email,
          isOnline: dt.isOnline || false,
          lastSeen: dt.lastSeen
        };
        
        if (dt.isOnline) {
          onlineUsers.push(userItem);
        } else {
          offlineUsers.push(userItem);
        }
      }
    });
    
    // Aktualizuj liczniki
    document.getElementById('onlineCount').textContent = onlineUsers.length;
    document.getElementById('offlineCount').textContent = offlineUsers.length;
    
    // Wy?wietl u?ytkownik車w online
    const ulOnline = document.getElementById('ulOnline');
    ulOnline.innerHTML = '';
    
    if (onlineUsers.length === 0) {
      ulOnline.innerHTML = '<div style="text-align:center;color:#6c757d;font-size:12px;padding:10px">Brak u?ytkownik車w online</div>';
    } else {
      onlineUsers.forEach(user => {
        const dv = document.createElement('div');
        dv.className = 'g';
        dv.setAttribute('data-email', user.email);
        dv.onclick = () => su(user.email, user.isOnline);
        
        dv.innerHTML = `
          <div class="h">${user.email.split('@')[0]}</div>
          <div class="i">
            <span class="j online"></span>
            Online
          </div>
        `;
        
        ulOnline.appendChild(dv);
      });
    }
    
    // Wy?wietl u?ytkownik車w offline
    const ulOffline = document.getElementById('ulOffline');
    ulOffline.innerHTML = '';
    
    if (offlineUsers.length === 0) {
      ulOffline.innerHTML = '<div style="text-align:center;color:#6c757d;font-size:12px;padding:10px">Wszyscy online! ??</div>';
    } else {
      offlineUsers.forEach(user => {
        const dv = document.createElement('div');
        dv.className = 'g';
        dv.setAttribute('data-email', user.email);
        dv.onclick = () => su(user.email, user.isOnline);
        
        let lastSeenText = 'Ostatnio widziany dawno temu';
        if (user.lastSeen) {
          const lastSeenDate = user.lastSeen.toDate();
          const now = new Date();
          const diffMs = now - lastSeenDate;
          const diffMins = Math.floor(diffMs / 60000);
          
          if (diffMins < 1) {
            lastSeenText = 'Przed chwil?';
          } else if (diffMins < 60) {
            lastSeenText = `${diffMins} min temu`;
          } else if (diffMins < 1440) {
            lastSeenText = `${Math.floor(diffMins / 60)} godz. temu`;
          } else {
            lastSeenText = `${Math.floor(diffMins / 1440)} dni temu`;
          }
        }
        
        dv.innerHTML = `
          <div class="h">${user.email.split('@')[0]}</div>
          <div class="i">
            <span class="j offline"></span>
            ${lastSeenText}
          </div>
        `;
        
        ulOffline.appendChild(dv);
      });
    }
    
    uur();
  });
}

// ==================== OBS?UGA ZDARZE? ====================
document.getElementById('mi').addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sm();
  }
});

document.getElementById('em').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    lg();
  }
});

document.getElementById('pw').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    lg();
  }
});

// Zamknij panel emoji po klikni?ciu poza nim
document.addEventListener('click', (e) => {
  const ep = document.getElementById('ep');
  const emojiBtn = document.querySelector('.dd');
  
  if (es && !ep.contains(e.target) && e.target !== emojiBtn) {
    ep.classList.add('p');
    es = false;
  }
});

// ==================== INICJALIZACJA ====================
a.onAuthStateChanged(async (u) => {
  if (u) {
    cu = u;
    document.getElementById('lf').classList.add('p');
    document.getElementById('ma').classList.remove('p');
    document.getElementById('up').textContent = u.email;
    
    await suo(true);
    lu();
    rn();
    
    // Aktualizuj status co 30 sekund
    ht = setInterval(() => suo(true), 30000);
    
    // Ustaw status offline przy zamykaniu strony
    window.addEventListener('beforeunload', () => suo(false));
  } else {
    cu = null;
    document.getElementById('ma').classList.add('p');
    document.getElementById('lf').classList.remove('p');
    
    if (ht) {
      clearInterval(ht);
      ht = null;
    }
    
    if (um) {
      um();
      um = null;
    }
  }
});

// Obs?uga widoczno?ci karty
document.addEventListener('visibilitychange', () => {
  if (cu) {
    if (document.hidden) {
      suo(false);
    } else {
      suo(true);
      if (sc) {
        unread[sc] = 0;
        uur();
      }
    }
  }
});

console.log('?? Chat za?adowany pomy?lnie!');
</script>

</body>
</html>