<!DOCTYPE html><html lang="pl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Chat</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Emoji','Apple Color Emoji','Segoe UI Emoji',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}.a{background:white;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden;width:100%;max-width:900px;height:600px;display:flex}.b{flex:1;background:#f8f9fa;padding:20px;border-right:1px solid #e9ecef;display:flex;flex-direction:column}.c{flex:2;display:flex;flex-direction:column}.d{background:white;padding:15px 20px;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center}.e{flex:1;padding:20px;overflow-y:auto;background:#f8f9fa;padding-bottom:120px}.f{background:white;padding:15px 20px;border-top:1px solid #e9ecef;position:relative}.g{padding:12px 20px;margin:8px 0;background:white;border-radius:12px;cursor:pointer;transition:all 0.2s;border:2px solid transparent;position:relative}.g:hover{border-color:#007bff;transform:translateY(-1px)}.g.active{background:#007bff;color:white;border-color:#0056b3}.h{font-weight:600;margin-bottom:4px}.i{font-size:12px;color:#6c757d;display:flex;align-items:center}.j{width:8px;height:8px;border-radius:50%;margin-right:6px}.j.online{background:#28a745}.j.offline{background:#dc3545}.k{background:white;padding:16px;margin:12px 0;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);max-width:80%;word-wrap:break-word}.k.own{background:linear-gradient(135deg,#007bff,#0056b3);color:white;margin-left:auto;margin-right:0}.k.other{background:#e9ecef;margin-right:auto;margin-left:0}.l{font-size:11px;opacity:0.7;margin-bottom:6px;font-weight:500}.m{font-size:15px;line-height:1.4}.n{display:flex;gap:8px;align-items:flex-end;position:relative}.n input{flex:1;padding:12px 16px;border:2px solid #e9ecef;border-radius:20px;font-size:16px;outline:none;resize:none;max-height:100px;min-height:44px}.n input:focus{border-color:#007bff}.o{background:linear-gradient(135deg,#007bff,#0056b3);color:white;padding:12px;border:none;border-radius:50%;cursor:pointer;transition:transform 0.2s;width:44px;height:44px;display:flex;align-items:center;justify-content:center}.o:hover{transform:scale(1.05)}.p{display:none}.q{text-align:center;color:#6c757d;padding:40px 20px;font-style:italic}.r{background:white;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);width:100%;max-width:400px;margin:20px}.s{text-align:center;margin-bottom:30px;color:#495057}.t{margin-bottom:20px}.t label{display:block;margin-bottom:8px;font-weight:600;color:#495057}.t input{width:100%;padding:12px 16px;border:2px solid #e9ecef;border-radius:12px;font-size:16px;transition:border-color 0.2s}.t input:focus{border-color:#007bff;outline:none}.u{background:linear-gradient(135deg,#007bff,#0056b3);color:white;padding:12px 24px;border:none;border-radius:12px;cursor:pointer;font-weight:600;width:100%;margin:8px 0;font-size:16px;transition:transform 0.2s}.u:hover{transform:translateY(-1px)}.v{background:linear-gradient(135deg,#28a745,#20c997)}.w{text-align:center;margin-top:20px;color:#6c757d}.w a{color:#007bff;text-decoration:none;font-weight:600}.x{color:#dc3545;margin-top:15px;text-align:center;font-size:14px}.y{color:#28a745;margin-top:15px;text-align:center;font-size:14px}.z{background:#6c757d;color:white;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:background 0.2s}.z:hover{background:#5a6268}.aa{flex:1;overflow-y:auto}.bb{background:#f8f9fa;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center}.bb h4{color:#495057;margin-bottom:8px}.bb span{color:#6c757d;font-size:14px}.cc{font-size:18px;line-height:1.5}.dd{background:#6c757d;color:white;padding:8px;border:none;border-radius:50%;cursor:pointer;margin-left:4px;width:36px;height:36px;display:flex;align-items:center;justify-content:center}.ee{position:absolute;bottom:100%;right:0;background:white;border:1px solid #ddd;border-radius:12px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.15);width:280px;max-height:200px;overflow-y:auto;z-index:1000}.ff{display:grid;grid-template-columns:repeat(8,1fr);gap:5px}.gg{padding:8px;border:none;background:none;cursor:pointer;border-radius:6px;font-size:20px;transition:background 0.2s}.gg:hover{background:#f0f0f0}.hh{max-width:200px;border-radius:12px;cursor:pointer}.ii{position:relative;display:inline-block}.jj{position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:12px}.kk{background:#e3f2fd;border:1px solid #90caf9;padding:8px 12px;border-radius:20px;margin:5px 0;font-size:13px;color:#1565c0;text-align:center}.ll{position:absolute;top:-5px;right:-5px;background:#dc3545;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;display:flex;align-items:center;justify-content:center;font-weight:bold}.mm{position:fixed;top:10px;right:10px;background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10001;font-size:14px;font-weight:600;animation:slideIn 0.3s ease}.nn{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid #e9ecef;padding:10px 15px;z-index:1000}@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}@keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-3px)}60%{transform:translateY(-2px)}}@media(max-width:768px){body{overflow:auto;height:100vh}.a{flex-direction:column;height:100vh;max-width:100%;border-radius:0;position:fixed;top:0;left:0;right:0;bottom:0}.b{flex:none;height:35%;border-right:none;border-bottom:1px solid #e9ecef;padding:15px;overflow-y:auto}.c{flex:1;min-height:0;padding-bottom:80px}.e{flex:1;min-height:0;padding:15px;padding-bottom:120px;overflow-y:auto;-webkit-overflow-scrolling:touch}.f{position:fixed;bottom:0;left:0;right:0;padding:10px 15px;border-top:1px solid #e9ecef;background:white;z-index:1000}.bb{padding:10px;margin-bottom:10px}.ee{position:fixed;bottom:80px;right:10px;left:10px;width:auto}.mm{position:fixed;top:10px;left:10px;right:10px;width:auto}input,textarea{font-size:16px!important;transform:none!important}}</style></head><body><div class="r" id="lf"><h2 class="s">?? Witaj w Chat</h2><div class="t"><label>Email:</label><input type="email" id="em" placeholder="Tw車j email"></div><div class="t"><label>Has?o:</label><input type="password" id="pw" placeholder="Minimum 6 znak車w"></div><button class="u" onclick="lg()">Zaloguj si?</button><button class="u v" onclick="rg()">Utw車rz konto</button><div id="am"></div><div class="w">Bezpieczny komunikator z pe?n? prywatno?ci?</div></div><div class="a p" id="ma"><div class="b"><div class="bb"><h4>?? Tw車j profil</h4><span id="up"></span><button class="z" onclick="lo()" style="margin-top:10px">?? Wyloguj</button></div><div class="aa"><h3 style="margin-bottom:15px;color:#495057">?? U?ytkownicy</h3><div id="ul"></div></div></div><div class="c"><div class="d"><h3 id="ct" style="color:#495057">Wybierz rozm車wc?</h3><div id="cs"></div></div><div class="e" id="ms"><div class="q">?? Wybierz osob? z listy po lewej, aby rozpocz?? rozmow?</div></div><div class="f" id="mis"><div class="kk p">?? Emotki ??, zdj?cia ?? i wiadomo?ci tekstowe!</div><div class="n"><input type="text" id="mi" placeholder="Napisz wiadomo??... ??"><button class="dd" onclick="te()" title="Emotki">??</button><button class="dd" onclick="document.getElementById('fi').click()" title="Zdj?cie">??</button><button class="o" onclick="sm()" title="Wy?lij">??</button><input type="file" id="fi" accept="image/*" style="display:none" onchange="hu(this)"></div><div class="ee p" id="ep"><div class="ff" id="eg"></div></div></div></div></div><script>let a,d,cu=null,sc=null,um=null,hui=null,ht=null,es=false,unread={},ot='Chat',nf=false,lastMessage=null;const emojis=['??','??','??','??','??','??','??','??','??','??','??','??','??','??','?','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??','??'];function rn(){if('Notification'in window&&Notification.permission==='default'){Notification.requestPermission().then(permission=>{nf=permission==='granted'})}}function sn(title,body,icon='??'){if(nf&&'Notification'in window&&Notification.permission==='granted'){const notification=new Notification(title,{body:body,icon:icon,badge:icon});notification.onclick=()=>{window.focus();notification.close()}}}function ut(){const total=Object.values(unread).reduce((sum,count)=>sum+count,0);document.title=total>0?`(${total}) ${ot}`:ot}function snt(message,sender){if(document.hidden||!document.hasFocus()){const senderName=sender.split('@')[0];const toast=document.createElement('div');toast.className='mm';toast.innerHTML=`<strong>${senderName}</strong><br>${message.length>50?message.substring(0,50)+'...':message}`;document.body.appendChild(toast);setTimeout(()=>toast.remove(),4000);sn(`?? ${senderName}`,message);if(lastMessage!==message){try{const audio=new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBSF+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBSF+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBSF+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBTyA0fLKdSsEKG/A7+GNQQ0PVKvh8blwHAU2jdXzzn0vBSl+zPLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfBQ==');audio.volume=0.3;audio.play().catch(()=>{})}catch(e){}lastMessage=message}}}function ec(t){let r=t;r=r.replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c<='Z'?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26)});r=r.split('').reverse().join('');r=r.replace(/[a-zA-Z]/g,function(c){const st=c<='Z'?65:97;return String.fromCharCode(((c.charCodeAt(0)-st+5+26)%26)+st)});try{r=btoa(unescape(encodeURIComponent(r)))}catch(e){}r=r.split('').reverse().join('');r=r.replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c<='Z'?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26)});r=r.replace(/[a-zA-Z]/g,function(c){const st=c<='Z'?65:97;return String.fromCharCode(((c.charCodeAt(0)-st+7+26)%26)+st)});return r}function dc(et){let r=et;r=r.replace(/[a-zA-Z]/g,function(c){const st=c<='Z'?65:97;return String.fromCharCode(((c.charCodeAt(0)-st-7+26)%26)+st)});r=r.replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c<='Z'?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26)});r=r.split('').reverse().join('');try{r=decodeURIComponent(escape(atob(r)))}catch(e){}r=r.replace(/[a-zA-Z]/g,function(c){const st=c<='Z'?65:97;return String.fromCharCode(((c.charCodeAt(0)-st-5+26)%26)+st)});r=r.split('').reverse().join('');r=r.replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c<='Z'?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26)});return r}function te(){const ep=document.getElementById('ep');if(es){ep.classList.add('p');es=false}else{if(!document.getElementById('eg').innerHTML){ie()}ep.classList.remove('p');es=true}}function ie(){const eg=document.getElementById('eg');eg.innerHTML='';emojis.forEach(emoji=>{const btn=document.createElement('button');btn.className='gg';btn.textContent=emoji;btn.onclick=()=>ae(emoji);eg.appendChild(btn)})}function ae(emoji){const mi=document.getElementById('mi');mi.value+=emoji;mi.focus();document.getElementById('ep').classList.add('p');es=false}function ci(file,maxWidth=800,quality=0.8){return new Promise((resolve)=>{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');const img=new Image();img.onload=function(){let{width,height}=img;if(width>height){if(width>maxWidth){height*=maxWidth/width;width=maxWidth}}else{if(height>maxWidth){width*=maxWidth/height;height=maxWidth}}canvas.width=width;canvas.height=height;ctx.drawImage(img,0,0,width,height);canvas.toBlob(resolve,'image/jpeg',quality)};img.src=URL.createObjectURL(file)})}async function hu(input){const file=input.files[0];if(!file)return;if(!file.type.startsWith('image/')){alert('Wybierz plik obrazu');return}try{let compressedFile=file;if(file.size>1024*1024){compressedFile=await ci(file,600,0.7)}const reader=new FileReader();reader.onload=function(e){const base64=e.target.result;const img=document.createElement('img');img.src=base64;img.className='hh';img.onclick=()=>oi(base64);const wrapper=document.createElement('div');wrapper.className='ii';const removeBtn=document.createElement('button');removeBtn.className='jj';removeBtn.innerHTML='℅';removeBtn.onclick=(ev)=>{ev.stopPropagation();wrapper.remove()};wrapper.appendChild(img);wrapper.appendChild(removeBtn);const mi=document.getElementById('mi');mi.parentNode.insertBefore(wrapper,mi.nextSibling)};reader.readAsDataURL(compressedFile)}catch(error){alert('B??d przetwarzania obrazu')}input.value=''}function oi(src){const modal=document.createElement('div');modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer';const img=document.createElement('img');img.src=src;img.style.cssText='max-width:90%;max-height:90%;border-radius:12px';modal.appendChild(img);modal.onclick=()=>modal.remove();document.body.appendChild(modal)}function sam(m,ie=false){const dv=document.getElementById('am');dv.innerHTML=ie?`<div class="x">${m}</div>`:`<div class="y">${m}</div>`}async function lg(){const e=document.getElementById('em').value;const p=document.getElementById('pw').value;if(!e||!p){sam('Wype?nij wszystkie pola',true);return}try{await signInWithEmailAndPassword(a,e,p);sam('Zalogowano pomy?lnie')}catch(er){let msg='B??d logowania';if(er.code==='auth/user-not-found')msg='Nie znaleziono u?ytkownika';else if(er.code==='auth/wrong-password')msg='Nieprawid?owe has?o';else if(er.code==='auth/invalid-email')msg='Nieprawid?owy email';sam(msg,true)}}async function rg(){const e=document.getElementById('em').value;const p=document.getElementById('pw').value;if(!e||!p){sam('Wype?nij wszystkie pola',true);return}if(p.length<6){sam('Has?o musi mie? minimum 6 znak車w',true);return}try{await createUserWithEmailAndPassword(a,e,p);sam('Konto utworzone pomy?lnie')}catch(er){let msg='B??d rejestracji';if(er.code==='auth/email-already-in-use')msg='Ten email jest ju? u?ywany';else if(er.code==='auth/weak-password')msg='Has?o jest za s?abe';sam(msg,true)}}async function lo(){if(ht)clearInterval(ht);await suo(false);await signOut(a)}function su(ue,io){document.querySelectorAll('.g').forEach(i=>{i.classList.remove('active')});document.querySelector(`[data-email="${ue}"]`).classList.add('active');sc=ue;unread[ue]=0;uur();const un=ue.split('@')[0];document.getElementById('ct').textContent=`?? ${un}`;const cs=document.getElementById('cs');cs.innerHTML=io?'<div style="color:#28a745;font-size:12px">?? Online</div>':'<div style="color:#dc3545;font-size:12px">?? Offline</div>';document.getElementById('mis').classList.remove('p');document.querySelector('.kk').classList.remove('p');lm(ue)}function uur(){document.querySelectorAll('.ll').forEach(badge=>badge.remove());Object.keys(unread).forEach(email=>{if(unread[email]>0){const userEl=document.querySelector(`[data-email="${email}"]`);if(userEl){const badge=document.createElement('div');badge.className='ll';badge.textContent=unread[email]>99?'99+':unread[email];userEl.appendChild(badge);userEl.style.animation='bounce 1s ease-in-out'}}});ut()}function lm(oue){if(um){um()}const ci=cci(cu.email,oue);const mr=collection(d,'messages');const q=query(mr,where('chatId','==',ci));um=onSnapshot(q,(sn)=>{const md=document.getElementById('ms');md.innerHTML='';let ms=[];sn.forEach((dc)=>{const dt=dc.data();dt.id=dc.id;ms.push(dt)});ms.sort((a,b)=>{if(!a.timestamp||!b.timestamp)return 0;return a.timestamp.toDate()-b.timestamp.toDate()});if(ms.length===0){md.innerHTML='<div class="q">?? Rozpocznij rozmow?!</div>'}else{ms.forEach(dt=>ddm(dt))}md.scrollTop=md.scrollHeight})}function ddm(dt){const md=document.getElementById('ms');const mdv=document.createElement('div');const io=dt.sender===cu.email;mdv.className=`k ${io?'own':'other'}`;const tm=dt.timestamp?new Date(dt.timestamp.toDate()).toLocaleTimeString():'Teraz';let content;if(dt.image){content=`<img src="${dt.image}" class="hh" onclick="oi('${dt.image}')" style="cursor:pointer">`}else{const dct=dc(dt.text);content=`<div class="m cc">${dct}</div>`;if(!io&&(sc!==dt.sender||document.hidden||!document.hasFocus())){if(!unread[dt.sender])unread[dt.sender]=0;unread[dt.sender]++;uur();snt(dct,dt.sender)}}mdv.innerHTML=`<div class="l">${io?'Ty':dt.sender.split('@')[0]} ? ${tm}</div>${content}`;md.appendChild(mdv)}async function sm(){const i=document.getElementById('mi');const ot=i.value.trim();const imgs=document.querySelectorAll('.ii img');if(!ot&&imgs.length===0)return;const ci=cci(cu.email,sc);if(ot){const et=ec(ot);try{await addDoc(collection(d,'messages'),{chatId:ci,text:et,sender:cu.email,recipient:sc,timestamp:serverTimestamp()});i.value=''}catch(er){alert('B??d wysy?ania wiadomo?ci')}}for(let img of imgs){try{await addDoc(collection(d,'messages'),{chatId:ci,image:img.src,sender:cu.email,recipient:sc,timestamp:serverTimestamp()})}catch(er){alert('B??d wysy?ania zdj?cia')}}document.querySelectorAll('.ii').forEach(el=>el.remove())}function cci(e1,e2){return[e1,e2].sort().join('_')}function sht(){ht=setInterval(async()=>{if(cu){try{await setDoc(doc(d,'users',cu.uid),{email:cu.email,lastSeen:serverTimestamp(),online:true},{merge:true})}catch(e){}}},30000)}document.addEventListener('DOMContentLoaded',function(){const mi=document.getElementById('mi');if(mi){mi.addEventListener('keypress',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sm()}})}const pw=document.getElementById('pw');if(pw){pw.addEventListener('keypress',function(e){if(e.key==='Enter'){lg()}})}document.addEventListener('click',function(e){if(!e.target.closest('.n')&&!e.target.closest('.ee')){document.getElementById('ep').classList.add('p');es=false}});document.addEventListener('visibilitychange',function(){if(!document.hidden){Object.keys(unread).forEach(email=>{if(email===sc)unread[email]=0});uur()}});window.addEventListener('focus',function(){if(sc)unread[sc]=0;uur()});rn()})</script><script type="module">import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut}from'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';import{getFirestore,collection,addDoc,query,onSnapshot,serverTimestamp,where,doc,setDoc,deleteDoc}from'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';const fc={apiKey:"AIzaSyCJeQEnsEDDnGvKoVzKkjRmnOIsmv7HPJs",authDomain:"pensei-b3058.firebaseapp.com",projectId:"pensei-b3058",storageBucket:"pensei-b3058.firebasestorage.app",messagingSenderId:"341036858535",appId:"1:341036858535:web:43d4f98625abd9ff406f82",measurementId:"G-MR8G2GNY5P"};const ap=initializeApp(fc);a=getAuth(ap);d=getFirestore(ap);window.signInWithEmailAndPassword=signInWithEmailAndPassword;window.createUserWithEmailAndPassword=createUserWithEmailAndPassword;window.signOut=signOut;window.collection=collection;window.addDoc=addDoc;window.serverTimestamp=serverTimestamp;window.query=query;window.where=where;window.onSnapshot=onSnapshot;window.doc=doc;window.setDoc=setDoc;window.deleteDoc=deleteDoc;onAuthStateChanged(a,(u)=>{if(u){cu=u;document.getElementById('lf').classList.add('p');document.getElementById('ma').classList.remove('p');document.getElementById('up').textContent=u.email;suo(true);lu();sht()}else{cu=null;if(ht)clearInterval(ht);document.getElementById('lf').classList.remove('p');document.getElementById('ma').classList.add('p')}});async function suo(io){if(!cu)return;const ur=doc(d,'users',cu.uid);if(io){await setDoc(ur,{email:cu.email,lastSeen:serverTimestamp(),online:true})}else{await deleteDoc(ur)}}function lu(){const uq=query(collection(d,'users'));hui=onSnapshot(uq,(sn)=>{const ul=document.getElementById('ul');ul.innerHTML='';const now=new Date();sn.forEach((dc)=>{const ud=dc.data();if(ud.email!==cu.email){const lastSeen=ud.lastSeen?ud.lastSeen.toDate():null;const isOnline=ud.online&&lastSeen&&(now-lastSeen)<90000;const udv=document.createElement('div');udv.className='g';udv.dataset.email=ud.email;udv.innerHTML=`<div class="h">${ud.email.split('@')[0]}</div><div class="i"><div class="j ${isOnline?'online':'offline'}"></div>${isOnline?'Online':'Offline'}</div>`;udv.onclick=()=>su(ud.email,isOnline);ul.appendChild(udv);if(!unread[ud.email])unread[ud.email]=0}});uur()})}window.addEventListener('beforeunload',()=>{if(cu)suo(false)});window.addEventListener('focus',()=>{if(cu)suo(true)});window.addEventListener('blur',()=>{setTimeout(()=>{if(cu&&!document.hasFocus())suo(false)},5000)})</script></body></html>