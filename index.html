<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f0f0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.png">
<title>Kalkulator</title>
<style>
* {margin:0;padding:0;box-sizing:border-box}
body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f0f0f;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;color:#e0e0e0}
.install-prompt {position:fixed;bottom:20px;left:20px;right:20px;background:#2563eb;color:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:10003;display:none;animation:slideUp 0.3s ease}
.install-prompt button {background:#fff;color:#2563eb;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px;width:100%}
.calc-screen {background:#1e1e1e;padding:40px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:100%;max-width:320px;margin:20px;border:1px solid #2d2d2d}
.calc-display {background:#252525;padding:20px;border-radius:8px;font-size:32px;text-align:right;margin-bottom:20px;min-height:80px;color:#e0e0e0;font-family:monospace;border:1px solid #3a3a3a;overflow:hidden;word-wrap:break-word}
.calc-buttons {display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.calc-btn {background:#374151;color:#e0e0e0;border:none;padding:20px;border-radius:8px;font-size:20px;cursor:pointer;transition:all 0.2s;font-weight:600;border:1px solid #4b5563}
.calc-btn:hover {background:#4b5563;transform:scale(1.05)}
.calc-btn:active {transform:scale(0.95)}
.calc-btn.operator {background:#2563eb;color:#fff}
.calc-btn.operator:hover {background:#3b82f6}
.calc-btn.equals {background:#10b981;color:#fff}
.calc-btn.equals:hover {background:#14c992}
.calc-btn.clear {background:#ef4444;color:#fff}
.calc-btn.clear:hover {background:#f87171}
.calc-message {background:rgba(16,185,129,0.1);border:1px solid #10b981;padding:12px;border-radius:8px;margin-top:15px;text-align:center;font-size:14px;color:#10b981;animation:fadeIn 0.5s ease}
.a {background:#1a1a1a;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);overflow:hidden;width:100%;max-width:1000px;height:700px;display:flex;border:1px solid #2d2d2d}
.b {flex:0 0 280px;background:#161616;padding:16px;border-right:1px solid #2d2d2d;display:flex;flex-direction:column;overflow-y:auto;min-width:0}
.c {flex:1;display:flex;flex-direction:column;min-width:0;background:#1a1a1a}
.d {background:#1e1e1e;padding:16px 20px;border-bottom:1px solid #2d2d2d;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.e {flex:1;padding:20px;overflow-y:auto;background:#1a1a1a;min-height:0}
.f {background:#1e1e1e;padding:16px;border-top:1px solid #2d2d2d;flex-shrink:0;position:relative}
.g {padding:12px 16px;margin:6px 0;background:#1e1e1e;border-radius:8px;cursor:pointer;transition:all 0.2s;border:1px solid transparent;position:relative}
.g:hover {background:#252525;border-color:#3a3a3a}
.g.active {background:#2563eb;border-color:#3b82f6}
.g.active .h, .g.active .i {color:#fff}
.h {font-weight:600;margin-bottom:4px;font-size:14px;color:#e0e0e0;display:flex;align-items:center;justify-content:space-between}
.user-unread-badge {background:#ef4444;color:#fff;border-radius:50%;padding:0;width:18px;height:18px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(239,68,68,0.4)}
.i {font-size:12px;color:#888;display:flex;align-items:center}
.j {width:8px;height:8px;border-radius:50%;margin-right:8px}
.j.online {background:#10b981;box-shadow:0 0 8px #10b981}
.j.offline {background:#6b7280}
.k {background:#252525;padding:14px 16px;margin:10px 0;border-radius:12px;max-width:75%;word-wrap:break-word;position:relative}
.k.own {background:#2563eb;color:#fff;margin-left:auto;margin-right:0}
.k.other {background:#252525;margin-right:auto;margin-left:0;color:#e0e0e0}
.k.unread {background:#2a2a2a;border-left:3px solid #3b82f6}
.k:hover .delete-msg {opacity:1}
.delete-msg {position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:16px;font-weight:bold;opacity:0;transition:all 0.2s;display:flex;align-items:center;justify-content:center;z-index:10}
.delete-msg:hover {background:#ef4444;transform:scale(1.1)}
.l {font-size:10px;opacity:0.6;margin-bottom:6px;font-weight:500}
.m {font-size:15px;line-height:1.5}
.read-receipt {font-size:10px;opacity:0.6;margin-top:6px;text-align:right;font-style:italic;display:flex;align-items:center;justify-content:flex-end;gap:4px}
.read-receipt.read {color:#10b981;opacity:0.9}
.checkmark {font-size:14px}
.unread-separator {display:flex;align-items:center;margin:20px 0;color:#3b82f6;font-size:12px;font-weight:600;text-align:center}
.unread-separator::before, .unread-separator::after {content:'';flex:1;border-bottom:2px solid #3b82f6;margin:0 10px}
.unread-separator span {padding:0 10px;background:#1a1a1a}
.n {display:flex;gap:8px;align-items:center;position:relative;flex-wrap:wrap}
.n input {flex:1;padding:12px 16px;border:1px solid #3a3a3a;border-radius:24px;font-size:15px;outline:none;background:#252525;color:#e0e0e0;min-width:200px;transition:all 0.2s}
.n input:focus {border-color:#3b82f6;background:#2a2a2a}
.n input::placeholder {color:#666}
.button-group {display:flex;gap:6px;flex-shrink:0}
.o {background:#2563eb;color:#fff;padding:12px;border:none;border-radius:50%;cursor:pointer;transition:all 0.2s;width:42px;height:42px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.o:hover {background:#3b82f6;transform:scale(1.05)}
.o:active {transform:scale(0.95)}
.p {display:none!important}
.q {text-align:center;color:#666;padding:40px 20px;font-style:italic;font-size:14px}
.r {background:#1e1e1e;padding:40px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:100%;max-width:420px;margin:20px;border:1px solid #2d2d2d}
.s {text-align:center;margin-bottom:30px;color:#e0e0e0;font-size:26px;font-weight:600}
.t {margin-bottom:20px}
.t label {display:block;margin-bottom:8px;font-weight:500;color:#b0b0b0;font-size:13px}
.t input {width:100%;padding:12px 16px;border:1px solid #3a3a3a;border-radius:8px;font-size:15px;transition:all 0.2s;background:#252525;color:#e0e0e0}
.t input:focus {border-color:#3b82f6;outline:none;background:#2a2a2a}
.t input::placeholder {color:#666}
.u {background:#2563eb;color:#fff;padding:14px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;width:100%;margin:8px 0;font-size:15px;transition:all 0.2s}
.u:hover {background:#3b82f6}
.u:active {transform:scale(0.98)}
.u:disabled {background:#4a4a4a;cursor:not-allowed}
.v {background:#10b981}
.v:hover {background:#14c992}
.w {text-align:center;margin-top:20px;color:#888;font-size:13px}
.x {color:#ef4444;margin-top:15px;text-align:center;font-size:13px;padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;border:1px solid rgba(239,68,68,0.2)}
.y {color:#10b981;margin-top:15px;text-align:center;font-size:13px;padding:12px;background:rgba(16,185,129,0.1);border-radius:8px;border:1px solid rgba(16,185,129,0.2)}
.z {background:#374151;color:#e0e0e0;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:13px;transition:all 0.2s;width:100%;margin-top:12px;font-weight:500}
.z:hover {background:#4b5563}
.z:active {transform:scale(0.98)}
.aa {flex:1;overflow-y:auto;margin-top:12px}
.bb {background:#1e1e1e;padding:16px;border-radius:8px;margin-bottom:16px;text-align:center;border:1px solid #2d2d2d}
.bb h4 {color:#e0e0e0;margin-bottom:6px;font-size:15px;font-weight:600}
.bb span {color:#888;font-size:13px}
.cc {font-size:15px;line-height:1.5}
.dd {background:#374151;color:#e0e0e0;padding:8px;border:none;border-radius:50%;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
.dd:hover {background:#4b5563;transform:scale(1.05)}
.dd:active {transform:scale(0.95)}
.ee {position:absolute;bottom:calc(100% + 8px);right:0;background:#252525;border:1px solid #3a3a3a;border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,0.5);width:320px;max-height:240px;overflow-y:auto;z-index:1000}
.ff {display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
.gg {padding:10px;border:none;background:#1e1e1e;cursor:pointer;border-radius:6px;font-size:22px;transition:all 0.15s;border:1px solid transparent}
.gg:hover {background:#3a3a3a;border-color:#4a4a4a;transform:scale(1.1)}
.gg:active {transform:scale(0.95)}
.hh {max-width:200px;border-radius:8px;cursor:pointer;transition:transform 0.2s}
.hh:hover {transform:scale(1.05)}
.ii {position:relative;display:inline-block;margin:4px}
.jj {position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.8);color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.2s}
.jj:hover {background:#ef4444}
.kk {background:rgba(37,99,235,0.1);border:1px solid rgba(37,99,235,0.3);padding:10px 14px;border-radius:8px;margin:10px 0;font-size:12px;color:#60a5fa;text-align:center}
.ll {position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border-radius:50%;width:20px;height:20px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;box-shadow:0 2px 8px rgba(239,68,68,0.5)}
.mm {position:fixed;top:20px;right:20px;background:#10b981;color:#fff;padding:14px 20px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.3);z-index:10001;font-size:13px;font-weight:500;animation:slideIn 0.3s ease;max-width:320px;border:1px solid #14c992}
.user-section {margin-bottom:16px}
.user-section h3 {color:#888;margin-bottom:8px;font-size:11px;text-transform:uppercase;letter-spacing:1.5px;padding:8px;font-weight:600;cursor:pointer;background:#1e1e1e;border-radius:6px;transition:all 0.2s;display:flex;align-items:center;justify-content:space-between}
.user-section h3:hover {background:#252525}
.user-section h3 .toggle-icon {font-size:14px;transition:transform 0.3s}
.user-section h3.collapsed .toggle-icon {transform:rotate(-90deg)}
.users-online-count {background:#10b981;color:#fff;border-radius:10px;padding:3px 8px;font-size:10px;margin-left:6px;font-weight:600}
.users-offline-count {background:#6b7280;color:#fff;border-radius:10px;padding:3px 8px;font-size:10px;margin-left:6px;font-weight:600}
.user-list {max-height:500px;overflow:hidden;transition:max-height 0.3s ease}
.user-list.collapsed {max-height:0}
.image-preview-container {display:flex;flex-wrap:wrap;gap:6px;width:100%;margin-bottom:8px}
.toast-notification {position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#2563eb;color:#fff;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:10002;font-size:14px;font-weight:500;animation:toastIn 0.3s ease;max-width:90%;border:1px solid #3b82f6}
.msg-deleting {animation:fadeOut 0.3s ease;opacity:0;transform:scale(0.8)}
.ee::-webkit-scrollbar,.aa::-webkit-scrollbar,.b::-webkit-scrollbar,.e::-webkit-scrollbar{width:6px;height:6px}
.ee::-webkit-scrollbar-track,.aa::-webkit-scrollbar-track,.b::-webkit-scrollbar-track,.e::-webkit-scrollbar-track{background:#1a1a1a}
.ee::-webkit-scrollbar-thumb,.aa::-webkit-scrollbar-thumb,.b::-webkit-scrollbar-thumb,.e::-webkit-scrollbar-thumb{background:#3a3a3a;border-radius:3px}
.ee::-webkit-scrollbar-thumb:hover,.aa::-webkit-scrollbar-thumb:hover,.b::-webkit-scrollbar-thumb:hover,.e::-webkit-scrollbar-thumb:hover{background:#4a4a4a}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes toastIn{from{transform:translate(-50%,-100%);opacity:0}to{transform:translate(-50%,0);opacity:1}}
@keyframes fadeOut{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(0.8)}}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
@media(max-width:768px){body{overflow:hidden;height:100vh;display:block}.a{flex-direction:column;height:100vh;max-width:100%;border-radius:0;position:fixed;top:0;left:0;right:0;bottom:0;border:none}.b{flex:none;height:35%;border-right:none;border-bottom:1px solid #2d2d2d;padding:12px;overflow-y:auto}.c{flex:1;min-height:0;display:flex;flex-direction:column}.d{padding:12px 16px;flex-shrink:0}.d h3{font-size:15px}.d #cs{font-size:11px}.e{flex:1;min-height:0;padding:12px;padding-bottom:240px;overflow-y:auto;-webkit-overflow-scrolling:touch}.f{position:fixed;bottom:0;left:0;right:0;padding:12px;border-top:1px solid #2d2d2d;background:#1e1e1e;z-index:999;box-shadow:0 -4px 16px rgba(0,0,0,0.3)}.bb{padding:12px;margin-bottom:12px}.bb h4{font-size:14px;margin-bottom:4px}.bb span{font-size:12px}.z{padding:10px 16px;font-size:13px;margin-top:10px}.g{padding:10px 12px;margin:4px 0;border-radius:8px}.h{font-size:13px;margin-bottom:3px}.i{font-size:11px}.j{width:7px;height:7px;margin-right:6px}.user-section{margin-bottom:12px}.user-section h3{font-size:10px;margin-bottom:6px;padding:6px}.users-online-count,.users-offline-count{padding:2px 6px;font-size:9px;margin-left:4px}.aa{margin-top:8px}.n{gap:6px}.n input{min-width:140px;padding:10px 14px;font-size:15px;min-height:40px}.button-group{gap:6px}.dd{width:34px;height:34px;padding:6px;font-size:16px}.o{width:40px;height:40px;padding:10px;font-size:18px}.kk{padding:8px 12px;font-size:11px;margin:8px 0}.ii{margin:3px}.hh{max-width:100px;max-height:100px;border-radius:8px}.jj{width:20px;height:20px;font-size:13px;top:3px;right:3px}.image-preview-container{gap:4px;margin-bottom:6px}.ee{position:fixed;bottom:200px;right:12px;left:12px;width:auto;max-height:200px}.mm,.toast-notification{position:fixed;top:12px;left:12px;right:12px;width:auto;padding:12px 16px;font-size:12px;transform:none}.toast-notification{left:12px;right:12px;transform:none}.k{padding:12px 14px;margin:8px 0;max-width:80%;border-radius:12px}.k:hover .delete-msg{opacity:1}.delete-msg{opacity:0.7}.m{font-size:14px}.l{font-size:10px}.read-receipt{font-size:9px;margin-top:4px}input,textarea{font-size:15px!important}.r{padding:30px 20px;margin:12px;border-radius:12px}.s{font-size:22px;margin-bottom:24px}.t input{font-size:15px;padding:11px 14px}.u{padding:13px 20px;font-size:14px}.calc-screen{padding:30px 20px;margin:12px}.calc-display{font-size:28px;padding:16px}.calc-btn{padding:16px;font-size:18px}}
</style>
</head>
<body>

<div class="install-prompt" id="installPrompt">
  <strong>&#128242; Zainstaluj aplikacj&#281;</strong>
  <p style="margin-top:8px;font-size:13px">Dodaj Kalkulator do ekranu g&#322;&#243;wnego!</p>
  <button onclick="installApp()">Zainstaluj</button>
  <button onclick="dismissInstall()" style="background:#374151;color:#fff;margin-top:8px">P&#243;&#378;niej</button>
</div>

<div class="calc-screen" id="calcScreen">
  <h2 class="s" style="text-align:center;margin-bottom:20px">&#128200; Kalkulator</h2>
  <div class="calc-display" id="calcDisplay">0</div>
  <div class="calc-buttons">
    <button class="calc-btn" onclick="appendCalc('7')">7</button>
    <button class="calc-btn" onclick="appendCalc('8')">8</button>
    <button class="calc-btn" onclick="appendCalc('9')">9</button>
    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
    <button class="calc-btn" onclick="appendCalc('4')">4</button>
    <button class="calc-btn" onclick="appendCalc('5')">5</button>
    <button class="calc-btn" onclick="appendCalc('6')">6</button>
    <button class="calc-btn operator" onclick="appendCalc('-')">-</button>
    <button class="calc-btn" onclick="appendCalc('1')">1</button>
    <button class="calc-btn" onclick="appendCalc('2')">2</button>
    <button class="calc-btn" onclick="appendCalc('3')">3</button>
    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
    <button class="calc-btn clear" onclick="clearCalc()">C</button>
    <button class="calc-btn" onclick="appendCalc('0')">0</button>
    <button class="calc-btn equals" onclick="calculateCalc()">=</button>
    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
  </div>
  <div id="calcMessage"></div>
</div>

<div class="r p" id="lf">
  <h2 class="s">&#128172; Zaloguj siƒô</h2>
  <div class="t">
    <label>Email</label>
    <input type="email" id="em" placeholder="twoj@email.com" autocomplete="email">
  </div>
  <div class="t">
    <label>Has&#322;o</label>
    <input type="password" id="pw" placeholder="&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;" autocomplete="current-password">
  </div>
  <button class="u" id="loginBtn" onclick="lg()">Zaloguj si&#281;</button>
  <button class="u v" id="registerBtn" onclick="rg()">Utw&#243;rz konto</button>
  <div id="am"></div>
  <div class="w">&#128274; Bezpieczne po&#322;&#261;czenie</div>
  <div style="margin-top:15px;text-align:center">
    <small style="color:#666;font-size:11px">
      Status: <span id="firebaseStatus" style="color:#ef4444">&#10007; ≈Åadowanie...</span>
    </small>
  </div>
</div>

<div class="a p" id="ma">
  <div class="b">
    <div class="bb">
      <h4>Tw&#243;j profil</h4>
      <span id="up"></span>
    </div>
    <button class="z" onclick="lo()">Wyloguj</button>
    <div class="aa">
      <div class="user-section">
        <h3 onclick="toggleUserSection('online')">
          <span>Online<span class="users-online-count" id="onlineCount">0</span></span>
          <span class="toggle-icon">‚ñº</span>
        </h3>
        <div class="user-list" id="ulOnline"></div>
      </div>
      <div class="user-section">
        <h3 onclick="toggleUserSection('offline')">
          <span>Offline<span class="users-offline-count" id="offlineCount">0</span></span>
          <span class="toggle-icon">‚ñº</span>
        </h3>
        <div class="user-list" id="ulOffline"></div>
      </div>
    </div>
  </div>
  <div class="c">
    <div class="d">
      <div>
        <h3 id="ct" style="margin:0;font-size:16px;color:#e0e0e0">Wybierz rozm&#243;wc&#281;</h3>
        <div id="cs" style="margin-top:4px;font-size:11px"></div>
      </div>
    </div>
    <div class="e" id="ms">
      <div class="q">&#128172; Wybierz osob&#281; aby rozpocz&#261;&#263; rozmow&#281;</div>
    </div>
    <div class="f p" id="mis">
      <div class="kk">&#10024; Wiadomo&#347;ci, zdj&#281;cia i emotki</div>
      <div class="image-preview-container" id="imagePreviewContainer"></div>
      <div class="n">
        <input type="text" id="mi" placeholder="Wiadomo&#347;&#263;..." autocomplete="off">
        <div class="button-group">
          <button class="dd" onclick="toggleEmoji()">&#128522;</button>
          <button class="dd" onclick="document.getElementById('fi').click()">&#128247;</button>
          <button class="o" onclick="sm()">&#10148;</button>
        </div>
        <input type="file" id="fi" accept="image/*" style="display:none" onchange="hu(this)">
      </div>
      <div class="ee p" id="ep">
        <div class="ff" id="eg"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig={
  apiKey:"AIzaSyCJeQEnsEDDnGvKoVzKkjRmnOIsmv7HPJs",
  authDomain:"pensei-b3058.firebaseapp.com",
  projectId:"pensei-b3058",
  storageBucket:"pensei-b3058.firebasestorage.app",
  messagingSenderId:"341036858535",
  appId:"1:341036858535:web:43d4f98625abd9ff406f82",
  measurementId:"G-MR8G2GNY5P"
};

if('serviceWorker'in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{})
  })
}

let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  const p=document.getElementById('installPrompt');
  if(p)p.style.display='block'
});

window.installApp = function(){
  const p=document.getElementById('installPrompt');
  if(p)p.style.display='none';
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(r=>{deferredPrompt=null})
  }
};

window.dismissInstall = function(){
  const p=document.getElementById('installPrompt');
  if(p)p.style.display='none'
};

let calcExpression='';
let calcDisplay=null;

window.appendCalc = function(value){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  if(calcExpression==='0'||calcExpression==='')calcExpression='';
  calcExpression+=value;
  calcDisplay.textContent=calcExpression;
};

window.clearCalc = function(){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  calcExpression='';
  calcDisplay.textContent='0';
  const msg=document.getElementById('calcMessage');
  if(msg)msg.innerHTML='';
};

window.calculateCalc = function(){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  try{
    const result=eval(calcExpression);
    calcDisplay.textContent=result;
    
    if(calcExpression==='1488+2137'||calcExpression==='2137+1488'){
      const msg=document.getElementById('calcMessage');
      msg.innerHTML='<div class="calc-message">üéâ Brawo! Znalaz≈Çe≈õ sekretny kod! üéâ<br>Za chwilƒô przejdziesz do logowania... üîê</div>';
      
      setTimeout(function(){
        document.getElementById('calcScreen').classList.add('p');
        document.getElementById('lf').classList.remove('p');
      },3000);
    }
    
    calcExpression=result.toString();
  }catch(e){
    calcDisplay.textContent='B≈ÇƒÖd';
    calcExpression='';
  }
};

window.toggleUserSection = function(section){
  const list=document.getElementById(section==='online'?'ulOnline':'ulOffline');
  const header=list.previousElementSibling;
  
  if(list.classList.contains('collapsed')){
    list.classList.remove('collapsed');
    header.classList.remove('collapsed');
  }else{
    list.classList.add('collapsed');
    header.classList.add('collapsed');
  }
};

let a, d;

try {
  firebase.initializeApp(firebaseConfig);
  a = firebase.auth();
  d = firebase.firestore();
  
  a.setPersistence(firebase.auth.Auth.Persistence.NONE);
  
  if(a.currentUser){
    a.signOut();
  }
  
  const statusEl = document.getElementById('firebaseStatus');
  if(statusEl) {
    statusEl.innerHTML = '&#10003; Po≈ÇƒÖczono';
    statusEl.style.color = '#10b981';
  }
} catch(err) {
  const statusEl = document.getElementById('firebaseStatus');
  if(statusEl) {
    statusEl.innerHTML = '&#10007; B≈ÇƒÖd';
    statusEl.style.color = '#ef4444';
  }
}

let cu=null,sc=null,um=null,ht=null,es=false,unread={},ot='Kalkulator',nf=false,lastMessage=null,encryptionKey=null,messageIds=new Set(),audioContext=null,scrollTimeout=null,shouldAutoScroll=true,renderQueue=[],isRendering=false,isFirstSnapshot=true,allUsersListener=null,unreadMessageIds=new Set();

const emojis=['\uD83D\uDE00','\uD83D\uDE03','\uD83D\uDE04','\uD83D\uDE01','\uD83D\uDE06','\uD83D\uDE05','\uD83E\uDD23','\uD83D\uDE02','\uD83D\uDE42','\uD83D\uDE43','\uD83D\uDE09','\uD83D\uDE0A','\uD83D\uDE07','\uD83E\uDD70','\uD83D\uDE0D','\uD83E\uDD29','\uD83D\uDE18','\uD83D\uDE17','\uD83D\uDE1A','\uD83D\uDE19','\uD83E\uDD72','\uD83D\uDE0B','\uD83D\uDE1B','\uD83D\uDE1C','\uD83E\uDD2A','\uD83D\uDE1D','\uD83E\uDD11','\uD83E\uDD17','\uD83E\uDD2D','\uD83E\uDD2B','\uD83E\uDD14','\uD83E\uDD10','\uD83D\uDE10','\uD83D\uDE11','\uD83D\uDE36','\uD83D\uDE0F','\uD83D\uDE12','\uD83D\uDE44','\uD83D\uDE2C','\uD83D\uDE0C','\uD83D\uDE14','\uD83D\uDE2A','\uD83E\uDD24','\uD83D\uDE34','\uD83D\uDE37','\uD83E\uDD12','\uD83E\uDD15','\uD83E\uDD22','\uD83D\uDC4D','\uD83D\uDC4E','\uD83D\uDC4C','\u270C\uFE0F','\uD83E\uDD1E','\uD83E\uDD1F','\uD83E\uDD18','\uD83D\uDC4F','\uD83D\uDE4C','\uD83D\uDC50','\uD83E\uDD32','\uD83E\uDD1D','\uD83D\uDE4F','\u270D\uFE0F','\uD83D\uDCAA','\uD83E\uDDBE'];

function playNotificationSound(){try{if(!audioContext)audioContext=new(window.AudioContext||window.webkitAudioContext)();const now=audioContext.currentTime;const oscillator=audioContext.createOscillator();const gainNode=audioContext.createGain();oscillator.connect(gainNode);gainNode.connect(audioContext.destination);oscillator.frequency.setValueAtTime(800,now);oscillator.frequency.exponentialRampToValueAtTime(600,now+0.1);gainNode.gain.setValueAtTime(0.3,now);gainNode.gain.exponentialRampToValueAtTime(0.01,now+0.3);oscillator.start(now);oscillator.stop(now+0.3)}catch(e){}}

function showToast(title,message,type){type=type||'info';const toast=document.createElement('div');toast.className='toast-notification';if(type==='success'){toast.style.background='#10b981';toast.style.borderColor='#14c992'}else if(type==='error'){toast.style.background='#ef4444';toast.style.borderColor='#f87171'}else if(type==='message'){toast.style.background='#2563eb';toast.style.borderColor='#3b82f6'}toast.innerHTML='<strong>'+escapeHtml(title)+'</strong><br>'+escapeHtml(message);document.body.appendChild(toast);playNotificationSound();if(navigator.vibrate)navigator.vibrate([100,50,100]);setTimeout(function(){toast.style.opacity='0';toast.style.transform='translate(-50%, -100%)';setTimeout(function(){toast.remove()},300)},4000)}

function rn(){if('Notification'in window&&Notification.permission==='default'){Notification.requestPermission().then(function(permission){nf=permission==='granted';if(nf)showToast('Powiadomienia','Powiadomienia w≈ÇƒÖczone!','success')})}}

function sn(title,body){if(nf&&'Notification'in window&&Notification.permission==='granted'){try{const notification=new Notification(title,{body:body,icon:'icon.png',tag:'msg',requireInteraction:false});notification.onclick=function(){window.focus();notification.close()}}catch(e){}}}

function ut(){const total=Object.values(unread).reduce(function(sum,count){return sum+count},0);document.title=total>0?'('+total+') '+ot:ot}

function snt(message,sender){const senderName=sender.split('@')[0];const shortMsg=message.length>50?message.substring(0,50)+'...':message;showToast(senderName,shortMsg,'message');sn('\uD83D\uDCAC '+senderName,message);if(lastMessage!==message){playNotificationSound();lastMessage=message}}

async function generateKey(password){const encoder=new TextEncoder();const keyMaterial=await crypto.subtle.importKey('raw',encoder.encode(password),'PBKDF2',false,['deriveBits','deriveKey']);return crypto.subtle.deriveKey({name:'PBKDF2',salt:encoder.encode('salt-2024'),iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},true,['encrypt','decrypt'])}

async function ec(text){try{if(!encryptionKey)encryptionKey=await generateKey('key-2024');const encoder=new TextEncoder();const data=encoder.encode(text);const iv=crypto.getRandomValues(new Uint8Array(12));const encrypted=await crypto.subtle.encrypt({name:'AES-GCM',iv:iv},encryptionKey,data);const encryptedArray=new Uint8Array(encrypted);const combined=new Uint8Array(iv.length+encryptedArray.length);combined.set(iv);combined.set(encryptedArray,iv.length);return btoa(String.fromCharCode.apply(null,combined))}catch(e){return text}}

async function dc(encryptedText){try{if(!encryptionKey)encryptionKey=await generateKey('key-2024');const combined=Uint8Array.from(atob(encryptedText),function(c){return c.charCodeAt(0)});const iv=combined.slice(0,12);const data=combined.slice(12);const decrypted=await crypto.subtle.decrypt({name:'AES-GCM',iv:iv},encryptionKey,data);const decoder=new TextDecoder();return decoder.decode(decrypted)}catch(e){return encryptedText}}

function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}

function isUserAtBottom(){
  const md=document.getElementById('ms');
  if(!md)return true;
  return md.scrollHeight - md.scrollTop - md.clientHeight < 100;
}
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.png">
<title>Kalkulator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap');

* {margin:0;padding:0;box-sizing:border-box}
body {font-family:'JetBrains Mono',monospace;background:#000;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;color:#00ff00}

/* KALKULATOR - bez zmian */
.calc-screen {background:#1e1e1e;padding:40px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:100%;max-width:320px;margin:20px;border:1px solid #2d2d2d}
.calc-display {background:#252525;padding:20px;border-radius:8px;font-size:32px;text-align:right;margin-bottom:20px;min-height:80px;color:#e0e0e0;font-family:monospace;border:1px solid #3a3a3a;overflow:hidden;word-wrap:break-word}
.calc-buttons {display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.calc-btn {background:#374151;color:#e0e0e0;border:none;padding:20px;border-radius:8px;font-size:20px;cursor:pointer;transition:all 0.2s;font-weight:600;border:1px solid #4b5563}
.calc-btn:hover {background:#4b5563;transform:scale(1.05)}
.calc-btn:active {transform:scale(0.95)}
.calc-btn.operator {background:#2563eb;color:#fff}
.calc-btn.operator:hover {background:#3b82f6}
.calc-btn.equals {background:#10b981;color:#fff}
.calc-btn.equals:hover {background:#14c992}
.calc-btn.clear {background:#ef4444;color:#fff}
.calc-btn.clear:hover {background:#f87171}
.calc-message {background:rgba(16,185,129,0.1);border:1px solid #10b981;padding:12px;border-radius:8px;margin-top:15px;text-align:center;font-size:14px;color:#10b981;animation:fadeIn 0.5s ease}

/* TERMINAL LOGIN */
.terminal-login {background:#000;border:2px solid #00ff00;padding:40px;width:100%;max-width:500px;margin:20px;box-shadow:0 0 30px rgba(0,255,0,0.3);position:relative;overflow:hidden}
.terminal-login::before {content:'';position:absolute;top:0;left:0;right:0;height:30px;background:#00ff00;border-bottom:2px solid #00ff00}
.terminal-header {position:absolute;top:5px;left:15px;color:#000;font-weight:700;font-size:14px;z-index:1}
.terminal-content {margin-top:20px}
.terminal-title {color:#00ff00;font-size:18px;margin-bottom:30px;text-align:center;text-shadow:0 0 10px rgba(0,255,0,0.5);animation:pulse 2s infinite}
.terminal-field {margin-bottom:25px}
.terminal-label {color:#00ff00;font-size:12px;margin-bottom:8px;display:block;opacity:0.8}
.terminal-input {width:100%;background:#000;border:1px solid #00ff00;color:#00ff00;padding:12px;font-family:'JetBrains Mono',monospace;font-size:14px;outline:none;transition:all 0.3s}
.terminal-input:focus {box-shadow:0 0 15px rgba(0,255,0,0.5);background:rgba(0,255,0,0.05)}
.terminal-input::placeholder {color:rgba(0,255,0,0.3)}
.terminal-btn {width:100%;background:#000;border:2px solid #00ff00;color:#00ff00;padding:14px;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;margin-top:10px;text-transform:uppercase;letter-spacing:2px}
.terminal-btn:hover {background:#00ff00;color:#000;box-shadow:0 0 20px rgba(0,255,0,0.5)}
.terminal-btn:active {transform:scale(0.98)}
.terminal-btn:disabled {opacity:0.5;cursor:not-allowed}
.terminal-message {margin-top:20px;padding:12px;font-size:12px;text-align:center;border:1px solid;animation:fadeIn 0.5s}
.terminal-error {color:#ff0000;border-color:#ff0000;background:rgba(255,0,0,0.1)}
.terminal-success {color:#00ff00;border-color:#00ff00;background:rgba(0,255,0,0.1)}
.terminal-status {text-align:center;margin-top:20px;font-size:11px;color:#00ff00;opacity:0.6}
.terminal-cursor {animation:blink 1s infinite}

/* MAIN CHAT APP */
.chat-container {background:#0a0a0a;width:100%;max-width:1200px;height:100vh;display:flex;border:1px solid #1a1a1a;font-family:'JetBrains Mono',monospace}
.sidebar {width:280px;background:#050505;border-right:1px solid #1a1a1a;display:flex;flex-direction:column;overflow:hidden}
.profile-card {background:#0f0f0f;padding:20px;border-bottom:1px solid #1a1a1a;text-align:center}
.profile-email {color:#00ff00;font-size:13px;margin-bottom:10px;word-break:break-all}
.logout-btn {background:#000;border:1px solid #ff0000;color:#ff0000;padding:10px 20px;font-size:12px;cursor:pointer;transition:all 0.3s;width:100%;margin-top:10px;font-family:'JetBrains Mono',monospace}
.logout-btn:hover {background:#ff0000;color:#000}
.color-picker {margin-top:15px}
.color-label {color:#666;font-size:11px;margin-bottom:8px;display:block}
.color-options {display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.color-btn {width:35px;height:35px;border:2px solid transparent;cursor:pointer;transition:all 0.2s;position:relative}
.color-btn:hover {transform:scale(1.1);border-color:#fff}
.color-btn.selected {border-color:#fff;box-shadow:0 0 10px currentColor}
.color-btn.selected::after {content:'‚úì';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-weight:bold}
.users-container {flex:1;overflow-y:auto;padding:10px}
.user-group {margin-bottom:20px}
.user-group-header {color:#666;font-size:11px;text-transform:uppercase;letter-spacing:1px;padding:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s}
.user-group-header:hover {background:#0f0f0f}
.user-count {background:#1a1a1a;color:#fff;padding:2px 8px;border-radius:10px;font-size:10px}
.user-item {padding:12px;margin:4px 0;background:#0f0f0f;border:1px solid #1a1a1a;cursor:pointer;transition:all 0.2s;position:relative}
.user-item:hover {background:#141414;border-color:#333}
.user-item.active {background:#00ff00;border-color:#00ff00}
.user-item.active .user-name {color:#000}
.user-item.active .user-status {color:#000}
.user-name {color:#fff;font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.user-status {color:#666;font-size:11px;margin-top:4px;display:flex;align-items:center}
.status-dot {width:8px;height:8px;border-radius:50%;margin-right:8px;display:inline-block}
.status-dot.online {background:#00ff00;box-shadow:0 0 5px #00ff00}
.status-dot.offline {background:#666}
.unread-badge {background:#ff0000;color:#fff;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:bold}

.chat-main {flex:1;display:flex;flex-direction:column;background:#000}
.chat-header {background:#0a0a0a;padding:20px;border-bottom:1px solid #1a1a1a;display:flex;justify-content:space-between;align-items:center}
.chat-title {color:#fff;font-size:16px;font-weight:600}
.chat-subtitle {color:#666;font-size:11px;margin-top:4px}
.messages-container {flex:1;overflow-y:auto;padding:20px;background:#000}
.message {margin:15px 0;display:flex;animation:messageIn 0.3s ease}
.message.own {justify-content:flex-end}
.message-bubble {max-width:70%;padding:12px 16px;border-radius:12px;position:relative;word-wrap:break-word}
.message.own .message-bubble {background:var(--user-color, #00ff00);color:#000}
.message.other .message-bubble {background:#1a1a1a;color:#fff;border:1px solid #2a2a2a}
.message-header {font-size:10px;opacity:0.7;margin-bottom:6px;font-weight:600}
.message-text {font-size:13px;line-height:1.5}
.message-time {font-size:9px;opacity:0.6;margin-top:4px}
.message-image {max-width:100%;border-radius:8px;cursor:pointer;margin-top:8px}
.delete-btn {position:absolute;top:-8px;right:-8px;background:#ff0000;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px;opacity:0;transition:all 0.2s}
.message:hover .delete-btn {opacity:1}

.input-container {background:#0a0a0a;padding:20px;border-top:1px solid #1a1a1a}
.input-wrapper {display:flex;gap:10px;align-items:center}
.message-input {flex:1;background:#000;border:1px solid #1a1a1a;color:#fff;padding:12px;font-family:'JetBrains Mono',monospace;font-size:13px;outline:none;transition:all 0.3s}
.message-input:focus {border-color:#00ff00;box-shadow:0 0 10px rgba(0,255,0,0.2)}
.action-btn {background:#000;border:1px solid #333;color:#fff;padding:10px;cursor:pointer;transition:all 0.3s;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:16px}
.action-btn:hover {border-color:#00ff00;color:#00ff00}
.send-btn {background:#00ff00;border:1px solid #00ff00;color:#000}
.send-btn:hover {background:#00ff00;box-shadow:0 0 15px rgba(0,255,0,0.5)}

.emoji-picker {position:absolute;bottom:60px;right:20px;background:#0a0a0a;border:1px solid #1a1a1a;padding:10px;box-shadow:0 -5px 20px rgba(0,0,0,0.5);z-index:1000}
.emoji-grid {display:grid;grid-template-columns:repeat(6,1fr);gap:5px}
.emoji-btn {background:#000;border:1px solid #1a1a1a;color:#00ff00;padding:8px;cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace}
.emoji-btn:hover {background:#00ff00;color:#000}

.empty-state {text-align:center;color:#666;padding:40px;font-style:italic;font-size:12px}

.p {display:none!important}

/* ANIMATIONS */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes messageIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* SCROLLBAR */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:#000}
::-webkit-scrollbar-thumb{background:#1a1a1a;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#2a2a2a}

/* MOBILE */
@media(max-width:768px){
  .chat-container{flex-direction:column;height:100vh;max-width:100%}
  .sidebar{width:100%;height:40%;border-right:none;border-bottom:1px solid #1a1a1a}
  .input-container{position:fixed;bottom:0;left:0;right:0;z-index:999}
  .messages-container{padding-bottom:100px}
  .message-bubble{max-width:85%}
}
</style>
</head>
<body>

<!-- KALKULATOR -->
<div class="calc-screen" id="calcScreen">
  <h2 class="s" style="text-align:center;margin-bottom:20px;color:#e0e0e0">üìä Kalkulator</h2>
  <div class="calc-display" id="calcDisplay">0</div>
  <div class="calc-buttons">
    <button class="calc-btn" onclick="appendCalc('7')">7</button>
    <button class="calc-btn" onclick="appendCalc('8')">8</button>
    <button class="calc-btn" onclick="appendCalc('9')">9</button>
    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
    <button class="calc-btn" onclick="appendCalc('4')">4</button>
    <button class="calc-btn" onclick="appendCalc('5')">5</button>
    <button class="calc-btn" onclick="appendCalc('6')">6</button>
    <button class="calc-btn operator" onclick="appendCalc('-')">-</button>
    <button class="calc-btn" onclick="appendCalc('1')">1</button>
    <button class="calc-btn" onclick="appendCalc('2')">2</button>
    <button class="calc-btn" onclick="appendCalc('3')">3</button>
    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
    <button class="calc-btn clear" onclick="clearCalc()">C</button>
    <button class="calc-btn" onclick="appendCalc('0')">0</button>
    <button class="calc-btn equals" onclick="calculateCalc()">=</button>
    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
  </div>
  <div id="calcMessage"></div>
</div>

<!-- TERMINAL LOGIN -->
<div class="terminal-login p" id="lf">
  <div class="terminal-header">SYSTEM LOGIN v2.0</div>
  <div class="terminal-content">
    <div class="terminal-title">
      <span class="terminal-cursor">&gt;</span> SECURE_CHAT_SYSTEM
    </div>
    
    <div class="terminal-field">
      <label class="terminal-label">[USER@SYSTEM]$ Enter email:</label>
      <input type="email" class="terminal-input" id="em" placeholder="user@domain.com" autocomplete="email">
    </div>
    
    <div class="terminal-field">
      <label class="terminal-label">[USER@SYSTEM]$ Enter password:</label>
      <input type="password" class="terminal-input" id="pw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    
    <button class="terminal-btn" id="loginBtn" onclick="lg()">[LOGIN]</button>
    <button class="terminal-btn" id="registerBtn" onclick="rg()" style="border-color:#0088ff;color:#0088ff">[CREATE_ACCOUNT]</button>
    
    <div id="am"></div>
    
    <div class="terminal-status">
      STATUS: <span id="firebaseStatus" style="color:#ff0000">CONNECTING...</span>
    </div>
  </div>
</div>

<!-- MAIN CHAT -->
<div class="chat-container p" id="ma">
  <div class="sidebar">
    <div class="profile-card">
      <div class="profile-email" id="up"></div>
      <button class="logout-btn" onclick="lo()">[LOGOUT]</button>
      
      <div class="color-picker">
        <label class="color-label">Message color:</label>
        <div class="color-options">
          <div class="color-btn selected" style="background:#00ff00" onclick="setMessageColor('#00ff00')"></div>
          <div class="color-btn" style="background:#ff0066" onclick="setMessageColor('#ff0066')"></div>
          <div class="color-btn" style="background:#00ffff" onclick="setMessageColor('#00ffff')"></div>
          <div class="color-btn" style="background:#ffff00" onclick="setMessageColor('#ffff00')"></div>
          <div class="color-btn" style="background:#ff00ff" onclick="setMessageColor('#ff00ff')"></div>
          <div class="color-btn" style="background:#ff8800" onclick="setMessageColor('#ff8800')"></div>
          <div class="color-btn" style="background:#8800ff" onclick="setMessageColor('#8800ff')"></div>
          <div class="color-btn" style="background:#00ff88" onclick="setMessageColor('#00ff88')"></div>
          <div class="color-btn" style="background:#ffffff" onclick="setMessageColor('#ffffff')"></div>
          <div class="color-btn" style="background:#88ff00" onclick="setMessageColor('#88ff00')"></div>
        </div>
      </div>
    </div>
    
    <div class="users-container">
      <div class="user-group">
        <div class="user-group-header" onclick="toggleUserSection('online')">
          <span>ONLINE</span>
          <span class="user-count" id="onlineCount">0</span>
        </div>
        <div id="ulOnline"></div>
      </div>
      
      <div class="user-group">
        <div class="user-group-header" onclick="toggleUserSection('offline')">
          <span>OFFLINE</span>
          <span class="user-count" id="offlineCount">0</span>
        </div>
        <div id="ulOffline"></div>
      </div>
    </div>
  </div>
  
  <div class="chat-main">
    <div class="chat-header">
      <div>
        <div class="chat-title" id="ct">Select user</div>
        <div class="chat-subtitle" id="cs"></div>
      </div>
    </div>
    
    <div class="messages-container" id="ms">
      <div class="empty-state">&gt; Select user to start messaging...</div>
    </div>
    
    <div class="input-container p" id="mis">
      <div class="input-wrapper">
        <input type="text" class="message-input" id="mi" placeholder="Type message..." autocomplete="off">
        <button class="action-btn" onclick="toggleEmoji()">:)</button>
        <button class="action-btn" onclick="document.getElementById('fi').click()">üìé</button>
        <button class="action-btn send-btn" onclick="sm()">‚Üí</button>
        <input type="file" id="fi" accept="image/*" style="display:none" onchange="hu(this)">
      </div>
      
      <div class="emoji-picker p" id="ep">
        <div class="emoji-grid" id="eg"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig={
  apiKey:"AIzaSyCJeQEnsEDDnGvKoVzKkjRmnOIsmv7HPJs",
  authDomain:"pensei-b3058.firebaseapp.com",
  projectId:"pensei-b3058",
  storageBucket:"pensei-b3058.firebasestorage.app",
  messagingSenderId:"341036858535",
  appId:"1:341036858535:web:43d4f98625abd9ff406f82",
  measurementId:"G-MR8G2GNY5P"
};

// Tekstowe emotikony
const textEmojis = [':)', ':(', ':D', ':P', ':o', ':|', ';)', ':*', '<3', '</3', ':/', '^^', 'o_O', 'T_T', 'xD', '-_-', ':3', '>:)', '8)', 'B)', ':S', '¬Ø\\_(„ÉÑ)_/¬Ø', '(‚ïØ¬∞‚ñ°¬∞)‚ïØÔ∏µ ‚îª‚îÅ‚îª', '‚î¨‚îÄ‚î¨„Éé( ¬∫ _ ¬∫„Éé)'];

let userMessageColor = '#00ff00';

window.setMessageColor = function(color) {
  userMessageColor = color;
  localStorage.setItem('userMessageColor', color);
  document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.classList.add('selected');
  document.documentElement.style.setProperty('--user-color', color);
};

// Wczytaj zapisany kolor
const savedColor = localStorage.getItem('userMessageColor');
if(savedColor) {
  userMessageColor = savedColor;
  document.documentElement.style.setProperty('--user-color', savedColor);
}

let calcExpression='';
let calcDisplay=null;

window.appendCalc = function(value){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  if(calcExpression==='0'||calcExpression==='')calcExpression='';
  calcExpression+=value;
  calcDisplay.textContent=calcExpression;
};

window.clearCalc = function(){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  calcExpression='';
  calcDisplay.textContent='0';
  const msg=document.getElementById('calcMessage');
  if(msg)msg.innerHTML='';
};

window.calculateCalc = function(){
  if(!calcDisplay)calcDisplay=document.getElementById('calcDisplay');
  try{
    const result=eval(calcExpression);
    calcDisplay.textContent=result;
    
    if(calcExpression==='1488+2137'||calcExpression==='2137+1488'){
      const msg=document.getElementById('calcMessage');
      msg.innerHTML='<div class="calc-message">üéâ Access granted! Redirecting... üéâ</div>';
      
      setTimeout(function(){
        document.getElementById('calcScreen').classList.add('p');
        document.getElementById('lf').classList.remove('p');
      },2000);
    }
    
    calcExpression=result.toString();
  }catch(e){
    calcDisplay.textContent='Error';
    calcExpression='';
  }
};

window.toggleUserSection = function(section){
  // Funkcja toggle dla sekcji u≈ºytkownik√≥w
};

let a, d;

try {
  firebase.initializeApp(firebaseConfig);
  a = firebase.auth();
  d = firebase.firestore();
  
  a.setPersistence(firebase.auth.Auth.Persistence.NONE);
  
  if(a.currentUser){
    a.signOut();
  }
  
  const statusEl = document.getElementById('firebaseStatus');
  if(statusEl) {
    statusEl.innerHTML = 'CONNECTED';
    statusEl.style.color = '#00ff00';
  }
} catch(err) {
  const statusEl = document.getElementById('firebaseStatus');
  if(statusEl) {
    statusEl.innerHTML = 'ERROR';
    statusEl.style.color = '#ff0000';
  }
}

let cu=null,sc=null,um=null,ht=null,es=false,unread={};

function escapeHtml(text){
  const div=document.createElement('div');
  div.textContent=text;
  return div.innerHTML;
}

window.toggleEmoji = function(){
  const ep=document.getElementById('ep');
  if(!ep)return;
  if(es){ep.classList.add('p');es=false}else{
    const eg=document.getElementById('eg');
    if(!eg.innerHTML)initEmojis();
    ep.classList.remove('p');
    es=true;
  }
};

function initEmojis(){
  const eg=document.getElementById('eg');
  if(!eg)return;
  eg.innerHTML='';
  textEmojis.forEach(function(emoji){
    const btn=document.createElement('button');
    btn.className='emoji-btn';
    btn.textContent=emoji;
    btn.onclick=function(e){
      e.stopPropagation();
      addEmoji(emoji);
    };
    eg.appendChild(btn);
  });
}

function addEmoji(emoji){
  const mi=document.getElementById('mi');
  if(!mi)return;
  mi.value+=' '+emoji+' ';
  mi.focus();
  const ep=document.getElementById('ep');
  if(ep)ep.classList.add('p');
  es=false;
}

function sam(m,ie){
  const dv=document.getElementById('am');
  dv.innerHTML=ie?
    '<div class="terminal-message terminal-error">ERROR: '+escapeHtml(m)+'</div>':
    '<div class="terminal-message terminal-success">SUCCESS: '+escapeHtml(m)+'</div>';
  setTimeout(function(){dv.innerHTML=''},4000);
}

window.lg = async function(){
  const e=document.getElementById('em').value.trim();
  const p=document.getElementById('pw').value;
  const loginBtn=document.getElementById('loginBtn');
  
  if(!e||!p){
    sam('All fields required',true);
    return;
  }
  
  loginBtn.disabled=true;
  loginBtn.textContent='[AUTHENTICATING...]';
  
  try{
    await a.signInWithEmailAndPassword(e,p);
    sam('Login successful');
  }catch(er){
    let msg='Authentication failed';
    if(er.code==='auth/user-not-found')msg='User not found';
    else if(er.code==='auth/wrong-password')msg='Invalid password';
    else if(er.code==='auth/invalid-email')msg='Invalid email format';
    sam(msg,true);
  }finally{
    loginBtn.disabled=false;
    loginBtn.textContent='[LOGIN]';
  }
};

window.rg = async function(){
  const e=document.getElementById('em').value.trim();
  const p=document.getElementById('pw').value;
  const regBtn=document.getElementById('registerBtn');
  
  if(!e||!p){
    sam('All fields required',true);
    return;
  }
  
  if(p.length<6){
    sam('Password min 6 chars',true);
    return;
  }
  
  regBtn.disabled=true;
  regBtn.textContent='[CREATING...]';
  
  try{
    await a.createUserWithEmailAndPassword(e,p);
    sam('Account created');
  }catch(er){
    let msg='Registration failed';
    if(er.code==='auth/email-already-in-use')msg='Email already exists';
    else if(er.code==='auth/weak-password')msg='Password too weak';
    sam(msg,true);
  }finally{
    regBtn.disabled=false;
    regBtn.textContent='[CREATE_ACCOUNT]';
  }
};

window.lo = async function(){
  try{
    if(ht)clearInterval(ht);
    if(um)um();
    await a.signOut();
    cu=null;
    sc=null;
    unread={};
    
    document.getElementById('ma').classList.add('p');
    document.getElementById('lf').classList.add('p');
    document.getElementById('calcScreen').classList.remove('p');
    
    document.getElementById('em').value='';
    document.getElementById('pw').value='';
  }catch(error){}
};

function su(ue,io){
  document.querySelectorAll('.user-item').forEach(function(i){i.classList.remove('active')});
  const userEl=document.querySelector('[data-email="'+ue+'"]');
  if(userEl)userEl.classList.add('active');
  sc=ue;
  unread[ue]=0;
  updateUnreadBadges();
  const un=ue.split('@')[0];
  document.getElementById('ct').textContent=un;
  const cs=document.getElementById('cs');
  cs.innerHTML=io?'<span style="color:#00ff00">‚óè Online</span>':'<span style="color:#666">‚óè Offline</span>';
  document.getElementById('mis').classList.remove('p');
  loadMessages(ue);
}

function updateUnreadBadges(){
  Object.keys(unread).forEach(function(email){
    const userEl=document.querySelector('[data-email="'+email+'"]');
    if(userEl){
      const existingBadge=userEl.querySelector('.unread-badge');
      if(existingBadge)existingBadge.remove();
      
      if(unread[email]>0){
        const nameEl=userEl.querySelector('.user-name');
        if(nameEl){
          const badge=document.createElement('span');
          badge.className='unread-badge';
          badge.textContent=unread[email]>9?'9+':unread[email];
          nameEl.appendChild(badge);
        }
      }
    }
  });
}

async function loadMessages(oue){
  if(um)um();
  const md=document.getElementById('ms');
  md.innerHTML='<div class="empty-state">Loading messages...</div>';
  
  const ci=cci(cu.email,oue);
  const mr=d.collection('messages');
  const q=mr.where('chatId','==',ci).orderBy('timestamp','asc');
  
  um=q.onSnapshot(function(sn){
    md.innerHTML='';
    if(sn.empty){
      md.innerHTML='<div class="empty-state">&gt; No messages yet. Start conversation...</div>';
      return;
    }
    
    sn.forEach(function(doc){
      const dt=doc.data();
      displayMessage(dt,doc.id);
    });
    
    md.scrollTop=md.scrollHeight;
  });
}

function displayMessage(dt,id){
  const md=document.getElementById('ms');
  if(document.querySelector('[data-msg-id="'+id+'"]'))return;
  
  const msgDiv=document.createElement('div');
  msgDiv.className='message '+(dt.sender===cu.email?'own':'other');
  msgDiv.setAttribute('data-msg-id',id);
  
  const bubble=document.createElement('div');
  bubble.className='message-bubble';
  
  if(dt.sender===cu.email && dt.messageColor){
    bubble.style.setProperty('--user-color',dt.messageColor);
  }
  
  const header='<div class="message-header">'+escapeHtml(dt.sender.split('@')[0])+'</div>';
  
  let content='';
  if(dt.image){
    content='<img src="'+dt.image+'" class="message-image" onclick="openImage(\''+dt.image+'\')">';
  }else{
    content='<div class="message-text">'+escapeHtml(dt.text||'')+'</div>';
  }
  
  const time=dt.timestamp?new Date(dt.timestamp.toDate()).toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'}):'';
  const footer='<div class="message-time">'+time+'</div>';
  
  const deleteBtn='<button class="delete-btn" onclick="deleteMessage(\''+id+'\')">√ó</button>';
  
  bubble.innerHTML=header+content+footer+(dt.sender===cu.email?deleteBtn:'');
  msgDiv.appendChild(bubble);
  md.appendChild(msgDiv);
}

window.deleteMessage = async function(id){
  if(confirm('Delete this message?')){
    try{
      await d.collection('messages').doc(id).delete();
    }catch(e){}
  }
};

window.openImage = function(src){
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer';
  const img=document.createElement('img');
  img.src=src;
  img.style.cssText='max-width:90%;max-height:90%;border-radius:8px';
  modal.appendChild(img);
  modal.onclick=function(){modal.remove()};
  document.body.appendChild(modal);
};

function cci(e1,e2){return[e1,e2].sort().join('_');}

window.sm = async function(){
  const mi=document.getElementById('mi');
  const msg=mi.value.trim();
  
  if(!msg)return;
  if(!sc)return;
  
  try{
    const ci=cci(cu.email,sc);
    await d.collection('messages').add({
      chatId:ci,
      sender:cu.email,
      text:msg,
      messageColor:userMessageColor,
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    
    mi.value='';
  }catch(error){}
};

window.hu = async function(input){
  const file=input.files[0];
  if(!file||!sc)return;
  
  const reader=new FileReader();
  reader.onload=async function(e){
    const ci=cci(cu.email,sc);
    await d.collection('messages').add({
      chatId:ci,
      sender:cu.email,
      image:e.target.result,
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
  };
  reader.readAsDataURL(file);
  input.value='';
};

async function setUserOnline(io){
  if(!cu)return;
  try{
    await d.collection('users').doc(cu.uid).set({
      email:cu.email,
      isOnline:io,
      lastSeen:firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }catch(e){}
}

function loadUsers(){
  const ur=d.collection('users');
  ur.onSnapshot(function(sn){
    const onlineUsers=[];
    const offlineUsers=[];
    
    sn.forEach(function(doc){
      const dt=doc.data();
      if(dt.email!==cu.email){
        if(dt.isOnline)onlineUsers.push(dt);
        else offlineUsers.push(dt);
      }
    });
    
    document.getElementById('onlineCount').textContent=onlineUsers.length;
    document.getElementById('offlineCount').textContent=offlineUsers.length;
    
    const ulOnline=document.getElementById('ulOnline');
    ulOnline.innerHTML='';
    onlineUsers.forEach(function(user){
      const div=document.createElement('div');
      div.className='user-item';
      div.setAttribute('data-email',user.email);
      div.onclick=function(){su(user.email,true)};
      const badge=unread[user.email]>0?'<span class="unread-badge">'+(unread[user.email]>9?'9+':unread[user.email])+'</span>':'';
      div.innerHTML='<div class="user-name">'+escapeHtml(user.email.split('@')[0])+badge+'</div><div class="user-status"><span class="status-dot online"></span>Online</div>';
      ulOnline.appendChild(div);
    });
    
    const ulOffline=document.getElementById('ulOffline');
    ulOffline.innerHTML='';
    offlineUsers.forEach(function(user){
      const div=document.createElement('div');
      div.className='user-item';
      div.setAttribute('data-email',user.email);
      div.onclick=function(){su(user.email,false)};
      const badge=unread[user.email]>0?'<span class="unread-badge">'+(unread[user.email]>9?'9+':unread[user.email])+'</span>':'';
      div.innerHTML='<div class="user-name">'+escapeHtml(user.email.split('@')[0])+badge+'</div><div class="user-status"><span class="status-dot offline"></span>Offline</div>';
      ulOffline.appendChild(div);
    });
  });
}

document.getElementById('mi').addEventListener('keypress',function(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sm();}
});

document.addEventListener('click',function(e){
  if(!e.target.closest('.action-btn')&&!e.target.closest('.emoji-picker')){
    const ep=document.getElementById('ep');
    if(ep&&es){ep.classList.add('p');es=false;}
  }
});

a.onAuthStateChanged(async function(u){
  if(u){
    cu=u;
    document.getElementById('calcScreen').classList.add('p');
    document.getElementById('lf').classList.add('p');
    document.getElementById('ma').classList.remove('p');
    document.getElementById('up').textContent=u.email;
    await setUserOnline(true);
    loadUsers();
    ht=setInterval(function(){setUserOnline(true)},30000);
    window.addEventListener('beforeunload',function(){setUserOnline(false)});
  }else{
    cu=null;
    document.getElementById('ma').classList.add('p');
    document.getElementById('lf').classList.add('p');
    document.getElementById('calcScreen').classList.remove('p');
    if(ht){clearInterval(ht);ht=null;}
    if(um){um();um=null;}
  }
});
</script>
</body>
</html>